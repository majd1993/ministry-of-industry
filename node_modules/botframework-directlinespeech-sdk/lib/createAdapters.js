"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = create;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _AudioConfig = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/sdk/Audio/AudioConfig");

var _microsoftCognitiveservicesSpeechSdk = require("microsoft-cognitiveservices-speech-sdk");

var _MicAudioSource = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/MicAudioSource");

var _createWebSpeechPonyfillFactory = _interopRequireDefault(require("./createWebSpeechPonyfillFactory"));

var _DirectLineSpeech = _interopRequireDefault(require("./DirectLineSpeech"));

var _patchDialogServiceConnectorInline = _interopRequireDefault(require("./patchDialogServiceConnectorInline"));

var _refreshDirectLineToken = _interopRequireDefault(require("./utils/refreshDirectLineToken"));

var _resolveFunctionOrReturnValue = _interopRequireDefault(require("./resolveFunctionOrReturnValue"));

/* eslint complexity: ["error", 33] */
var DIRECT_LINE_TOKEN_RENEWAL_INTERVAL = 900000; // 15 minutes

var TOKEN_RENEWAL_INTERVAL = 120000;

function create(_x) {
  return _create.apply(this, arguments);
}

function _create() {
  _create = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(_ref) {
    var audioConfig, audioContext, audioInputDeviceId, enableInternalHTTPSupport, enableTelemetry, fetchCredentials, speechRecognitionEndpointId, _ref$speechRecognitio, speechRecognitionLanguage, speechSynthesisDeploymentId, speechSynthesisOutputFormat, textNormalization, userID, username, _yield$resolveFunctio, authorizationToken, directLineToken, region, subscriptionKey, _audioConfig, source, config, dialogServiceConnector, interval, _interval, directLine, webSpeechPonyfillFactory;

    return _regenerator.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            audioConfig = _ref.audioConfig, audioContext = _ref.audioContext, audioInputDeviceId = _ref.audioInputDeviceId, enableInternalHTTPSupport = _ref.enableInternalHTTPSupport, enableTelemetry = _ref.enableTelemetry, fetchCredentials = _ref.fetchCredentials, speechRecognitionEndpointId = _ref.speechRecognitionEndpointId, _ref$speechRecognitio = _ref.speechRecognitionLanguage, speechRecognitionLanguage = _ref$speechRecognitio === void 0 ? typeof window !== 'undefined' && typeof window.navigator !== 'undefined' && window.navigator.language || 'en-US' : _ref$speechRecognitio, speechSynthesisDeploymentId = _ref.speechSynthesisDeploymentId, speechSynthesisOutputFormat = _ref.speechSynthesisOutputFormat, textNormalization = _ref.textNormalization, userID = _ref.userID, username = _ref.username;

            if (fetchCredentials) {
              _context3.next = 3;
              break;
            }

            throw new Error('"fetchCredentials" must be specified.');

          case 3:
            _context3.next = 5;
            return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

          case 5:
            _yield$resolveFunctio = _context3.sent;
            authorizationToken = _yield$resolveFunctio.authorizationToken;
            directLineToken = _yield$resolveFunctio.directLineToken;
            region = _yield$resolveFunctio.region;
            subscriptionKey = _yield$resolveFunctio.subscriptionKey;

            if (!(!authorizationToken && !subscriptionKey || authorizationToken && subscriptionKey || authorizationToken && typeof authorizationToken !== 'string' || subscriptionKey && typeof subscriptionKey !== 'string' || enableInternalHTTPSupport && !directLineToken)) {
              _context3.next = 12;
              break;
            }

            throw new Error('"fetchCredentials" must return either "authorizationToken" or "subscriptionKey" as a non-empty string only. If enableInternalHTTPSupport is set to true, then it should also return a non-empty "directLineToken"');

          case 12:
            if (typeof enableTelemetry !== 'undefined') {
              console.warn('botframework-directlinespeech: Telemetry options are not yet supported. Please refer to Cognitive Services documentation for details.');
            }

            if (!(!region || typeof region !== 'string')) {
              _context3.next = 15;
              break;
            }

            throw new Error('"fetchCredentials" must return "region" as a non-empty string.');

          case 15:
            if (audioConfig && audioInputDeviceId) {
              console.warn('botframework-directlinespeech-sdk: Only "audioConfig" or "audioInputDeviceId" can be specified, but not both; ignoring "audioInputDeviceId".');
            } else if (!audioConfig) {
              if (audioInputDeviceId) {
                audioConfig = _AudioConfig.AudioConfig.fromMicrophoneInput(audioInputDeviceId);
              } else {
                audioConfig = _AudioConfig.AudioConfig.fromDefaultMicrophoneInput();
              } // WORKAROUND: In Speech SDK 1.12.0-1.13.1, it dropped support of macOS/iOS Safari.
              //             This code is adopted from microsoft-cognitiveservices-speech-sdk/src/common.browser/MicAudioSource.ts.
              //             We will not need this code when using Speech SDK 1.14.0 or up.
              // TODO: [P1] #3575 Remove the following lines when bumping to Speech SDK 1.14.0 or higher


              _audioConfig = audioConfig, source = _audioConfig.privSource;

              source.createAudioContext = function () {
                if (!!source.privContext) {
                  return;
                }

                var AudioContext = window.AudioContext || window.webkitAudioContext;

                if (typeof AudioContext === 'undefined') {
                  throw new Error('Browser does not support Web Audio API (AudioContext/webkitAudioContext is not available).');
                }

                if (navigator.mediaDevices.getSupportedConstraints().sampleRate) {
                  source.privContext = new AudioContext({
                    sampleRate: _MicAudioSource.MicAudioSource.AUDIOFORMAT.samplesPerSec
                  });
                } else {
                  source.privContext = new AudioContext();
                }
              };
            }

            if (speechRecognitionEndpointId) {
              console.warn('botframework-directlinespeech: Custom Speech is currently not supported; ignoring "speechRecognitionEndpointId".');
            }

            if (speechSynthesisDeploymentId) {
              console.warn('botframework-directlinespeech: Custom Voice is currently not supported; ignoring "speechSynthesisDeploymentId".');
            }

            if (speechSynthesisOutputFormat) {
              console.warn('botframework-directlinespeech: Synthesis output format is currently not supported; ignoring "speechSynthesisOutputFormat".');
            }

            if (textNormalization) {
              console.warn('botframework-directlinespeech: Text normalization is currently not supported; ignoring "textNormalization".');
            }

            if (userID || username) {
              console.warn('botframework-directlinespeech: Custom "userId" and "username" are currently not supported and are ignored.');
            }

            if (authorizationToken) {
              config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromAuthorizationToken(authorizationToken, region);
            } else {
              config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromSubscription(subscriptionKey, region);
            } // If internal HTTP support is enabled, switch the endpoint to Direct Line on Direct Line Speech service.


            if (enableInternalHTTPSupport) {
              config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_Endpoint, "wss://".concat(encodeURI(region), ".convai.speech.microsoft.com/directline/api/v1"));
              config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, directLineToken);
            } // Supported options can be found in DialogConnectorFactory.js.
            // Set the language used for recognition.


            config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_RecoLanguage, speechRecognitionLanguage); // The following code sets the output format.
            // As advised by the Speech team, this API may be subject to future changes.
            // We are not enabling output format option because it does not send detailed output format to the bot, rendering this option useless.
            // config.setProperty(PropertyId.SpeechServiceResponse_OutputFormatOption, OutputFormat[OutputFormat.Detailed]);
            // Set the user ID for starting the conversation.

            userID && config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_From_Id, userID); // Set Custom Speech and Custom Voice.
            // The following code is copied from C#, and it is not working yet.
            // https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/MainWindow.xaml.cs
            // speechRecognitionEndpointId && config.setServiceProperty('cid', speechRecognitionEndpointId, ServicePropertyChannel.UriQueryParameter);
            // speechSynthesisDeploymentId && config.setProperty(PropertyId.conversation_Custom_Voice_Deployment_Ids, speechSynthesisDeploymentId);

            dialogServiceConnector = (0, _patchDialogServiceConnectorInline.default)(new _microsoftCognitiveservicesSpeechSdk.DialogServiceConnector(config, audioConfig));
            dialogServiceConnector.connect(); // Renew token per interval.

            if (authorizationToken) {
              interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
                var _yield$resolveFunctio2, authorizationToken, nextRegion;

                return _regenerator.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(interval);
                        }

                        _context.next = 3;
                        return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

                      case 3:
                        _yield$resolveFunctio2 = _context.sent;
                        authorizationToken = _yield$resolveFunctio2.authorizationToken;
                        nextRegion = _yield$resolveFunctio2.region;

                        if (authorizationToken) {
                          _context.next = 8;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because "fetchCredentials" call returned no authorization token.'));

                      case 8:
                        if (!(region !== nextRegion)) {
                          _context.next = 10;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Region change is not supported for renewed token. Authorization token is not renewed.'));

                      case 10:
                        dialogServiceConnector.authorizationToken = authorizationToken; // eslint-disable-line require-atomic-updates

                      case 11:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee);
              })), TOKEN_RENEWAL_INTERVAL);
            } // Renew token per interval.


            if (enableInternalHTTPSupport) {
              _interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2() {
                var refreshedDirectLineToken;
                return _regenerator.default.wrap(function _callee2$(_context2) {
                  while (1) {
                    switch (_context2.prev = _context2.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(_interval);
                        }

                        _context2.next = 3;
                        return (0, _refreshDirectLineToken.default)(directLineToken);

                      case 3:
                        refreshedDirectLineToken = _context2.sent;

                        if (refreshedDirectLineToken) {
                          _context2.next = 6;
                          break;
                        }

                        return _context2.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because call to refresh token Direct Line API did not return a new token.'));

                      case 6:
                        config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, refreshedDirectLineToken);
                        dialogServiceConnector.properties.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, refreshedDirectLineToken);
                        dialogServiceConnector.connect();

                      case 9:
                      case "end":
                        return _context2.stop();
                    }
                  }
                }, _callee2);
              })), DIRECT_LINE_TOKEN_RENEWAL_INTERVAL);
            }

            directLine = new _DirectLineSpeech.default({
              dialogServiceConnector: dialogServiceConnector
            });
            webSpeechPonyfillFactory = (0, _createWebSpeechPonyfillFactory.default)({
              audioContext: audioContext,
              enableTelemetry: enableTelemetry,
              recognizer: dialogServiceConnector,
              textNormalization: textNormalization
            });
            return _context3.abrupt("return", {
              directLine: directLine,
              webSpeechPonyfillFactory: webSpeechPonyfillFactory
            });

          case 32:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));
  return _create.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVBZGFwdGVycy5qcyJdLCJuYW1lcyI6WyJESVJFQ1RfTElORV9UT0tFTl9SRU5FV0FMX0lOVEVSVkFMIiwiVE9LRU5fUkVORVdBTF9JTlRFUlZBTCIsImNyZWF0ZSIsImF1ZGlvQ29uZmlnIiwiYXVkaW9Db250ZXh0IiwiYXVkaW9JbnB1dERldmljZUlkIiwiZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCIsImVuYWJsZVRlbGVtZXRyeSIsImZldGNoQ3JlZGVudGlhbHMiLCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQiLCJzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlIiwid2luZG93IiwibmF2aWdhdG9yIiwibGFuZ3VhZ2UiLCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQiLCJzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQiLCJ0ZXh0Tm9ybWFsaXphdGlvbiIsInVzZXJJRCIsInVzZXJuYW1lIiwiRXJyb3IiLCJhdXRob3JpemF0aW9uVG9rZW4iLCJkaXJlY3RMaW5lVG9rZW4iLCJyZWdpb24iLCJzdWJzY3JpcHRpb25LZXkiLCJjb25zb2xlIiwid2FybiIsIkF1ZGlvQ29uZmlnIiwiZnJvbU1pY3JvcGhvbmVJbnB1dCIsImZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0Iiwic291cmNlIiwicHJpdlNvdXJjZSIsImNyZWF0ZUF1ZGlvQ29udGV4dCIsInByaXZDb250ZXh0IiwiQXVkaW9Db250ZXh0Iiwid2Via2l0QXVkaW9Db250ZXh0IiwibWVkaWFEZXZpY2VzIiwiZ2V0U3VwcG9ydGVkQ29uc3RyYWludHMiLCJzYW1wbGVSYXRlIiwiTWljQXVkaW9Tb3VyY2UiLCJBVURJT0ZPUk1BVCIsInNhbXBsZXNQZXJTZWMiLCJjb25maWciLCJCb3RGcmFtZXdvcmtDb25maWciLCJmcm9tQXV0aG9yaXphdGlvblRva2VuIiwiZnJvbVN1YnNjcmlwdGlvbiIsInNldFByb3BlcnR5IiwiUHJvcGVydHlJZCIsIlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0VuZHBvaW50IiwiZW5jb2RlVVJJIiwiQ29udmVyc2F0aW9uX0FwcGxpY2F0aW9uSWQiLCJTcGVlY2hTZXJ2aWNlQ29ubmVjdGlvbl9SZWNvTGFuZ3VhZ2UiLCJDb252ZXJzYXRpb25fRnJvbV9JZCIsImRpYWxvZ1NlcnZpY2VDb25uZWN0b3IiLCJEaWFsb2dTZXJ2aWNlQ29ubmVjdG9yIiwiY29ubmVjdCIsImludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJwcml2SXNEaXNwb3NlZCIsImNsZWFySW50ZXJ2YWwiLCJuZXh0UmVnaW9uIiwicmVmcmVzaGVkRGlyZWN0TGluZVRva2VuIiwicHJvcGVydGllcyIsImRpcmVjdExpbmUiLCJEaXJlY3RMaW5lU3BlZWNoIiwid2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5IiwicmVjb2duaXplciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQVZBO0FBWUEsSUFBTUEsa0NBQWtDLEdBQUcsTUFBM0MsQyxDQUFtRDs7QUFDbkQsSUFBTUMsc0JBQXNCLEdBQUcsTUFBL0I7O1NBRThCQyxNOzs7OztvRkFBZjtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQ2JDLFlBQUFBLFdBRGEsUUFDYkEsV0FEYSxFQUViQyxZQUZhLFFBRWJBLFlBRmEsRUFHYkMsa0JBSGEsUUFHYkEsa0JBSGEsRUFJYkMseUJBSmEsUUFJYkEseUJBSmEsRUFLYkMsZUFMYSxRQUtiQSxlQUxhLEVBTWJDLGdCQU5hLFFBTWJBLGdCQU5hLEVBT2JDLDJCQVBhLFFBT2JBLDJCQVBhLCtCQVFiQyx5QkFSYSxFQVFiQSx5QkFSYSxzQ0FRZ0IsT0FBT0MsTUFBUCxLQUFrQixXQUFsQixJQUMzQixPQUFPQSxNQUFNLENBQUNDLFNBQWQsS0FBNEIsV0FERCxJQUUzQkQsTUFBTSxDQUFDQyxTQUFQLENBQWlCQyxRQUZTLElBRzFCLE9BWFcsMEJBWWJDLDJCQVphLFFBWWJBLDJCQVphLEVBYWJD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Q0FBdUJsQyxlQUF2QixDQVJaOztBQUFBO0FBUXJCdUMsd0JBQUFBLHdCQVJxQjs7QUFBQSw0QkFVdEJBLHdCQVZzQjtBQUFBO0FBQUE7QUFBQTs7QUFBQSwwREFXbEJwQyxPQUFPLENBQUNDLElBQVIsQ0FDTCxpSUFESyxDQVhrQjs7QUFBQTtBQWdCM0JnQix3QkFBQUEsTUFBTSxDQUFDSSxXQUFQLENBQW1CQyxnREFBV0csMEJBQTlCLEVBQTBEVyx3QkFBMUQ7QUFFQVIsd0JBQUFBLHNCQUFzQixDQUFDUyxVQUF2QixDQUFrQ2hCLFdBQWxDLENBQThDQyxnREFBV0csMEJBQXpELEVBQXFGVyx3QkFBckY7QUFDQVIsd0JBQUFBLHNCQUFzQixDQUFDRSxPQUF2Qjs7QUFuQjJCO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGVBQUQsSUFvQnpCdEQsa0NBcEJ5QixDQURDO0FBc0I5Qjs7QUFFSzhELFlBQUFBLFVBaE5PLEdBZ05NLElBQUlDLHlCQUFKLENBQXFCO0FBQUVYLGNBQUFBLHNCQUFzQixFQUF0QkE7QUFBRixhQUFyQixDQWhOTjtBQWtOUFksWUFBQUEsd0JBbE5PLEdBa05vQiw2Q0FBK0I7QUFDOUQ1RCxjQUFBQSxZQUFZLEVBQVpBLFlBRDhEO0FBRTlERyxjQUFBQSxlQUFlLEVBQWZBLGVBRjhEO0FBRzlEMEQsY0FBQUEsVUFBVSxFQUFFYixzQkFIa0Q7QUFJOURwQyxjQUFBQSxpQkFBaUIsRUFBakJBO0FBSjhELGFBQS9CLENBbE5wQjtBQUFBLDhDQXlOTjtBQUNMOEMsY0FBQUEsVUFBVSxFQUFWQSxVQURLO0FBRUxFLGNBQUFBLHdCQUF3QixFQUF4QkE7QUFGSyxhQXpOTTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHIiwic291cmNlUm9vdCI6ImRpcmVjdGxpbmVzcGVlY2g6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IGNvbXBsZXhpdHk6IFtcImVycm9yXCIsIDMzXSAqL1xuXG5pbXBvcnQgeyBBdWRpb0NvbmZpZyB9IGZyb20gJ21pY3Jvc29mdC1jb2duaXRpdmVzZXJ2aWNlcy1zcGVlY2gtc2RrL2Rpc3RyaWIvbGliL3NyYy9zZGsvQXVkaW8vQXVkaW9Db25maWcnO1xuaW1wb3J0IHsgQm90RnJhbWV3b3JrQ29uZmlnLCBEaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLCBQcm9wZXJ0eUlkIH0gZnJvbSAnbWljcm9zb2Z0LWNvZ25pdGl2ZXNlcnZpY2VzLXNwZWVjaC1zZGsnO1xuaW1wb3J0IHsgTWljQXVkaW9Tb3VyY2UgfSBmcm9tICdtaWNyb3NvZnQtY29nbml0aXZlc2VydmljZXMtc3BlZWNoLXNkay9kaXN0cmliL2xpYi9zcmMvY29tbW9uLmJyb3dzZXIvTWljQXVkaW9Tb3VyY2UnO1xuXG5pbXBvcnQgY3JlYXRlV2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5IGZyb20gJy4vY3JlYXRlV2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5JztcbmltcG9ydCBEaXJlY3RMaW5lU3BlZWNoIGZyb20gJy4vRGlyZWN0TGluZVNwZWVjaCc7XG5pbXBvcnQgcGF0Y2hEaWFsb2dTZXJ2aWNlQ29ubmVjdG9ySW5saW5lIGZyb20gJy4vcGF0Y2hEaWFsb2dTZXJ2aWNlQ29ubmVjdG9ySW5saW5lJztcbmltcG9ydCByZWZyZXNoRGlyZWN0TGluZVRva2VuIGZyb20gJy4vdXRpbHMvcmVmcmVzaERpcmVjdExpbmVUb2tlbic7XG5pbXBvcnQgcmVzb2x2ZUZ1bmN0aW9uT3JSZXR1cm5WYWx1ZSBmcm9tICcuL3Jlc29sdmVGdW5jdGlvbk9yUmV0dXJuVmFsdWUnO1xuXG5jb25zdCBESVJFQ1RfTElORV9UT0tFTl9SRU5FV0FMX0lOVEVSVkFMID0gOTAwMDAwOyAvLyAxNSBtaW51dGVzXG5jb25zdCBUT0tFTl9SRU5FV0FMX0lOVEVSVkFMID0gMTIwMDAwO1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBjcmVhdGUoe1xuICBhdWRpb0NvbmZpZyxcbiAgYXVkaW9Db250ZXh0LFxuICBhdWRpb0lucHV0RGV2aWNlSWQsXG4gIGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQsXG4gIGVuYWJsZVRlbGVtZXRyeSxcbiAgZmV0Y2hDcmVkZW50aWFscyxcbiAgc3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkLFxuICBzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlID0gKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIHdpbmRvdy5uYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmXG4gICAgd2luZG93Lm5hdmlnYXRvci5sYW5ndWFnZSkgfHxcbiAgICAnZW4tVVMnLFxuICBzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQsXG4gIHNwZWVjaFN5bnRoZXNpc091dHB1dEZvcm1hdCxcbiAgdGV4dE5vcm1hbGl6YXRpb24sXG4gIHVzZXJJRCxcbiAgdXNlcm5hbWVcbn0pIHtcbiAgaWYgKCFmZXRjaENyZWRlbnRpYWxzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdcImZldGNoQ3JlZGVudGlhbHNcIiBtdXN0IGJlIHNwZWNpZmllZC4nKTtcbiAgfVxuXG4gIGNvbnN0IHsgYXV0aG9yaXphdGlvblRva2VuLCBkaXJlY3RMaW5lVG9rZW4sIHJlZ2lvbiwgc3Vic2NyaXB0aW9uS2V5IH0gPSBhd2FpdCByZXNvbHZlRnVuY3Rpb25PclJldHVyblZhbHVlKFxuICAgIGZldGNoQ3JlZGVudGlhbHNcbiAgKTtcblxuICBpZiAoXG4gICAgKCFhdXRob3JpemF0aW9uVG9rZW4gJiYgIXN1YnNjcmlwdGlvbktleSkgfHxcbiAgICAoYXV0aG9yaXphdGlvblRva2VuICYmIHN1YnNjcmlwdGlvbktleSkgfHxcbiAgICAoYXV0aG9yaXphdGlvblRva2VuICYmIHR5cGVvZiBhdXRob3JpemF0aW9uVG9rZW4gIT09ICdzdHJpbmcnKSB8fFxuICAgIChzdWJzY3JpcHRpb25LZXkgJiYgdHlwZW9mIHN1YnNjcmlwdGlvbktleSAhPT0gJ3N0cmluZycpIHx8XG4gICAgKGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQgJiYgIWRpcmVjdExpbmVUb2tlbilcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ1wiZmV0Y2hDcmVkZW50aWFsc1wiIG11c3QgcmV0dXJuIGVpdGhlciBcImF1dGhvcml6YXRpb25Ub2tlblwiIG9yIFwic3Vic2NyaXB0aW9uS2V5XCIgYXMgYSBub24tZW1wdHkgc3RyaW5nIG9ubHkuIElmIGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQgaXMgc2V0IHRvIHRydWUsIHRoZW4gaXQgc2hvdWxkIGFsc28gcmV0dXJuIGEgbm9uLWVtcHR5IFwiZGlyZWN0TGluZVRva2VuXCInXG4gICAgKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgZW5hYmxlVGVsZW1ldHJ5ICE9PSAndW5kZWZpbmVkJykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaDogVGVsZW1ldHJ5IG9wdGlvbnMgYXJlIG5vdCB5ZXQgc3VwcG9ydGVkLiBQbGVhc2UgcmVmZXIgdG8gQ29nbml0aXZlIFNlcnZpY2VzIGRvY3VtZW50YXRpb24gZm9yIGRldGFpbHMuJ1xuICAgICk7XG4gIH1cblxuICBpZiAoIXJlZ2lvbiB8fCB0eXBlb2YgcmVnaW9uICE9PSAnc3RyaW5nJykge1xuICAgIHRocm93IG5ldyBFcnJvcignXCJmZXRjaENyZWRlbnRpYWxzXCIgbXVzdCByZXR1cm4gXCJyZWdpb25cIiBhcyBhIG5vbi1lbXB0eSBzdHJpbmcuJyk7XG4gIH1cblxuICBpZiAoYXVkaW9Db25maWcgJiYgYXVkaW9JbnB1dERldmljZUlkKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoLXNkazogT25seSBcImF1ZGlvQ29uZmlnXCIgb3IgXCJhdWRpb0lucHV0RGV2aWNlSWRcIiBjYW4gYmUgc3BlY2lmaWVkLCBidXQgbm90IGJvdGg7IGlnbm9yaW5nIFwiYXVkaW9JbnB1dERldmljZUlkXCIuJ1xuICAgICk7XG4gIH0gZWxzZSBpZiAoIWF1ZGlvQ29uZmlnKSB7XG4gICAgaWYgKGF1ZGlvSW5wdXREZXZpY2VJZCkge1xuICAgICAgYXVkaW9Db25maWcgPSBBdWRpb0NvbmZpZy5mcm9tTWljcm9waG9uZUlucHV0KGF1ZGlvSW5wdXREZXZpY2VJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF1ZGlvQ29uZmlnID0gQXVkaW9Db25maWcuZnJvbURlZmF1bHRNaWNyb3Bob25lSW5wdXQoKTtcbiAgICB9XG5cbiAgICAvLyBXT1JLQVJPVU5EOiBJbiBTcGVlY2ggU0RLIDEuMTIuMC0xLjEzLjEsIGl0IGRyb3BwZWQgc3VwcG9ydCBvZiBtYWNPUy9pT1MgU2FmYXJpLlxuICAgIC8vICAgICAgICAgICAgIFRoaXMgY29kZSBpcyBhZG9wdGVkIGZyb20gbWljcm9zb2Z0LWNvZ25pdGl2ZXNlcnZpY2VzLXNwZWVjaC1zZGsvc3JjL2NvbW1vbi5icm93c2VyL01pY0F1ZGlvU291cmNlLnRzLlxuICAgIC8vICAgICAgICAgICAgIFdlIHdpbGwgbm90IG5lZWQgdGhpcyBjb2RlIHdoZW4gdXNpbmcgU3BlZWNoIFNESyAxLjE0LjAgb3IgdXAuXG4gICAgLy8gVE9ETzogW1AxXSAjMzU3NSBSZW1vdmUgdGhlIGZvbGxvd2luZyBsaW5lcyB3aGVuIGJ1bXBpbmcgdG8gU3BlZWNoIFNESyAxLjE0LjAgb3IgaGlnaGVyXG4gICAgY29uc3QgeyBwcml2U291cmNlOiBzb3VyY2UgfSA9IGF1ZGlvQ29uZmlnO1xuXG4gICAgc291cmNlLmNyZWF0ZUF1ZGlvQ29udGV4dCA9ICgpID0+IHtcbiAgICAgIGlmICghIXNvdXJjZS5wcml2Q29udGV4dCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IEF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDtcblxuICAgICAgaWYgKHR5cGVvZiBBdWRpb0NvbnRleHQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYiBBdWRpbyBBUEkgKEF1ZGlvQ29udGV4dC93ZWJraXRBdWRpb0NvbnRleHQgaXMgbm90IGF2YWlsYWJsZSkuJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFN1cHBvcnRlZENvbnN0cmFpbnRzKCkuc2FtcGxlUmF0ZSkge1xuICAgICAgICBzb3VyY2UucHJpdkNvbnRleHQgPSBuZXcgQXVkaW9Db250ZXh0KHsgc2FtcGxlUmF0ZTogTWljQXVkaW9Tb3VyY2UuQVVESU9GT1JNQVQuc2FtcGxlc1BlclNlYyB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNvdXJjZS5wcml2Q29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgaWYgKHNwZWVjaFJlY29nbml0aW9uRW5kcG9pbnRJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaDogQ3VzdG9tIFNwZWVjaCBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBWb2ljZSBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IFN5bnRoZXNpcyBvdXRwdXQgZm9ybWF0IGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkOyBpZ25vcmluZyBcInNwZWVjaFN5bnRoZXNpc091dHB1dEZvcm1hdFwiLidcbiAgICApO1xuICB9XG5cbiAgaWYgKHRleHROb3JtYWxpemF0aW9uKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoOiBUZXh0IG5vcm1hbGl6YXRpb24gaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQ7IGlnbm9yaW5nIFwidGV4dE5vcm1hbGl6YXRpb25cIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmICh1c2VySUQgfHwgdXNlcm5hbWUpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBcInVzZXJJZFwiIGFuZCBcInVzZXJuYW1lXCIgYXJlIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGFuZCBhcmUgaWdub3JlZC4nXG4gICAgKTtcbiAgfVxuXG4gIGxldCBjb25maWc7XG5cbiAgaWYgKGF1dGhvcml6YXRpb25Ub2tlbikge1xuICAgIGNvbmZpZyA9IEJvdEZyYW1ld29ya0NvbmZpZy5mcm9tQXV0aG9yaXphdGlvblRva2VuKGF1dGhvcml6YXRpb25Ub2tlbiwgcmVnaW9uKTtcbiAgfSBlbHNlIHtcbiAgICBjb25maWcgPSBCb3RGcmFtZXdvcmtDb25maWcuZnJvbVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb25LZXksIHJlZ2lvbik7XG4gIH1cblxuICAvLyBJZiBpbnRlcm5hbCBIVFRQIHN1cHBvcnQgaXMgZW5hYmxlZCwgc3dpdGNoIHRoZSBlbmRwb2ludCB0byBEaXJlY3QgTGluZSBvbiBEaXJlY3QgTGluZSBTcGVlY2ggc2VydmljZS5cbiAgaWYgKGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQpIHtcbiAgICBjb25maWcuc2V0UHJvcGVydHkoXG4gICAgICBQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0VuZHBvaW50LFxuICAgICAgYHdzczovLyR7ZW5jb2RlVVJJKHJlZ2lvbil9LmNvbnZhaS5zcGVlY2gubWljcm9zb2Z0LmNvbS9kaXJlY3RsaW5lL2FwaS92MWBcbiAgICApO1xuXG4gICAgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FwcGxpY2F0aW9uSWQsIGRpcmVjdExpbmVUb2tlbik7XG4gIH1cblxuICAvLyBTdXBwb3J0ZWQgb3B0aW9ucyBjYW4gYmUgZm91bmQgaW4gRGlhbG9nQ29ubmVjdG9yRmFjdG9yeS5qcy5cblxuICAvLyBTZXQgdGhlIGxhbmd1YWdlIHVzZWQgZm9yIHJlY29nbml0aW9uLlxuICBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5TcGVlY2hTZXJ2aWNlQ29ubmVjdGlvbl9SZWNvTGFuZ3VhZ2UsIHNwZWVjaFJlY29nbml0aW9uTGFuZ3VhZ2UpO1xuXG4gIC8vIFRoZSBmb2xsb3dpbmcgY29kZSBzZXRzIHRoZSBvdXRwdXQgZm9ybWF0LlxuICAvLyBBcyBhZHZpc2VkIGJ5IHRoZSBTcGVlY2ggdGVhbSwgdGhpcyBBUEkgbWF5IGJlIHN1YmplY3QgdG8gZnV0dXJlIGNoYW5nZXMuXG4gIC8vIFdlIGFyZSBub3QgZW5hYmxpbmcgb3V0cHV0IGZvcm1hdCBvcHRpb24gYmVjYXVzZSBpdCBkb2VzIG5vdCBzZW5kIGRldGFpbGVkIG91dHB1dCBmb3JtYXQgdG8gdGhlIGJvdCwgcmVuZGVyaW5nIHRoaXMgb3B0aW9uIHVzZWxlc3MuXG4gIC8vIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VSZXNwb25zZV9PdXRwdXRGb3JtYXRPcHRpb24sIE91dHB1dEZvcm1hdFtPdXRwdXRGb3JtYXQuRGV0YWlsZWRdKTtcblxuICAvLyBTZXQgdGhlIHVzZXIgSUQgZm9yIHN0YXJ0aW5nIHRoZSBjb252ZXJzYXRpb24uXG4gIHVzZXJJRCAmJiBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5Db252ZXJzYXRpb25fRnJvbV9JZCwgdXNlcklEKTtcblxuICAvLyBTZXQgQ3VzdG9tIFNwZWVjaCBhbmQgQ3VzdG9tIFZvaWNlLlxuICAvLyBUaGUgZm9sbG93aW5nIGNvZGUgaXMgY29waWVkIGZyb20gQyMsIGFuZCBpdCBpcyBub3Qgd29ya2luZyB5ZXQuXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9BenVyZS1TYW1wbGVzL0NvZ25pdGl2ZS1TZXJ2aWNlcy1EaXJlY3QtTGluZS1TcGVlY2gtQ2xpZW50L2Jsb2IvbWFzdGVyL0RMU3BlZWNoQ2xpZW50L01haW5XaW5kb3cueGFtbC5jc1xuICAvLyBzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQgJiYgY29uZmlnLnNldFNlcnZpY2VQcm9wZXJ0eSgnY2lkJywgc3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkLCBTZXJ2aWNlUHJvcGVydHlDaGFubmVsLlVyaVF1ZXJ5UGFyYW1ldGVyKTtcbiAgLy8gc3BlZWNoU3ludGhlc2lzRGVwbG95bWVudElkICYmIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLmNvbnZlcnNhdGlvbl9DdXN0b21fVm9pY2VfRGVwbG95bWVudF9JZHMsIHNwZWVjaFN5bnRoZXNpc0RlcGxveW1lbnRJZCk7XG5cbiAgY29uc3QgZGlhbG9nU2VydmljZUNvbm5lY3RvciA9IHBhdGNoRGlhbG9nU2VydmljZUNvbm5lY3RvcklubGluZShuZXcgRGlhbG9nU2VydmljZUNvbm5lY3Rvcihjb25maWcsIGF1ZGlvQ29uZmlnKSk7XG5cbiAgZGlhbG9nU2VydmljZUNvbm5lY3Rvci5jb25uZWN0KCk7XG5cbiAgLy8gUmVuZXcgdG9rZW4gcGVyIGludGVydmFsLlxuICBpZiAoYXV0aG9yaXphdGlvblRva2VuKSB7XG4gICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyAjMjY2MCBJZiB0aGUgY29ubmVjdG9yIGhhcyBiZWVuIGRpc3Bvc2VkLCB3ZSBzaG91bGQgc3RvcCByZW5ld2luZyB0aGUgdG9rZW4uXG5cbiAgICAgIC8vIFRPRE86IFdlIHNob3VsZCB1c2UgYSBwdWJsaWMgaW1wbGVtZW50YXRpb24gaWYgU3BlZWNoIFNESyBoYXMgb25lIHJlbGF0ZWQgdG8gXCJwcml2SXNEaXNwb3NlZFwiLlxuICAgICAgaWYgKGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IucHJpdklzRGlzcG9zZWQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgYXV0aG9yaXphdGlvblRva2VuLCByZWdpb246IG5leHRSZWdpb24gfSA9IGF3YWl0IHJlc29sdmVGdW5jdGlvbk9yUmV0dXJuVmFsdWUoZmV0Y2hDcmVkZW50aWFscyk7XG5cbiAgICAgIGlmICghYXV0aG9yaXphdGlvblRva2VuKSB7XG4gICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoLXNkazogUmVuZXcgdG9rZW4gZmFpbGVkIGJlY2F1c2UgXCJmZXRjaENyZWRlbnRpYWxzXCIgY2FsbCByZXR1cm5lZCBubyBhdXRob3JpemF0aW9uIHRva2VuLidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlZ2lvbiAhPT0gbmV4dFJlZ2lvbikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFxuICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlZ2lvbiBjaGFuZ2UgaXMgbm90IHN1cHBvcnRlZCBmb3IgcmVuZXdlZCB0b2tlbi4gQXV0aG9yaXphdGlvbiB0b2tlbiBpcyBub3QgcmVuZXdlZC4nXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IuYXV0aG9yaXphdGlvblRva2VuID0gYXV0aG9yaXphdGlvblRva2VuOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXRvbWljLXVwZGF0ZXNcbiAgICB9LCBUT0tFTl9SRU5FV0FMX0lOVEVSVkFMKTtcbiAgfVxuXG4gIC8vIFJlbmV3IHRva2VuIHBlciBpbnRlcnZhbC5cbiAgaWYgKGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQpIHtcbiAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIC8vICMyNjYwIElmIHRoZSBjb25uZWN0b3IgaGFzIGJlZW4gZGlzcG9zZWQsIHdlIHNob3VsZCBzdG9wIHJlbmV3aW5nIHRoZSB0b2tlbi5cblxuICAgICAgLy8gVE9ETzogV2Ugc2hvdWxkIHVzZSBhIHB1YmxpYyBpbXBsZW1lbnRhdGlvbiBpZiBTcGVlY2ggU0RLIGhhcyBvbmUgcmVsYXRlZCB0byBcInByaXZJc0Rpc3Bvc2VkXCIuXG4gICAgICBpZiAoZGlhbG9nU2VydmljZUNvbm5lY3Rvci5wcml2SXNEaXNwb3NlZCkge1xuICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVmcmVzaGVkRGlyZWN0TGluZVRva2VuID0gYXdhaXQgcmVmcmVzaERpcmVjdExpbmVUb2tlbihkaXJlY3RMaW5lVG9rZW4pO1xuXG4gICAgICBpZiAoIXJlZnJlc2hlZERpcmVjdExpbmVUb2tlbikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFxuICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlbmV3IHRva2VuIGZhaWxlZCBiZWNhdXNlIGNhbGwgdG8gcmVmcmVzaCB0b2tlbiBEaXJlY3QgTGluZSBBUEkgZGlkIG5vdCByZXR1cm4gYSBuZXcgdG9rZW4uJ1xuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5Db252ZXJzYXRpb25fQXBwbGljYXRpb25JZCwgcmVmcmVzaGVkRGlyZWN0TGluZVRva2VuKTtcblxuICAgICAgZGlhbG9nU2VydmljZUNvbm5lY3Rvci5wcm9wZXJ0aWVzLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FwcGxpY2F0aW9uSWQsIHJlZnJlc2hlZERpcmVjdExpbmVUb2tlbik7XG4gICAgICBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLmNvbm5lY3QoKTtcbiAgICB9LCBESVJFQ1RfTElORV9UT0tFTl9SRU5FV0FMX0lOVEVSVkFMKTtcbiAgfVxuXG4gIGNvbnN0IGRpcmVjdExpbmUgPSBuZXcgRGlyZWN0TGluZVNwZWVjaCh7IGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IgfSk7XG5cbiAgY29uc3Qgd2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5ID0gY3JlYXRlV2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5KHtcbiAgICBhdWRpb0NvbnRleHQsXG4gICAgZW5hYmxlVGVsZW1ldHJ5LFxuICAgIHJlY29nbml6ZXI6IGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IsXG4gICAgdGV4dE5vcm1hbGl6YXRpb25cbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBkaXJlY3RMaW5lLFxuICAgIHdlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeVxuICB9O1xufVxuIl19