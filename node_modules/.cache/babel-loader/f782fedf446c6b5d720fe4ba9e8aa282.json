{"ast":null,"code":"\"use strict\"; // Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license.\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\n  }\n  result[\"default\"] = mod;\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Exports_1 = require(\"../common/Exports\"); // Node.JS specific xmlhttprequest / browser support.\n\n\nvar XHR = __importStar(require(\"xmlhttprequest-ts\"));\n\nvar RestRequestType;\n\n(function (RestRequestType) {\n  RestRequestType[\"Get\"] = \"get\";\n  RestRequestType[\"Post\"] = \"post\";\n  RestRequestType[\"Delete\"] = \"delete\";\n  RestRequestType[\"File\"] = \"file\";\n})(RestRequestType = exports.RestRequestType || (exports.RestRequestType = {})); // accept rest operations via request method and return abstracted objects from server response\n\n\nvar RestMessageAdapter =\n/** @class */\nfunction () {\n  function RestMessageAdapter(configParams, connectionId) {\n    if (!configParams) {\n      throw new Exports_1.ArgumentNullError(\"configParams\");\n    }\n\n    this.privHeaders = configParams.headers;\n    this.privTimeout = configParams.timeout;\n    this.privIgnoreCache = configParams.ignoreCache;\n  }\n\n  RestMessageAdapter.prototype.setHeaders = function (key, value) {\n    this.privHeaders[key] = value;\n  };\n\n  RestMessageAdapter.prototype.request = function (method, uri, queryParams, body, binaryBody) {\n    var _this = this;\n\n    if (queryParams === void 0) {\n      queryParams = {};\n    }\n\n    if (body === void 0) {\n      body = null;\n    }\n\n    if (binaryBody === void 0) {\n      binaryBody = null;\n    }\n\n    var responseReceivedDeferral = new Exports_1.Deferred();\n    var xhr;\n\n    if (typeof XMLHttpRequest === \"undefined\") {\n      xhr = new XHR.XMLHttpRequest();\n    } else {\n      xhr = new XMLHttpRequest();\n    }\n\n    var requestCommand = method === RestRequestType.File ? \"post\" : method;\n    xhr.open(requestCommand, this.withQuery(uri, queryParams), true);\n\n    if (this.privHeaders) {\n      Object.keys(this.privHeaders).forEach(function (key) {\n        return xhr.setRequestHeader(key, _this.privHeaders[key]);\n      });\n    }\n\n    if (this.privIgnoreCache) {\n      xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n    }\n\n    xhr.timeout = this.privTimeout;\n\n    xhr.onload = function () {\n      responseReceivedDeferral.resolve(_this.parseXHRResult(xhr));\n    };\n\n    xhr.onerror = function () {\n      responseReceivedDeferral.resolve(_this.errorResponse(xhr, \"Failed to make request.\"));\n    };\n\n    xhr.ontimeout = function () {\n      responseReceivedDeferral.resolve(_this.errorResponse(xhr, \"Request took longer than expected.\"));\n    };\n\n    if (method === RestRequestType.File && binaryBody) {\n      xhr.setRequestHeader(\"Content-Type\", \"multipart/form-data\");\n      xhr.send(binaryBody);\n    } else if (method === RestRequestType.Post && body) {\n      xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n      xhr.send(JSON.stringify(body));\n    } else {\n      xhr.send();\n    }\n\n    return responseReceivedDeferral.promise();\n  };\n\n  RestMessageAdapter.prototype.parseXHRResult = function (xhr) {\n    return {\n      data: xhr.responseText,\n      headers: xhr.getAllResponseHeaders(),\n      json: function json() {\n        return JSON.parse(xhr.responseText);\n      },\n      ok: xhr.status >= 200 && xhr.status < 300,\n      status: xhr.status,\n      statusText: xhr.statusText\n    };\n  };\n\n  RestMessageAdapter.prototype.errorResponse = function (xhr, message) {\n    if (message === void 0) {\n      message = null;\n    }\n\n    return {\n      data: message || xhr.statusText,\n      headers: xhr.getAllResponseHeaders(),\n      json: function json() {\n        return JSON.parse(message || \"\\\"\" + xhr.statusText + \"\\\"\");\n      },\n      ok: false,\n      status: xhr.status,\n      statusText: xhr.statusText\n    };\n  };\n\n  RestMessageAdapter.prototype.withQuery = function (url, params) {\n    if (params === void 0) {\n      params = {};\n    }\n\n    var queryString = this.queryParams(params);\n    return queryString ? url + (url.indexOf(\"?\") === -1 ? \"?\" : \"&\") + queryString : url;\n  };\n\n  RestMessageAdapter.prototype.queryParams = function (params) {\n    if (params === void 0) {\n      params = {};\n    }\n\n    return Object.keys(params).map(function (k) {\n      return encodeURIComponent(k) + \"=\" + encodeURIComponent(params[k]);\n    }).join(\"&\");\n  };\n\n  return RestMessageAdapter;\n}();\n\nexports.RestMessageAdapter = RestMessageAdapter;","map":{"version":3,"sources":["src/common.browser/RestMessageAdapter.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\nimport {\r\n    ArgumentNullError,\r\n    Deferred,\r\n    Promise,\r\n} from \"../common/Exports\";\r\nimport { IRequestOptions } from \"./Exports\";\r\n\r\n// Node.JS specific xmlhttprequest / browser support.\r\nimport * as XHR from \"xmlhttprequest-ts\";\r\n\r\nexport enum RestRequestType {\r\n    Get = \"get\",\r\n    Post = \"post\",\r\n    Delete = \"delete\",\r\n    File = \"file\",\r\n}\r\n\r\nexport interface IRestResponse {\r\n    ok: boolean;\r\n    status: number;\r\n    statusText: string;\r\n    data: string;\r\n    json: <T>() => T;\r\n    headers: string;\r\n}\r\n\r\n// accept rest operations via request method and return abstracted objects from server response\r\nexport class RestMessageAdapter {\r\n\r\n    private privTimeout: number;\r\n    private privIgnoreCache: boolean;\r\n    private privHeaders: { [key: string]: string; };\r\n\r\n    public constructor(\r\n        configParams: IRequestOptions,\r\n        connectionId?: string\r\n        ) {\r\n\r\n        if (!configParams) {\r\n            throw new ArgumentNullError(\"configParams\");\r\n        }\r\n\r\n        this.privHeaders = configParams.headers;\r\n        this.privTimeout = configParams.timeout;\r\n        this.privIgnoreCache = configParams.ignoreCache;\r\n    }\r\n\r\n    public setHeaders(key: string, value: string ): void {\r\n        this.privHeaders[key] = value;\r\n    }\r\n\r\n    public request(\r\n        method: RestRequestType,\r\n        uri: string,\r\n        queryParams: any = {},\r\n        body: any = null,\r\n        binaryBody: Blob | Buffer = null,\r\n        ): Promise<IRestResponse> {\r\n\r\n        const responseReceivedDeferral = new Deferred<IRestResponse>();\r\n\r\n        let xhr: XMLHttpRequest | XHR.XMLHttpRequest;\r\n        if (typeof (XMLHttpRequest) === \"undefined\") {\r\n            xhr = new XHR.XMLHttpRequest();\r\n        } else {\r\n            xhr = new XMLHttpRequest();\r\n        }\r\n        const requestCommand = method === RestRequestType.File ? \"post\" : method;\r\n        xhr.open(requestCommand, this.withQuery(uri, queryParams), true);\r\n\r\n        if (this.privHeaders) {\r\n            Object.keys(this.privHeaders).forEach((key: any) => xhr.setRequestHeader(key, this.privHeaders[key]));\r\n        }\r\n\r\n        if (this.privIgnoreCache) {\r\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\r\n        }\r\n\r\n        xhr.timeout = this.privTimeout;\r\n\r\n        xhr.onload = () => {\r\n            responseReceivedDeferral.resolve(this.parseXHRResult(xhr));\r\n        };\r\n\r\n        xhr.onerror = () => {\r\n            responseReceivedDeferral.resolve(this.errorResponse(xhr, \"Failed to make request.\"));\r\n        };\r\n\r\n        xhr.ontimeout = () => {\r\n            responseReceivedDeferral.resolve(this.errorResponse(xhr, \"Request took longer than expected.\"));\r\n        };\r\n\r\n        if (method === RestRequestType.File && binaryBody) {\r\n            xhr.setRequestHeader(\"Content-Type\", \"multipart/form-data\");\r\n            xhr.send(binaryBody);\r\n        } else if (method === RestRequestType.Post && body) {\r\n            xhr.setRequestHeader(\"Content-Type\", \"application/json\");\r\n            xhr.send(JSON.stringify(body));\r\n        } else {\r\n            xhr.send();\r\n        }\r\n\r\n        return responseReceivedDeferral.promise();\r\n    }\r\n\r\n    private parseXHRResult(xhr: XMLHttpRequest | XHR.XMLHttpRequest): IRestResponse {\r\n        return {\r\n            data: xhr.responseText,\r\n            headers: xhr.getAllResponseHeaders(),\r\n            json: <T>() => JSON.parse(xhr.responseText) as T,\r\n            ok: xhr.status >= 200 && xhr.status < 300,\r\n            status: xhr.status,\r\n            statusText: xhr.statusText,\r\n        };\r\n    }\r\n\r\n    private errorResponse(xhr: XMLHttpRequest | XHR.XMLHttpRequest, message: string | null = null): IRestResponse {\r\n        return {\r\n            data: message || xhr.statusText,\r\n            headers: xhr.getAllResponseHeaders(),\r\n            json: <T>() => JSON.parse(message || (\"\\\"\" + xhr.statusText + \"\\\"\")) as T,\r\n            ok: false,\r\n            status: xhr.status,\r\n            statusText: xhr.statusText,\r\n        };\r\n    }\r\n\r\n    private withQuery(url: string, params: any = {}): any {\r\n        const queryString = this.queryParams(params);\r\n        return queryString ? url + (url.indexOf(\"?\") === -1 ? \"?\" : \"&\") + queryString : url;\r\n    }\r\n\r\n    private queryParams(params: any = {}): any {\r\n        return Object.keys(params)\r\n            .map((k: any) => encodeURIComponent(k) + \"=\" + encodeURIComponent(params[k]))\r\n            .join(\"&\");\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"script"}