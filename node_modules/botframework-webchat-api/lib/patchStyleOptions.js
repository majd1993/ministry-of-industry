"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = patchStyleOptions;

var _defaultStyleOptions = _interopRequireDefault(require("./defaultStyleOptions"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// TODO: [P4] We should add a notice for people who want to use "styleSet" instead of "styleOptions".
//       "styleSet" is actually CSS stylesheet and it is based on the DOM tree.
//       DOM tree may change from time to time, thus, maintaining "styleSet" becomes a constant effort.
function parseBorder(border) {
  var dummyElement = document.createElement('div');
  dummyElement.setAttribute('style', "border: ".concat(border));
  var _dummyElement$style = dummyElement.style,
      color = _dummyElement$style.borderColor,
      style = _dummyElement$style.borderStyle,
      width = _dummyElement$style.borderWidth;
  return {
    color: color,
    style: style,
    width: width
  };
}

var PIXEL_UNIT_PATTERN = /^[0-9]+px$/;

function patchStyleOptions(options, _ref) {
  var groupTimestampFromProps = _ref.groupTimestamp,
      sendTimeoutFromProps = _ref.sendTimeout;

  var patchedOptions = _objectSpread(_objectSpread({}, _defaultStyleOptions.default), options); // Keep this list flat (no nested style) and serializable (no functions)
  // TODO: [P4] Deprecate this code after bump to v5


  var bubbleBorder = patchedOptions.bubbleBorder,
      bubbleFromUserBorder = patchedOptions.bubbleFromUserBorder,
      bubbleFromUserNubOffset = patchedOptions.bubbleFromUserNubOffset,
      bubbleNubOffset = patchedOptions.bubbleNubOffset,
      emojiSet = patchedOptions.emojiSet,
      suggestedActionBorder = patchedOptions.suggestedActionBorder,
      suggestedActionDisabledBorder = patchedOptions.suggestedActionDisabledBorder;

  if (bubbleBorder) {
    console.warn('botframework-webchat: "styleSet.bubbleBorder" is deprecated and will be removed on or after 2020-07-17. Please use "bubbleBorderColor", "bubbleBorderStyle", and, "bubbleBorderWidth.');

    var _parseBorder = parseBorder(bubbleBorder),
        color = _parseBorder.color,
        style = _parseBorder.style,
        width = _parseBorder.width;

    if (color && color !== 'initial') {
      patchedOptions.bubbleBorderColor = color;
    }

    if (style && style !== 'initial') {
      patchedOptions.bubbleBorderStyle = style;
    }

    if (PIXEL_UNIT_PATTERN.test(width)) {
      patchedOptions.bubbleBorderWidth = parseInt(width, 10);
    }
  }

  if (bubbleFromUserBorder) {
    console.warn('botframework-webchat: "styleSet.bubbleFromUserBorder" is deprecated and will be removed on or after 2020-07-17. Please use "bubbleFromUserBorderColor", "bubbleFromUserBorderStyle", and, "bubbleFromUserBorderWidth".');

    var _parseBorder2 = parseBorder(bubbleFromUserBorder),
        _color = _parseBorder2.color,
        _style = _parseBorder2.style,
        _width = _parseBorder2.width;

    if (_color && _color !== 'initial') {
      patchedOptions.bubbleFromUserBorderColor = _color;
    }

    if (_style && _style !== 'initial') {
      patchedOptions.bubbleFromUserBorderStyle = _style;
    }

    if (PIXEL_UNIT_PATTERN.test(_width)) {
      patchedOptions.bubbleFromUserBorderWidth = parseInt(_width, 10);
    }
  }

  if (suggestedActionBorder) {
    console.warn('botframework-webchat: "styleSet.suggestedActionBorder" is deprecated and will be removed on or after 2020-09-11. Please use "suggestedActionBorderColor", "suggestedActionBorderStyle", and, "suggestedActionBorderWidth".');

    var _parseBorder3 = parseBorder(suggestedActionBorder),
        _color2 = _parseBorder3.color,
        _style2 = _parseBorder3.style,
        _width2 = _parseBorder3.width;

    if (_color2 && _color2 !== 'initial') {
      patchedOptions.suggestedActionBorderColor = _color2;
    }

    if (_style2 && _style2 !== 'initial') {
      patchedOptions.suggestedActionBorderStyle = _style2;
    }

    if (PIXEL_UNIT_PATTERN.test(_width2)) {
      patchedOptions.suggestedActionBorderWidth = parseInt(_width2, 10);
    }
  }

  if (suggestedActionDisabledBorder) {
    console.warn('botframework-webcaht: "styleSet.suggestedActionDisabledBorder" is deprecated and will be removed on or after 2020-09-11. Please use "suggestedActionDisabledBorderColor", "suggestedActionDisabledBorderStyle", and, "suggestedActionDisabledBorderWidth".');

    var _parseBorder4 = parseBorder(suggestedActionDisabledBorder),
        _color3 = _parseBorder4.color,
        _style3 = _parseBorder4.style,
        _width3 = _parseBorder4.width;

    if (_color3 && _color3 !== 'initial') {
      patchedOptions.suggestedActionDisabledBorderColor = _color3;
    }

    if (_style3 && _style3 !== 'initial') {
      patchedOptions.suggestedActionDisabledBorderStyle = _style3;
    }

    if (PIXEL_UNIT_PATTERN.test(_width3)) {
      patchedOptions.suggestedActionDisabledBorderWidth = parseInt(_width3, 10);
    }
  }

  if (bubbleFromUserNubOffset === 'top') {
    patchedOptions.bubbleFromUserNubOffset = 0;
  } else if (typeof bubbleFromUserNubOffset !== 'number') {
    patchedOptions.bubbleFromUserNubOffset = -0;
  }

  if (bubbleNubOffset === 'top') {
    patchedOptions.bubbleNubOffset = 0;
  } else if (typeof bubbleNubOffset !== 'number') {
    patchedOptions.bubbleNubOffset = -0;
  }

  if (emojiSet === true) {
    patchedOptions.emojiSet = {
      ':)': 'ðŸ˜Š',
      ':-)': 'ðŸ˜Š',
      '(:': 'ðŸ˜Š',
      '(-:': 'ðŸ˜Š',
      ':-|': 'ðŸ˜',
      ':|': 'ðŸ˜',
      ':-(': 'â˜¹ï¸',
      ':(': 'â˜¹ï¸',
      ':-D': 'ðŸ˜€',
      ':D': 'ðŸ˜€',
      ':-p': 'ðŸ˜›',
      ':p': 'ðŸ˜›',
      ':-P': 'ðŸ˜›',
      ':P': 'ðŸ˜›',
      ':-o': 'ðŸ˜²',
      ':o': 'ðŸ˜²',
      ':O': 'ðŸ˜²',
      ':-O': 'ðŸ˜²',
      ':-0': 'ðŸ˜²',
      ':0': 'ðŸ˜²',
      ';-)': 'ðŸ˜‰',
      ';)': 'ðŸ˜‰',
      '<3': 'â¤ï¸',
      '</3': 'ðŸ’”',
      '<\\3': 'ðŸ’”'
    };
  } else if (Object.prototype.toString.call(patchedOptions.emojiSet) !== '[object Object]') {
    console.warn('botframework-webchat: emojiSet must be a boolean or an object with emoticon: emojiValues');
    patchedOptions.emojiSet = false;
  }

  if (typeof groupTimestampFromProps !== 'undefined' && typeof options.groupTimestamp === 'undefined') {
    console.warn('Web Chat: "groupTimestamp" has been moved to "styleOptions". This deprecation migration will be removed on or after January 1 2022.');
    patchedOptions.groupTimestamp = groupTimestampFromProps;
  }

  if (typeof sendTimeoutFromProps !== 'undefined' && typeof options.sendTimeout === 'undefined') {
    console.warn('Web Chat: "sendTimeout" has been moved to "styleOptions". This deprecation migration will be removed on or after January 1 2022.');
    patchedOptions.sendTimeout = sendTimeoutFromProps;
  }

  if (patchedOptions.slowConnectionAfter < 0) {
    console.warn('Web Chat: "slowConnectionAfter" cannot be negative, will set to 0.');
    patchedOptions.slowConnectionAfter = 0;
  }

  return patchedOptions;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXRjaFN0eWxlT3B0aW9ucy5qcyJdLCJuYW1lcyI6WyJwYXJzZUJvcmRlciIsImJvcmRlciIsImR1bW15RWxlbWVudCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsInNldEF0dHJpYnV0ZSIsInN0eWxlIiwiY29sb3IiLCJib3JkZXJDb2xvciIsImJvcmRlclN0eWxlIiwid2lkdGgiLCJib3JkZXJXaWR0aCIsIlBJWEVMX1VOSVRfUEFUVEVSTiIsInBhdGNoU3R5bGVPcHRpb25zIiwib3B0aW9ucyIsImdyb3VwVGltZXN0YW1wRnJvbVByb3BzIiwiZ3JvdXBUaW1lc3RhbXAiLCJzZW5kVGltZW91dEZyb21Qcm9wcyIsInNlbmRUaW1lb3V0IiwicGF0Y2hlZE9wdGlvbnMiLCJkZWZhdWx0U3R5bGVPcHRpb25zIiwiYnViYmxlQm9yZGVyIiwiYnViYmxlRnJvbVVzZXJCb3JkZXIiLCJidWJibGVGcm9tVXNlck51Yk9mZnNldCIsImJ1YmJsZU51Yk9mZnNldCIsImVtb2ppU2V0Iiwic3VnZ2VzdGVkQWN0aW9uQm9yZGVyIiwic3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXIiLCJjb25zb2xlIiwid2FybiIsImJ1YmJsZUJvcmRlckNvbG9yIiwiYnViYmxlQm9yZGVyU3R5bGUiLCJ0ZXN0IiwiYnViYmxlQm9yZGVyV2lkdGgiLCJwYXJzZUludCIsImJ1YmJsZUZyb21Vc2VyQm9yZGVyQ29sb3IiLCJidWJibGVGcm9tVXNlckJvcmRlclN0eWxlIiwiYnViYmxlRnJvbVVzZXJCb3JkZXJXaWR0aCIsInN1Z2dlc3RlZEFjdGlvbkJvcmRlckNvbG9yIiwic3VnZ2VzdGVkQWN0aW9uQm9yZGVyU3R5bGUiLCJzdWdnZXN0ZWRBY3Rpb25Cb3JkZXJXaWR0aCIsInN1Z2dlc3RlZEFjdGlvbkRpc2FibGVkQm9yZGVyQ29sb3IiLCJzdWdnZXN0ZWRBY3Rpb25EaXNhYmxlZEJvcmRlclN0eWxlIiwic3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXJXaWR0aCIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsInNsb3dDb25uZWN0aW9uQWZ0ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7Ozs7Ozs7OztBQUVBO0FBQ0E7QUFDQTtBQUVBLFNBQVNBLFdBQVQsQ0FBcUJDLE1BQXJCLEVBQTZCO0FBQzNCLE1BQU1DLFlBQVksR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLEtBQXZCLENBQXJCO0FBRUFGLEVBQUFBLFlBQVksQ0FBQ0csWUFBYixDQUEwQixPQUExQixvQkFBOENKLE1BQTlDO0FBSDJCLDRCQU92QkMsWUFQdUIsQ0FNekJJLEtBTnlCO0FBQUEsTUFNSEMsS0FORyx1QkFNaEJDLFdBTmdCO0FBQUEsTUFNaUJGLEtBTmpCLHVCQU1JRyxXQU5KO0FBQUEsTUFNcUNDLEtBTnJDLHVCQU13QkMsV0FOeEI7QUFTM0IsU0FBTztBQUNMSixJQUFBQSxLQUFLLEVBQUxBLEtBREs7QUFFTEQsSUFBQUEsS0FBSyxFQUFMQSxLQUZLO0FBR0xJLElBQUFBLEtBQUssRUFBTEE7QUFISyxHQUFQO0FBS0Q7O0FBRUQsSUFBTUUsa0JBQWtCLEdBQUcsWUFBM0I7O0FBRWUsU0FBU0MsaUJBQVQsQ0FDYkMsT0FEYSxRQUdiO0FBQUEsTUFEa0JDLHVCQUNsQixRQURFQyxjQUNGO0FBQUEsTUFEd0RDLG9CQUN4RCxRQUQyQ0MsV0FDM0M7O0FBQ0EsTUFBTUMsY0FBYyxtQ0FBUUMsNEJBQVIsR0FBZ0NOLE9BQWhDLENBQXBCLENBREEsQ0FHQTtBQUVBOzs7QUFMQSxNQU9FTyxZQVBGLEdBY0lGLGNBZEosQ0FPRUUsWUFQRjtBQUFBLE1BUUVDLG9CQVJGLEdBY0lILGNBZEosQ0FRRUcsb0JBUkY7QUFBQSxNQVNFQyx1QkFURixHQWNJSixjQWRKLENBU0VJLHVCQVRGO0FBQUEsTUFVRUMsZUFWRixHQWNJTCxjQWRKLENBVUVLLGVBVkY7QUFBQSxNQVdFQyxRQVhGLEdBY0lOLGNBZEosQ0FXRU0sUUFYRjtBQUFBLE1BWUVDLHFCQVpGLEdBY0lQ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LElBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLG9FQUFiO0FBRUFWLElBQUFBLGNBQWMsQ0FBQzZCLG1CQUFmLEdBQXFDLENBQXJDO0FBQ0Q7O0FBRUQsU0FBTzdCLGNBQVA7QUFDRCIsInNvdXJjZVJvb3QiOiJjb21wb25lbnQ6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlZmF1bHRTdHlsZU9wdGlvbnMgZnJvbSAnLi9kZWZhdWx0U3R5bGVPcHRpb25zJztcblxuLy8gVE9ETzogW1A0XSBXZSBzaG91bGQgYWRkIGEgbm90aWNlIGZvciBwZW9wbGUgd2hvIHdhbnQgdG8gdXNlIFwic3R5bGVTZXRcIiBpbnN0ZWFkIG9mIFwic3R5bGVPcHRpb25zXCIuXG4vLyAgICAgICBcInN0eWxlU2V0XCIgaXMgYWN0dWFsbHkgQ1NTIHN0eWxlc2hlZXQgYW5kIGl0IGlzIGJhc2VkIG9uIHRoZSBET00gdHJlZS5cbi8vICAgICAgIERPTSB0cmVlIG1heSBjaGFuZ2UgZnJvbSB0aW1lIHRvIHRpbWUsIHRodXMsIG1haW50YWluaW5nIFwic3R5bGVTZXRcIiBiZWNvbWVzIGEgY29uc3RhbnQgZWZmb3J0LlxuXG5mdW5jdGlvbiBwYXJzZUJvcmRlcihib3JkZXIpIHtcbiAgY29uc3QgZHVtbXlFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgZHVtbXlFbGVtZW50LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBgYm9yZGVyOiAke2JvcmRlcn1gKTtcblxuICBjb25zdCB7XG4gICAgc3R5bGU6IHsgYm9yZGVyQ29sb3I6IGNvbG9yLCBib3JkZXJTdHlsZTogc3R5bGUsIGJvcmRlcldpZHRoOiB3aWR0aCB9XG4gIH0gPSBkdW1teUVsZW1lbnQ7XG5cbiAgcmV0dXJuIHtcbiAgICBjb2xvcixcbiAgICBzdHlsZSxcbiAgICB3aWR0aFxuICB9O1xufVxuXG5jb25zdCBQSVhFTF9VTklUX1BBVFRFUk4gPSAvXlxcZCtweCQvdTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcGF0Y2hTdHlsZU9wdGlvbnMoXG4gIG9wdGlvbnMsXG4gIHsgZ3JvdXBUaW1lc3RhbXA6IGdyb3VwVGltZXN0YW1wRnJvbVByb3BzLCBzZW5kVGltZW91dDogc2VuZFRpbWVvdXRGcm9tUHJvcHMgfVxuKSB7XG4gIGNvbnN0IHBhdGNoZWRPcHRpb25zID0geyAuLi5kZWZhdWx0U3R5bGVPcHRpb25zLCAuLi5vcHRpb25zIH07XG5cbiAgLy8gS2VlcCB0aGlzIGxpc3QgZmxhdCAobm8gbmVzdGVkIHN0eWxlKSBhbmQgc2VyaWFsaXphYmxlIChubyBmdW5jdGlvbnMpXG5cbiAgLy8gVE9ETzogW1A0XSBEZXByZWNhdGUgdGhpcyBjb2RlIGFmdGVyIGJ1bXAgdG8gdjVcbiAgY29uc3Qge1xuICAgIGJ1YmJsZUJvcmRlcixcbiAgICBidWJibGVGcm9tVXNlckJvcmRlcixcbiAgICBidWJibGVGcm9tVXNlck51Yk9mZnNldCxcbiAgICBidWJibGVOdWJPZmZzZXQsXG4gICAgZW1vamlTZXQsXG4gICAgc3VnZ2VzdGVkQWN0aW9uQm9yZGVyLFxuICAgIHN1Z2dlc3RlZEFjdGlvbkRpc2FibGVkQm9yZGVyXG4gIH0gPSBwYXRjaGVkT3B0aW9ucztcblxuICBpZiAoYnViYmxlQm9yZGVyKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBcInN0eWxlU2V0LmJ1YmJsZUJvcmRlclwiIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBvbiBvciBhZnRlciAyMDIwLTA3LTE3LiBQbGVhc2UgdXNlIFwiYnViYmxlQm9yZGVyQ29sb3JcIiwgXCJidWJibGVCb3JkZXJTdHlsZVwiLCBhbmQsIFwiYnViYmxlQm9yZGVyV2lkdGguJ1xuICAgICk7XG5cbiAgICBjb25zdCB7IGNvbG9yLCBzdHlsZSwgd2lkdGggfSA9IHBhcnNlQm9yZGVyKGJ1YmJsZUJvcmRlcik7XG5cbiAgICBpZiAoY29sb3IgJiYgY29sb3IgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlQm9yZGVyQ29sb3IgPSBjb2xvcjtcbiAgICB9XG5cbiAgICBpZiAoc3R5bGUgJiYgc3R5bGUgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlQm9yZGVyU3R5bGUgPSBzdHlsZTtcbiAgICB9XG5cbiAgICBpZiAoUElYRUxfVU5JVF9QQVRURVJOLnRlc3Qod2lkdGgpKSB7XG4gICAgICBwYXRjaGVkT3B0aW9ucy5idWJibGVCb3JkZXJXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGJ1YmJsZUZyb21Vc2VyQm9yZGVyKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBcInN0eWxlU2V0LmJ1YmJsZUZyb21Vc2VyQm9yZGVyXCIgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIG9uIG9yIGFmdGVyIDIwMjAtMDctMTcuIFBsZWFzZSB1c2UgXCJidWJibGVGcm9tVXNlckJvcmRlckNvbG9yXCIsIFwiYnViYmxlRnJvbVVzZXJCb3JkZXJTdHlsZVwiLCBhbmQsIFwiYnViYmxlRnJvbVVzZXJCb3JkZXJXaWR0aFwiLidcbiAgICApO1xuXG4gICAgY29uc3QgeyBjb2xvciwgc3R5bGUsIHdpZHRoIH0gPSBwYXJzZUJvcmRlcihidWJibGVGcm9tVXNlckJvcmRlcik7XG5cbiAgICBpZiAoY29sb3IgJiYgY29sb3IgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlRnJvbVVzZXJCb3JkZXJDb2xvciA9IGNvbG9yO1xuICAgIH1cblxuICAgIGlmIChzdHlsZSAmJiBzdHlsZSAhPT0gJ2luaXRpYWwnKSB7XG4gICAgICBwYXRjaGVkT3B0aW9ucy5idWJibGVGcm9tVXNlckJvcmRlclN0eWxlID0gc3R5bGU7XG4gICAgfVxuXG4gICAgaWYgKFBJWEVMX1VOSVRfUEFUVEVSTi50ZXN0KHdpZHRoKSkge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlRnJvbVVzZXJCb3JkZXJXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN1Z2dlc3RlZEFjdGlvbkJvcmRlcikge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdDogXCJzdHlsZVNldC5zdWdnZXN0ZWRBY3Rpb25Cb3JkZXJcIiBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgb24gb3IgYWZ0ZXIgMjAyMC0wOS0xMS4gUGxlYXNlIHVzZSBcInN1Z2dlc3RlZEFjdGlvbkJvcmRlckNvbG9yXCIsIFwic3VnZ2VzdGVkQWN0aW9uQm9yZGVyU3R5bGVcIiwgYW5kLCBcInN1Z2dlc3RlZEFjdGlvbkJvcmRlcldpZHRoXCIuJ1xuICAgICk7XG5cbiAgICBjb25zdCB7IGNvbG9yLCBzdHlsZSwgd2lkdGggfSA9IHBhcnNlQm9yZGVyKHN1Z2dlc3RlZEFjdGlvbkJvcmRlcik7XG5cbiAgICBpZiAoY29sb3IgJiYgY29sb3IgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuc3VnZ2VzdGVkQWN0aW9uQm9yZGVyQ29sb3IgPSBjb2xvcjtcbiAgICB9XG5cbiAgICBpZiAoc3R5bGUgJiYgc3R5bGUgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuc3VnZ2VzdGVkQWN0aW9uQm9yZGVyU3R5bGUgPSBzdHlsZTtcbiAgICB9XG5cbiAgICBpZiAoUElYRUxfVU5JVF9QQVRURVJOLnRlc3Qod2lkdGgpKSB7XG4gICAgICBwYXRjaGVkT3B0aW9ucy5zdWdnZXN0ZWRBY3Rpb25Cb3JkZXJXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN1Z2dlc3RlZEFjdGlvbkRpc2FibGVkQm9yZGVyKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay13ZWJjYWh0OiBcInN0eWxlU2V0LnN1Z2dlc3RlZEFjdGlvbkRpc2FibGVkQm9yZGVyXCIgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIG9uIG9yIGFmdGVyIDIwMjAtMDktMTEuIFBsZWFzZSB1c2UgXCJzdWdnZXN0ZWRBY3Rpb25EaXNhYmxlZEJvcmRlckNvbG9yXCIsIFwic3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXJTdHlsZVwiLCBhbmQsIFwic3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXJXaWR0aFwiLidcbiAgICApO1xuXG4gICAgY29uc3QgeyBjb2xvciwgc3R5bGUsIHdpZHRoIH0gPSBwYXJzZUJvcmRlcihzdWdnZXN0ZWRBY3Rpb25EaXNhYmxlZEJvcmRlcik7XG5cbiAgICBpZiAoY29sb3IgJiYgY29sb3IgIT09ICdpbml0aWFsJykge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuc3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXJDb2xvciA9IGNvbG9yO1xuICAgIH1cblxuICAgIGlmIChzdHlsZSAmJiBzdHlsZSAhPT0gJ2luaXRpYWwnKSB7XG4gICAgICBwYXRjaGVkT3B0aW9ucy5zdWdnZXN0ZWRBY3Rpb25EaXNhYmxlZEJvcmRlclN0eWxlID0gc3R5bGU7XG4gICAgfVxuXG4gICAgaWYgKFBJWEVMX1VOSVRfUEFUVEVSTi50ZXN0KHdpZHRoKSkge1xuICAgICAgcGF0Y2hlZE9wdGlvbnMuc3VnZ2VzdGVkQWN0aW9uRGlzYWJsZWRCb3JkZXJXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGJ1YmJsZUZyb21Vc2VyTnViT2Zmc2V0ID09PSAndG9wJykge1xuICAgIHBhdGNoZWRPcHRpb25zLmJ1YmJsZUZyb21Vc2VyTnViT2Zmc2V0ID0gMDtcbiAgfSBlbHNlIGlmICh0eXBlb2YgYnViYmxlRnJvbVVzZXJOdWJPZmZzZXQgIT09ICdudW1iZXInKSB7XG4gICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlRnJvbVVzZXJOdWJPZmZzZXQgPSAtMDtcbiAgfVxuXG4gIGlmIChidWJibGVOdWJPZmZzZXQgPT09ICd0b3AnKSB7XG4gICAgcGF0Y2hlZE9wdGlvbnMuYnViYmxlTnViT2Zmc2V0ID0gMDtcbiAgfSBlbHNlIGlmICh0eXBlb2YgYnViYmxlTnViT2Zmc2V0ICE9PSAnbnVtYmVyJykge1xuICAgIHBhdGNoZWRPcHRpb25zLmJ1YmJsZU51Yk9mZnNldCA9IC0wO1xuICB9XG5cbiAgaWYgKGVtb2ppU2V0ID09PSB0cnVlKSB7XG4gICAgcGF0Y2hlZE9wdGlvbnMuZW1vamlTZXQgPSB7XG4gICAgICAnOiknOiAn8J+YiicsXG4gICAgICAnOi0pJzogJ/CfmIonLFxuICAgICAgJyg6JzogJ/CfmIonLFxuICAgICAgJygtOic6ICfwn5iKJyxcbiAgICAgICc6LXwnOiAn8J+YkCcsXG4gICAgICAnOnwnOiAn8J+YkCcsXG4gICAgICAnOi0oJzogJ+KYue+4jycsXG4gICAgICAnOignOiAn4pi577iPJyxcbiAgICAgICc6LUQnOiAn8J+YgCcsXG4gICAgICAnOkQnOiAn8J+YgCcsXG4gICAgICAnOi1wJzogJ/CfmJsnLFxuICAgICAgJzpwJzogJ/CfmJsnLFxuICAgICAgJzotUCc6ICfwn5ibJyxcbiAgICAgICc6UCc6ICfwn5ibJyxcbiAgICAgICc6LW8nOiAn8J+YsicsXG4gICAgICAnOm8nOiAn8J+YsicsXG4gICAgICAnOk8nOiAn8J+YsicsXG4gICAgICAnOi1PJzogJ/CfmLInLFxuICAgICAgJzotMCc6ICfwn5iyJyxcbiAgICAgICc6MCc6ICfwn5iyJyxcbiAgICAgICc7LSknOiAn8J+YiScsXG4gICAgICAnOyknOiAn8J+YiScsXG4gICAgICAnPDMnOiAn4p2k77iPJyxcbiAgICAgICc8LzMnOiAn8J+SlCcsXG4gICAgICAnPFxcXFwzJzogJ/CfkpQnXG4gICAgfTtcbiAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGF0Y2hlZE9wdGlvbnMuZW1vamlTZXQpICE9PSAnW29iamVjdCBPYmplY3RdJykge1xuICAgIGNvbnNvbGUud2FybignYm90ZnJhbWV3b3JrLXdlYmNoYXQ6IGVtb2ppU2V0IG11c3QgYmUgYSBib29sZWFuIG9yIGFuIG9iamVjdCB3aXRoIGVtb3RpY29uOiBlbW9qaVZhbHVlcycpO1xuICAgIHBhdGNoZWRPcHRpb25zLmVtb2ppU2V0ID0gZmFsc2U7XG4gIH1cblxuICBpZiAodHlwZW9mIGdyb3VwVGltZXN0YW1wRnJvbVByb3BzICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygb3B0aW9ucy5ncm91cFRpbWVzdGFtcCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnV2ViIENoYXQ6IFwiZ3JvdXBUaW1lc3RhbXBcIiBoYXMgYmVlbiBtb3ZlZCB0byBcInN0eWxlT3B0aW9uc1wiLiBUaGlzIGRlcHJlY2F0aW9uIG1pZ3JhdGlvbiB3aWxsIGJlIHJlbW92ZWQgb24gb3IgYWZ0ZXIgSmFudWFyeSAxIDIwMjIuJ1xuICAgICk7XG5cbiAgICBwYXRjaGVkT3B0aW9ucy5ncm91cFRpbWVzdGFtcCA9IGdyb3VwVGltZXN0YW1wRnJvbVByb3BzO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBzZW5kVGltZW91dEZyb21Qcm9wcyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIG9wdGlvbnMuc2VuZFRpbWVvdXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ1dlYiBDaGF0OiBcInNlbmRUaW1lb3V0XCIgaGFzIGJlZW4gbW92ZWQgdG8gXCJzdHlsZU9wdGlvbnNcIi4gVGhpcyBkZXByZWNhdGlvbiBtaWdyYXRpb24gd2lsbCBiZSByZW1vdmVkIG9uIG9yIGFmdGVyIEphbnVhcnkgMSAyMDIyLidcbiAgICApO1xuXG4gICAgcGF0Y2hlZE9wdGlvbnMuc2VuZFRpbWVvdXQgPSBzZW5kVGltZW91dEZyb21Qcm9wcztcbiAgfVxuXG4gIGlmIChwYXRjaGVkT3B0aW9ucy5zbG93Q29ubmVjdGlvbkFmdGVyIDwgMCkge1xuICAgIGNvbnNvbGUud2FybignV2ViIENoYXQ6IFwic2xvd0Nvbm5lY3Rpb25BZnRlclwiIGNhbm5vdCBiZSBuZWdhdGl2ZSwgd2lsbCBzZXQgdG8gMC4nKTtcblxuICAgIHBhdGNoZWRPcHRpb25zLnNsb3dDb25uZWN0aW9uQWZ0ZXIgPSAwO1xuICB9XG5cbiAgcmV0dXJuIHBhdGNoZWRPcHRpb25zO1xufVxuIl19