"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _simpleUpdateIn = _interopRequireDefault(require("simple-update-in"));

var _createCustomEvent = _interopRequireDefault(require("./createCustomEvent"));

var _randomId = _interopRequireDefault(require("./randomId"));

var _useInternalMarkdownIt = _interopRequireDefault(require("../hooks/internal/useInternalMarkdownIt"));

var _useStyleToEmotionObject = _interopRequireDefault(require("../hooks/internal/useStyleToEmotionObject"));

var _walkMarkdownTokens = _interopRequireDefault(require("./walkMarkdownTokens"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var useStyleOptions = _botframeworkWebchatApi.hooks.useStyleOptions;

function replaceAnchorWithButton(markdownTokens) {
  return (0, _walkMarkdownTokens.default)(markdownTokens, function (markdownToken) {
    markdownToken = _objectSpread({}, markdownToken);

    switch (markdownToken.type) {
      case 'link_open':
        markdownToken.tag = 'button';
        markdownToken.attrs = [].concat(_toConsumableArray((0, _simpleUpdateIn.default)(markdownToken.attrs, [function (_ref) {
          var _ref2 = _slicedToArray(_ref, 2),
              name = _ref2[0],
              value = _ref2[1];

          return name === 'href' && value.startsWith('#');
        }], function (_ref3) {
          var _ref4 = _slicedToArray(_ref3, 2),
              value = _ref4[1];

          return ['data-markdown-href', value.substr(1)];
        })), [['type', 'button']]);
        break;

      case 'link_close':
        markdownToken.tag = 'button';
        break;

      default:
        break;
    }

    return markdownToken;
  });
}

var InlineMarkdown = function InlineMarkdown(_ref5) {
  var children = _ref5.children,
      onReference = _ref5.onReference,
      references = _ref5.references;

  if (typeof children !== 'string') {
    console.warn('botframework-webchat: "children" prop passed to <InlineMarkdown> must be of type string.');
    children = '';
  }

  var _useInternalMarkdownI = (0, _useInternalMarkdownIt.default)(),
      _useInternalMarkdownI2 = _slicedToArray(_useInternalMarkdownI, 1),
      markdownIt = _useInternalMarkdownI2[0];

  var _useStyleOptions = useStyleOptions(),
      _useStyleOptions2 = _slicedToArray(_useStyleOptions, 1),
      accent = _useStyleOptions2[0].accent;

  var styleToClassName = (0, _useStyleToEmotionObject.default)(); // We inlined the style here because this style is:
  // 1. Internal to Web Chat
  // 2. Not customizable from developers (other than setting `styleOptions.accent`)

  var className = (0, _react.useMemo)(function () {
    return styleToClassName({
      '& button[data-markdown-href]': {
        appearance: 'none',
        backgroundColor: 'transparent',
        border: 0,
        color: accent,
        cursor: 'pointer',
        fontFamily: 'inherit',
        fontSize: 'inherit',
        padding: 0
      }
    }) + '';
  }, [accent, styleToClassName]); // Markdown-It only support references in uppercase.

  references = references.map(function (reference) {
    return reference.toUpperCase();
  });

  var _references$reduce = references.reduce(function (_ref6, ref) {
    var hrefToRef = _ref6.hrefToRef,
        refToHref = _ref6.refToHref;
    var href = (0, _randomId.default)();
    return {
      hrefToRef: _objectSpread(_objectSpread({}, hrefToRef), {}, _defineProperty({}, href, ref)),
      refToHref: _objectSpread(_objectSpread({}, refToHref), {}, _defineProperty({}, ref, href))
    };
  }, {
    hrefToRef: {},
    refToHref: {}
  }),
      hrefToRef = _references$reduce.hrefToRef,
      refToHref = _references$reduce.refToHref;

  var html = (0, _react.useMemo)(function () {
    var tree = markdownIt.parseInline(children, {
      references: references.reduce(function (references, key) {
        return _objectSpread(_objectSpread({}, references), {}, _defineProperty({}, key, {
          href: "#".concat(refToHref[key])
        }));
      }, {})
    }); // Turn "<a href="#retry">Retry</a>" into "<button data-ref="retry" type="button">Retry</button>"

    var updatedTree = replaceAnchorWithButton(tree);
    return {
      __html: markdownIt.renderer.render(updatedTree)
    };
  }, [children, refToHref, markdownIt, references]);
  var handleClick = (0, _react.useCallback)(function (event) {
    event.stopPropagation();
    var href = event.target.getAttribute('data-markdown-href');
    href && onReference && onReference((0, _createCustomEvent.default)('reference', {
      data: hrefToRef[href]
    }));
  }, [hrefToRef, onReference]);
  return /*#__PURE__*/_react.default.createElement("span", {
    className: className,
    dangerouslySetInnerHTML: html,
    onClick: handleClick
  });
};

InlineMarkdown.defaultProps = {
  children: '',
  onReference: undefined,
  references: []
};
InlineMarkdown.propTypes = {
  children: _propTypes.default.string,
  onReference: _propTypes.default.func,
  references: _propTypes.default.arrayOf(_propTypes.default.string)
};
var _default = InlineMarkdown;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VdGlscy9JbmxpbmVNYXJrZG93bi5qcyJdLCJuYW1lcyI6WyJ1c2VTdHlsZU9wdGlvbnMiLCJob29rcyIsInJlcGxhY2VBbmNob3JXaXRoQnV0dG9uIiwibWFya2Rvd25Ub2tlbnMiLCJtYXJrZG93blRva2VuIiwidHlwZSIsInRhZyIsImF0dHJzIiwibmFtZSIsInZhbHVlIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsIklubGluZU1hcmtkb3duIiwiY2hpbGRyZW4iLCJvblJlZmVyZW5jZSIsInJlZmVyZW5jZXMiLCJjb25zb2xlIiwid2FybiIsIm1hcmtkb3duSXQiLCJhY2NlbnQiLCJzdHlsZVRvQ2xhc3NOYW1lIiwiY2xhc3NOYW1lIiwiYXBwZWFyYW5jZSIsImJhY2tncm91bmRDb2xvciIsImJvcmRlciIsImNvbG9yIiwiY3Vyc29yIiwiZm9udEZhbWlseSIsImZvbnRTaXplIiwicGFkZGluZyIsIm1hcCIsInJlZmVyZW5jZSIsInRvVXBwZXJDYXNlIiwicmVkdWNlIiwicmVmIiwiaHJlZlRvUmVmIiwicmVmVG9IcmVmIiwiaHJlZiIsImh0bWwiLCJ0cmVlIiwicGFyc2VJbmxpbmUiLCJrZXkiLCJ1cGRhdGVkVHJlZSIsIl9faHRtbCIsInJlbmRlcmVyIiwicmVuZGVyIiwiaGFuZGxlQ2xpY2siLCJldmVudCIsInN0b3BQcm9wYWdhdGlvbiIsInRhcmdldCIsImdldEF0dHJpYnV0ZSIsImRhdGEiLCJkZWZhdWx0UHJvcHMiLCJ1bmRlZmluZWQiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJmdW5jIiwiYXJyYXlPZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFFUUEsZSxHQUFvQkMsNkIsQ0FBcEJELGU7O0FBRVIsU0FBU0UsdUJBQVQsQ0FBaUNDLGNBQWpDLEVB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QUFFcUMsTUFBQUEsSUFBSSxFQUFFaEIsU0FBUyxDQUFDRSxJQUFEO0FBQWpCLEtBQS9CLENBQUQsQ0FBbEM7QUFDRCxHQVBpQixFQVFsQixDQUFDRixTQUFELEVBQVlyQixXQUFaLENBUmtCLENBQXBCO0FBV0Esc0JBQU87QUFBTSxJQUFBLFNBQVMsRUFBRU8sU0FBakI7QUFBNEIsSUFBQSx1QkFBdUIsRUFBRWlCLElBQXJEO0FBQTJELElBQUEsT0FBTyxFQUFFUTtBQUFwRSxJQUFQO0FBQ0QsQ0FwRUQ7O0FBc0VBbEMsY0FBYyxDQUFDd0MsWUFBZixHQUE4QjtBQUM1QnZDLEVBQUFBLFFBQVEsRUFBRSxFQURrQjtBQUU1QkMsRUFBQUEsV0FBVyxFQUFFdUMsU0FGZTtBQUc1QnRDLEVBQUFBLFVBQVUsRUFBRTtBQUhnQixDQUE5QjtBQU1BSCxjQUFjLENBQUMwQyxTQUFmLEdBQTJCO0FBQ3pCekMsRUFBQUEsUUFBUSxFQUFFMEMsbUJBQVVDLE1BREs7QUFFekIxQyxFQUFBQSxXQUFXLEVBQUV5QyxtQkFBVUUsSUFGRTtBQUd6QjFDLEVBQUFBLFVBQVUsRUFBRXdDLG1CQUFVRyxPQUFWLENBQWtCSCxtQkFBVUMsTUFBNUI7QUFIYSxDQUEzQjtlQU1lNUMsYyIsInNvdXJjZVJvb3QiOiJjb21wb25lbnQ6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IHJlYWN0L25vLWRhbmdlcjogXCJvZmZcIiAqL1xuXG5pbXBvcnQgeyBob29rcyB9IGZyb20gJ2JvdGZyYW1ld29yay13ZWJjaGF0LWFwaSc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VNZW1vIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHVwZGF0ZUluIGZyb20gJ3NpbXBsZS11cGRhdGUtaW4nO1xuXG5pbXBvcnQgY3JlYXRlQ3VzdG9tRXZlbnQgZnJvbSAnLi9jcmVhdGVDdXN0b21FdmVudCc7XG5pbXBvcnQgcmFuZG9tSWQgZnJvbSAnLi9yYW5kb21JZCc7XG5pbXBvcnQgdXNlSW50ZXJuYWxNYXJrZG93bkl0IGZyb20gJy4uL2hvb2tzL2ludGVybmFsL3VzZUludGVybmFsTWFya2Rvd25JdCc7XG5pbXBvcnQgdXNlU3R5bGVUb0Vtb3Rpb25PYmplY3QgZnJvbSAnLi4vaG9va3MvaW50ZXJuYWwvdXNlU3R5bGVUb0Vtb3Rpb25PYmplY3QnO1xuaW1wb3J0IHdhbGtNYXJrZG93blRva2VucyBmcm9tICcuL3dhbGtNYXJrZG93blRva2Vucyc7XG5cbmNvbnN0IHsgdXNlU3R5bGVPcHRpb25zIH0gPSBob29rcztcblxuZnVuY3Rpb24gcmVwbGFjZUFuY2hvcldpdGhCdXR0b24obWFya2Rvd25Ub2tlbnMpIHtcbiAgcmV0dXJuIHdhbGtNYXJrZG93blRva2VucyhtYXJrZG93blRva2VucywgbWFya2Rvd25Ub2tlbiA9PiB7XG4gICAgbWFya2Rvd25Ub2tlbiA9IHsgLi4ubWFya2Rvd25Ub2tlbiB9O1xuXG4gICAgc3dpdGNoIChtYXJrZG93blRva2VuLnR5cGUpIHtcbiAgICAgIGNhc2UgJ2xpbmtfb3Blbic6XG4gICAgICAgIG1hcmtkb3duVG9rZW4udGFnID0gJ2J1dHRvbic7XG4gICAgICAgIG1hcmtkb3duVG9rZW4uYXR0cnMgPSBbXG4gICAgICAgICAgLi4udXBkYXRlSW4oXG4gICAgICAgICAgICBtYXJrZG93blRva2VuLmF0dHJzLFxuICAgICAgICAgICAgWyhbbmFtZSwgdmFsdWVdKSA9PiBuYW1lID09PSAnaHJlZicgJiYgdmFsdWUuc3RhcnRzV2l0aCgnIycpXSxcbiAgICAgICAgICAgIChbLCB2YWx1ZV0pID0+IFsnZGF0YS1tYXJrZG93bi1ocmVmJywgdmFsdWUuc3Vic3RyKDEpXVxuICAgICAgICAgICksXG4gICAgICAgICAgWyd0eXBlJywgJ2J1dHRvbiddXG4gICAgICAgIF07XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdsaW5rX2Nsb3NlJzpcbiAgICAgICAgbWFya2Rvd25Ub2tlbi50YWcgPSAnYnV0dG9uJztcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiBtYXJrZG93blRva2VuO1xuICB9KTtcbn1cblxuY29uc3QgSW5saW5lTWFya2Rvd24gPSAoeyBjaGlsZHJlbiwgb25SZWZlcmVuY2UsIHJlZmVyZW5jZXMgfSkgPT4ge1xuICBpZiAodHlwZW9mIGNoaWxkcmVuICE9PSAnc3RyaW5nJykge1xuICAgIGNvbnNvbGUud2FybignYm90ZnJhbWV3b3JrLXdlYmNoYXQ6IFwiY2hpbGRyZW5cIiBwcm9wIHBhc3NlZCB0byA8SW5saW5lTWFya2Rvd24+IG11c3QgYmUgb2YgdHlwZSBzdHJpbmcuJyk7XG4gICAgY2hpbGRyZW4gPSAnJztcbiAgfVxuXG4gIGNvbnN0IFttYXJrZG93bkl0XSA9IHVzZUludGVybmFsTWFya2Rvd25JdCgpO1xuICBjb25zdCBbeyBhY2NlbnQgfV0gPSB1c2VTdHlsZU9wdGlvbnMoKTtcbiAgY29uc3Qgc3R5bGVUb0NsYXNzTmFtZSA9IHVzZVN0eWxlVG9FbW90aW9uT2JqZWN0KCk7XG5cbiAgLy8gV2UgaW5saW5lZCB0aGUgc3R5bGUgaGVyZSBiZWNhdXNlIHRoaXMgc3R5bGUgaXM6XG4gIC8vIDEuIEludGVybmFsIHRvIFdlYiBDaGF0XG4gIC8vIDIuIE5vdCBjdXN0b21pemFibGUgZnJvbSBkZXZlbG9wZXJzIChvdGhlciB0aGFuIHNldHRpbmcgYHN0eWxlT3B0aW9ucy5hY2NlbnRgKVxuICBjb25zdCBjbGFzc05hbWUgPSB1c2VNZW1vKFxuICAgICgpID0+XG4gICAgICBzdHlsZVRvQ2xhc3NOYW1lKHtcbiAgICAgICAgJyYgYnV0dG9uW2RhdGEtbWFya2Rvd24taHJlZl0nOiB7XG4gICAgICAgICAgYXBwZWFyYW5jZTogJ25vbmUnLFxuICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3RyYW5zcGFyZW50JyxcbiAgICAgICAgICBib3JkZXI6IDAsXG4gICAgICAgICAgY29sb3I6IGFjY2VudCxcbiAgICAgICAgICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgICAgICAgICBmb250RmFtaWx5OiAnaW5oZXJpdCcsXG4gICAgICAgICAgZm9udFNpemU6ICdpbmhlcml0JyxcbiAgICAgICAgICBwYWRkaW5nOiAwXG4gICAgICAgIH1cbiAgICAgIH0pICsgJycsXG4gICAgW2FjY2VudCwgc3R5bGVUb0NsYXNzTmFtZV1cbiAgKTtcblxuICAvLyBNYXJrZG93bi1JdCBvbmx5IHN1cHBvcnQgcmVmZXJlbmNlcyBpbiB1cHBlcmNhc2UuXG4gIHJlZmVyZW5jZXMgPSByZWZlcmVuY2VzLm1hcChyZWZlcmVuY2UgPT4gcmVmZXJlbmNlLnRvVXBwZXJDYXNlKCkpO1xuXG4gIGNvbnN0IHsgaHJlZlRvUmVmLCByZWZUb0hyZWYgfSA9IHJlZmVyZW5jZXMucmVkdWNlKFxuICAgICh7IGhyZWZUb1JlZiwgcmVmVG9IcmVmIH0sIHJlZikgPT4ge1xuICAgICAgY29uc3QgaHJlZiA9IHJhbmRvbUlkKCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhyZWZUb1JlZjogeyAuLi5ocmVmVG9SZWYsIFtocmVmXTogcmVmIH0sXG4gICAgICAgIHJlZlRvSHJlZjogeyAuLi5yZWZUb0hyZWYsIFtyZWZdOiBocmVmIH1cbiAgICAgIH07XG4gICAgfSxcbiAgICB7IGhyZWZUb1JlZjoge30sIHJlZlRvSHJlZjoge30gfVxuICApO1xuXG4gIGNvbnN0IGh0bWwgPSB1c2VNZW1vKCgpID0+IHtcbiAgICBjb25zdCB0cmVlID0gbWFya2Rvd25JdC5wYXJzZUlubGluZShjaGlsZHJlbiwge1xuICAgICAgcmVmZXJlbmNlczogcmVmZXJlbmNlcy5yZWR1Y2UoKHJlZmVyZW5jZXMsIGtleSkgPT4gKHsgLi4ucmVmZXJlbmNlcywgW2tleV06IHsgaHJlZjogYCMke3JlZlRvSHJlZltrZXldfWAgfSB9KSwge30pXG4gICAgfSk7XG5cbiAgICAvLyBUdXJuIFwiPGEgaHJlZj1cIiNyZXRyeVwiPlJldHJ5PC9hPlwiIGludG8gXCI8YnV0dG9uIGRhdGEtcmVmPVwicmV0cnlcIiB0eXBlPVwiYnV0dG9uXCI+UmV0cnk8L2J1dHRvbj5cIlxuICAgIGNvbnN0IHVwZGF0ZWRUcmVlID0gcmVwbGFjZUFuY2hvcldpdGhCdXR0b24odHJlZSk7XG5cbiAgICByZXR1cm4geyBfX2h0bWw6IG1hcmtkb3duSXQucmVuZGVyZXIucmVuZGVyKHVwZGF0ZWRUcmVlKSB9O1xuICB9LCBbY2hpbGRyZW4sIHJlZlRvSHJlZiwgbWFya2Rvd25JdCwgcmVmZXJlbmNlc10pO1xuXG4gIGNvbnN0IGhhbmRsZUNsaWNrID0gdXNlQ2FsbGJhY2soXG4gICAgZXZlbnQgPT4ge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgIGNvbnN0IGhyZWYgPSBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLW1hcmtkb3duLWhyZWYnKTtcblxuICAgICAgaHJlZiAmJiBvblJlZmVyZW5jZSAmJiBvblJlZmVyZW5jZShjcmVhdGVDdXN0b21FdmVudCgncmVmZXJlbmNlJywgeyBkYXRhOiBocmVmVG9SZWZbaHJlZl0gfSkpO1xuICAgIH0sXG4gICAgW2hyZWZUb1JlZiwgb25SZWZlcmVuY2VdXG4gICk7XG5cbiAgcmV0dXJuIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NOYW1lfSBkYW5nZXJvdXNseVNldElubmVySFRNTD17aHRtbH0gb25DbGljaz17aGFuZGxlQ2xpY2t9IC8+O1xufTtcblxuSW5saW5lTWFya2Rvd24uZGVmYXVsdFByb3BzID0ge1xuICBjaGlsZHJlbjogJycsXG4gIG9uUmVmZXJlbmNlOiB1bmRlZmluZWQsXG4gIHJlZmVyZW5jZXM6IFtdXG59O1xuXG5JbmxpbmVNYXJrZG93bi5wcm9wVHlwZXMgPSB7XG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBvblJlZmVyZW5jZTogUHJvcFR5cGVzLmZ1bmMsXG4gIHJlZmVyZW5jZXM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5zdHJpbmcpXG59O1xuXG5leHBvcnQgZGVmYXVsdCBJbmxpbmVNYXJrZG93bjtcbiJdfQ==