"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _reactScrollToBottom = require("react-scroll-to-bottom");

var _classnames = _interopRequireDefault(require("classnames"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _BasicTypingIndicator = _interopRequireDefault(require("./BasicTypingIndicator"));

var _Fade = _interopRequireDefault(require("./Utils/Fade"));

var _firstTabbableDescendant = _interopRequireDefault(require("./Utils/firstTabbableDescendant"));

var _getActivityUniqueId = _interopRequireDefault(require("./Utils/getActivityUniqueId"));

var _intersectionOf = _interopRequireDefault(require("./Utils/intersectionOf"));

var _isZeroOrPositive = _interopRequireDefault(require("./Utils/isZeroOrPositive"));

var _removeInline = _interopRequireDefault(require("./Utils/removeInline"));

var _ScreenReaderActivity = _interopRequireDefault(require("./ScreenReaderActivity"));

var _ScrollToEndButton = _interopRequireDefault(require("./Activity/ScrollToEndButton"));

var _Speak = _interopRequireDefault(require("./Activity/Speak"));

var _useFocus = _interopRequireDefault(require("./hooks/useFocus"));

var _useMemoize = _interopRequireDefault(require("./hooks/internal/useMemoize"));

var _useStyleSet5 = _interopRequireDefault(require("./hooks/useStyleSet"));

var _useStyleToEmotionObject = _interopRequireDefault(require("./hooks/internal/useStyleToEmotionObject"));

var _useTranscriptActivityElementsRef = _interopRequireDefault(require("./hooks/internal/useTranscriptActivityElementsRef"));

var _useTranscriptRootElementRef = _interopRequireDefault(require("./hooks/internal/useTranscriptRootElementRef"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var useActivities = _botframeworkWebchatApi.hooks.useActivities,
    useCreateActivityRenderer = _botframeworkWebchatApi.hooks.useCreateActivityRenderer,
    useCreateActivityStatusRenderer = _botframeworkWebchatApi.hooks.useCreateActivityStatusRenderer,
    useCreateAvatarRenderer = _botframeworkWebchatApi.hooks.useCreateAvatarRenderer,
    useDirection = _botframeworkWebchatApi.hooks.useDirection,
    useGroupActivities = _botframeworkWebchatApi.hooks.useGroupActivities,
    useLocalizer = _botframeworkWebchatApi.hooks.useLocalizer,
    useStyleOptions = _botframeworkWebchatApi.hooks.useStyleOptions;
var ROOT_STYLE = {
  '&.webchat__basic-transcript': {
    display: 'flex',
    flexDirection: 'column',
    overflow: 'hidden',
    // Make sure to set "position: relative" here to form another stacking context for the scroll-to-end button.
    // Stacking context help isolating elements that use "z-index" from global pollution.
    // https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context
    position: 'relative',
    '& .webchat__basic-transcript__filler': {
      flex: 1
    },
    '& .webchat__basic-transcript__scrollable': {
      display: 'flex',
      flexDirection: 'column',
      overflowX: 'hidden',
      WebkitOverflowScrolling: 'touch'
    },
    '& .webchat__basic-transcript__transcript': {
      listStyleType: 'none'
    }
  }
};

function nextSiblingAll(element) {
  var children = element.parentNode.children;
  var elementIndex = [].indexOf.call(children, element);
  return [].slice.call(children, elementIndex + 1);
}

function validateAllActivitiesTagged(activities, bins) {
  return activities.every(function (activity) {
    return bins.some(function (bin) {
      return bin.includes(activity);
    });
  });
}

var BasicTranscript = function BasicTranscript(_ref) {
  var className = _ref.className;

  var _useStyleSet = (0, _useStyleSet5.default)(),
      _useStyleSet2 = _slicedToArray(_useStyleSet, 1),
      activityStyleSet = _useStyleSet2[0].activity;

  var _useStyleOptions = useStyleOptions(),
      _useStyleOptions2 = _slicedToArray(_useStyleOptions, 1),
      _useStyleOptions2$ = _useStyleOptions2[0],
      bubbleFromUserNubOffset = _useStyleOptions2$.bubbleFromUserNubOffset,
      bubbleNubOffset = _useStyleOptions2$.bubbleNubOffset,
      groupTimestamp = _useStyleOptions2$.groupTimestamp,
      internalLiveRegionFadeAfter = _useStyleOptions2$.internalLiveRegionFadeAfter,
      showAvatarInGroup = _useStyleOptions2$.showAvatarInGroup;

  var _useActivities = useActivities(),
      _useActivities2 = _slicedToArray(_useActivities, 1),
      activities = _useActivities2[0];

  var _useTranscriptActivit = (0, _useTranscriptActivityElementsRef.default)(),
      _useTranscriptActivit2 = _slicedToArray(_useTranscriptActivit, 1),
      activityElementsRef = _useTranscriptActivit2[0];

  var _useDirection = useDirection(),
      _useDirection2 = _slicedToArray(_useDirection, 1),
      direction = _useDirection2[0];

  var _useTranscriptRootEle = (0, _useTranscriptRootElementRef.default)(),
      _useTranscriptRootEle2 = _slicedToArray(_useTranscriptRootEle, 1),
      rootElementRef = _useTranscriptRootEle2[0];

  var rootClassName = (0, _useStyleToEmotionObject.default)()(ROOT_STYLE) + '';
  var createActivityRenderer = useCreateActivityRenderer();
  var createActivityStatusRenderer = useCreateActivityStatusRenderer();
  var createAvatarRenderer = useCreateAvatarRenderer();
  var groupActivities = useGroupActivities();
  var hideAllTimestamps = groupTimestamp === false;
  var localize = useLocalizer();
  var activityAriaLabel = localize('ACTIVITY_ARIA_LABEL_ALT');
  var transcriptRoleDescription = localize('TRANSCRIPT_ARIA_ROLE_ALT'); // Gets renderer for every activity.
  // Activities that are not visible will return a falsy renderer.
  // Converted from createActivityRenderer({ activity, nextVisibleActivity }) to createActivityRenderer(activity, nextVisibleActivity).
  // This is for the memoization function to cache the arguments. Memoizer can only cache literal arguments.

  var createActivityRendererWithLiteralArgs = (0, _react.useCallback)(function (activity, nextVisibleActivity) {
    return createActivityRenderer({
      activity: activity,
      nextVisibleActivity: nextVisibleActivity
    });
  }, [createActivityRenderer]); // Create a memoized context of the createActivityRenderer function.

  var activitiesWithRenderer = (0, _useMemoize.default)(createActivityRendererWithLiteralArgs, function (createActivityRendererWithLiteralArgsMemoized) {
    // All calls to createActivityRendererWithLiteralArgsMemoized() in this function will be memoized (LRU = 1).
    // In the next render cycle, calls to createActivityRendererWithLiteralArgsMemoized() might return the memoized result instead.
    // This is an improvement to React useMemo(), because it only allows 1 memoization.
    // useMemoize() allows any number of memoization.
    var activitiesWithRenderer = [];
    var nextVisibleActivity;

    for (var index = activities.length - 1; index >= 0; index--) {
      var activity = activities[index];
      var renderActivity = createActivityRendererWithLiteralArgsMemoized(activity, nextVisibleActivity);

      if (renderActivity) {
        activitiesWithRenderer.splice(0, 0, {
          activity: activity,
          renderActivity: renderActivity
        });
        nextVisibleActivity = activity;
      }
    }

    return activitiesWithRenderer;
  }, [activities]);
  var visibleActivities = (0, _react.useMemo)(function () {
    return activitiesWithRenderer.map(function (_ref2) {
      var activity = _ref2.activity;
      return activity;
    });
  }, [activitiesWithRenderer]); // Tag activities based on types.
  // The default implementation tag into 2 types: sender and status.

  var _useMemo = (0, _react.useMemo)(function () {
    var _groupActivities = groupActivities({
      activities: visibleActivities
    }),
        activitiesGroupBySender = _groupActivities.sender,
        activitiesGroupByStatus = _groupActivities.status;

    if (!validateAllActivitiesTagged(visibleActivities, activitiesGroupBySender)) {
      console.warn('botframework-webchat: Not every activities are grouped in the "sender" property. Please fix "groupActivitiesMiddleware" and group every activities.');
    }

    if (!validateAllActivitiesTagged(visibleActivities, activitiesGroupByStatus)) {
      console.warn('botframework-webchat: Not every activities are grouped in the "status" property. Please fix "groupActivitiesMiddleware" and group every activities.');
    }

    return {
      activitiesGroupBySender: activitiesGroupBySender,
      activitiesGroupByStatus: activitiesGroupByStatus
    };
  }, [groupActivities, visibleActivities]),
      activitiesGroupBySender = _useMemo.activitiesGroupBySender,
      activitiesGroupByStatus = _useMemo.activitiesGroupByStatus; // Create a tree of activities with 2 dimensions: sender, followed by status.


  var activityTree = (0, _react.useMemo)(function () {
    var visibleActivitiesPendingGrouping = _toConsumableArray(visibleActivities);

    var activityTree = [];

    var _loop = function _loop() {
      var _visibleActivitiesPen = _slicedToArray(visibleActivitiesPendingGrouping, 1),
          activity = _visibleActivitiesPen[0];

      var senderTree = [];
      var activitiesWithSameSender = activitiesGroupBySender.find(function (activities) {
        return activities.includes(activity);
      });
      activityTree.push(senderTree);
      activitiesWithSameSender.forEach(function (activity) {
        var activitiesWithSameStatus = activitiesGroupByStatus.find(function (activities) {
          return activities.includes(activity);
        });
        var activitiesWithSameSenderAndStatus = (0, _intersectionOf.default)(visibleActivitiesPendingGrouping, activitiesWithSameSender, activitiesWithSameStatus);

        if (activitiesWithSameSenderAndStatus.length) {
          senderTree.push(activitiesWithSameSenderAndStatus);

          _removeInline.default.apply(void 0, [visibleActivitiesPendingGrouping].concat(_toConsumableArray(activitiesWithSameSenderAndStatus)));
        }
      });
    };

    while (visibleActivitiesPendingGrouping.length) {
      _loop();
    } // Assertion: All activities in visibleActivities, must be assigned to the activityTree


    if (!visibleActivities.every(function (activity) {
      return activityTree.some(function (activitiesWithSameSender) {
        return activitiesWithSameSender.some(function (activitiesWithSameSenderAndStatus) {
          return activitiesWithSameSenderAndStatus.includes(activity);
        });
      });
    })) {
      console.warn('botframework-webchat internal: Not all visible activities are grouped in the activityTree.', {
        visibleActivities: visibleActivities,
        activityTree: activityTree
      });
    }

    return activityTree;
  }, [activitiesGroupBySender, activitiesGroupByStatus, visibleActivities]); // Flatten the tree back into an array with information related to rendering.

  var renderingElements = (0, _react.useMemo)(function () {
    var renderingElements = [];
    var topSideBotNub = (0, _isZeroOrPositive.default)(bubbleNubOffset);
    var topSideUserNub = (0, _isZeroOrPositive.default)(bubbleFromUserNubOffset);
    activityTree.forEach(function (activitiesWithSameSender) {
      var _activitiesWithSameSe = _slicedToArray(activitiesWithSameSender, 1),
          _activitiesWithSameSe2 = _slicedToArray(_activitiesWithSameSe[0], 1),
          firstActivity = _activitiesWithSameSe2[0];

      var renderAvatar = createAvatarRenderer({
        activity: firstActivity
      });
      activitiesWithSameSender.forEach(function (activitiesWithSameSenderAndStatus, indexWithinSenderGroup) {
        var firstInSenderGroup = !indexWithinSenderGroup;
        var lastInSenderGroup = indexWithinSenderGroup === activitiesWithSameSender.length - 1;
        activitiesWithSameSenderAndStatus.forEach(function (activity, indexWithinSenderAndStatusGroup) {
          // We only show the timestamp at the end of the sender group. But we always show the "Send failed, retry" prompt.
          var renderActivityStatus = createActivityStatusRenderer({
            activity: activity
          });
          var firstInSenderAndStatusGroup = !indexWithinSenderAndStatusGroup;
          var lastInSenderAndStatusGroup = indexWithinSenderAndStatusGroup === activitiesWithSameSenderAndStatus.length - 1;

          var _activitiesWithRender = activitiesWithRenderer.find(function (entry) {
            return entry.activity === activity;
          }),
              renderActivity = _activitiesWithRender.renderActivity;

          var key = (0, _getActivityUniqueId.default)(activity) || renderingElements.length;
          var _activity$channelData = activity.channelData;
          _activity$channelData = _activity$channelData === void 0 ? {} : _activity$channelData;
          var _activity$channelData2 = _activity$channelData.messageBack;
          _activity$channelData2 = _activity$channelData2 === void 0 ? {} : _activity$channelData2;
          var messageBackDisplayText = _activity$channelData2.displayText,
              role = activity.from.role,
              text = activity.text;
          var topSideNub = role === 'user' ? topSideUserNub : topSideBotNub;
          var showCallout; // Depends on different "showAvatarInGroup" setting, we will show the avatar in different positions.

          if (showAvatarInGroup === 'sender') {
            if (topSideNub) {
              showCallout = firstInSenderGroup && firstInSenderAndStatusGroup;
            } else {
              showCallout = lastInSenderGroup && lastInSenderAndStatusGroup;
            }
          } else if (showAvatarInGroup === 'status') {
            if (topSideNub) {
              showCallout = firstInSenderAndStatusGroup;
            } else {
              showCallout = lastInSenderAndStatusGroup;
            }
          } else {
            showCallout = true;
          }

          renderingElements.push({
            activity: activity,
            // After the element is mounted, set it to activityElementsRef.
            callbackRef: function callbackRef(activityElement) {
              var entry = activityElementsRef.current.find(function (_ref3) {
                var activityID = _ref3.activityID;
                return activityID === activity.id;
              });

              if (entry) {
                entry.element = activityElement;
              }
            },
            // "hideTimestamp" is a render-time parameter for renderActivityStatus().
            // If true, it will hide the timestamp, but it will continue to show the
            // retry prompt. And show the screen reader version of the timestamp.
            hideTimestamp: hideAllTimestamps || indexWithinSenderAndStatusGroup !== activitiesWithSameSenderAndStatus.length - 1,
            key: key,
            // When "liveRegionKey" changes, it will show up in the live region momentarily.
            liveRegionKey: key + '|' + (messageBackDisplayText || text),
            renderActivity: renderActivity,
            renderActivityStatus: renderActivityStatus,
            renderAvatar: renderAvatar,
            // TODO: [P2] #2858 We should use core/definitions/speakingActivity for this predicate instead
            shouldSpeak: activity.channelData && activity.channelData.speak,
            showCallout: showCallout
          });
        });
      });
    });
    var activityElements = activityElementsRef.current; // Update activityElementRef with new sets of activity, while retaining the existing referencing element if exists.

    activityElementsRef.current = renderingElements.map(function (_ref4) {
      var id = _ref4.activity.id,
          key = _ref4.key;
      var existingEntry = activityElements.find(function (entry) {
        return entry.key === key;
      });
      return {
        activityID: id,
        element: existingEntry && existingEntry.element,
        key: key
      };
    });
    return renderingElements;
  }, [activitiesWithRenderer, activityElementsRef, activityTree, bubbleFromUserNubOffset, bubbleNubOffset, createActivityStatusRenderer, createAvatarRenderer, hideAllTimestamps, showAvatarInGroup]);
  var renderingActivities = (0, _react.useMemo)(function () {
    return renderingElements.map(function (_ref5) {
      var activity = _ref5.activity;
      return activity;
    });
  }, [renderingElements]);
  return /*#__PURE__*/_react.default.createElement("div", {
    className: (0, _classnames.default)('webchat__basic-transcript', rootClassName, (className || '') + ''),
    dir: direction,
    ref: rootElementRef
  }, /*#__PURE__*/_react.default.createElement("section", {
    "aria-atomic": false,
    "aria-live": "polite",
    "aria-relevant": "additions",
    "aria-roledescription": transcriptRoleDescription,
    role: "log"
  }, renderingElements.map(function (_ref6) {
    var activity = _ref6.activity,
        liveRegionKey = _ref6.liveRegionKey;
    return /*#__PURE__*/_react.default.createElement(_Fade.default, {
      fadeAfter: internalLiveRegionFadeAfter,
      key: liveRegionKey
    }, function () {
      return /*#__PURE__*/_react.default.createElement(_ScreenReaderActivity.default, {
        activity: activity
      });
    });
  })), /*#__PURE__*/_react.default.createElement(InternalTranscriptScrollable, {
    activities: renderingActivities
  }, renderingElements.map(function (_ref7) {
    var activity = _ref7.activity,
        callbackRef = _ref7.callbackRef,
        key = _ref7.key,
        hideTimestamp = _ref7.hideTimestamp,
        renderActivity = _ref7.renderActivity,
        renderActivityStatus = _ref7.renderActivityStatus,
        renderAvatar = _ref7.renderAvatar,
        shouldSpeak = _ref7.shouldSpeak,
        showCallout = _ref7.showCallout;
    return /*#__PURE__*/_react.default.createElement("li", {
      "aria-label": activityAriaLabel // This will be read when pressing CAPSLOCK + arrow with screen reader
      ,
      className: (0, _classnames.default)(activityStyleSet + '', 'webchat__basic-transcript__activity'),
      key: key,
      ref: callbackRef
    }, renderActivity({
      hideTimestamp: hideTimestamp,
      renderActivityStatus: renderActivityStatus,
      renderAvatar: renderAvatar,
      showCallout: showCallout
    }), shouldSpeak && /*#__PURE__*/_react.default.createElement(_Speak.default, {
      activity: activity
    }));
  })));
};

BasicTranscript.defaultProps = {
  className: ''
};
BasicTranscript.propTypes = {
  className: _propTypes.default.string
};

var InternalScreenReaderTranscript = function InternalScreenReaderTranscript(_ref8) {
  var renderingElements = _ref8.renderingElements;
  var localize = useLocalizer();

  var _useStyleOptions3 = useStyleOptions(),
      _useStyleOptions4 = _slicedToArray(_useStyleOptions3, 1),
      internalLiveRegionFadeAfter = _useStyleOptions4[0];

  var transcriptRoleDescription = localize('TRANSCRIPT_ARIA_ROLE_ALT');
  return /*#__PURE__*/_react.default.createElement("section", {
    "aria-atomic": false,
    "aria-live": "polite",
    "aria-relevant": "additions",
    "aria-roledescription": transcriptRoleDescription,
    role: "log"
  }, renderingElements.map(function (_ref9) {
    var activity = _ref9.activity,
        liveRegionKey = _ref9.liveRegionKey;
    return /*#__PURE__*/_react.default.createElement(_Fade.default, {
      fadeAfter: internalLiveRegionFadeAfter,
      key: liveRegionKey
    }, function () {
      return /*#__PURE__*/_react.default.createElement(_ScreenReaderActivity.default, {
        activity: activity
      });
    });
  }));
};

InternalScreenReaderTranscript.propTypes = {
  renderingElements: _propTypes.default.arrayOf(_propTypes.default.shape({
    activity: _propTypes.default.any,
    liveRegionKey: _propTypes.default.string
  })).isRequired
}; // Separating high-frequency hooks to improve performance.

var InternalTranscriptScrollable = function InternalTranscriptScrollable(_ref10) {
  var activities = _ref10.activities,
      children = _ref10.children;

  var _useStyleSet3 = (0, _useStyleSet5.default)(),
      _useStyleSet4 = _slicedToArray(_useStyleSet3, 1),
      activitiesStyleSet = _useStyleSet4[0].activities;

  var _useStyleOptions5 = useStyleOptions(),
      _useStyleOptions6 = _slicedToArray(_useStyleOptions5, 1),
      hideScrollToEndButton = _useStyleOptions6[0].hideScrollToEndButton;

  var _useAnimatingToEnd = (0, _reactScrollToBottom.useAnimatingToEnd)(),
      _useAnimatingToEnd2 = _slicedToArray(_useAnimatingToEnd, 1),
      animatingToEnd = _useAnimatingToEnd2[0];

  var _useSticky = (0, _reactScrollToBottom.useSticky)(),
      _useSticky2 = _slicedToArray(_useSticky, 1),
      sticky = _useSticky2[0];

  var focus = (0, _useFocus.default)();
  var lastVisibleActivityId = (0, _getActivityUniqueId.default)(activities[activities.length - 1] || {}); // Activity ID of the last visible activity in the list.

  var localize = useLocalizer();
  var scrollToEndButtonRef = (0, _react.useRef)();
  var lastReadActivityIdRef = (0, _react.useRef)(lastVisibleActivityId);
  var transcriptRoleDescription = localize('TRANSCRIPT_ARIA_ROLE_ALT');
  var allActivitiesRead = lastVisibleActivityId === lastReadActivityIdRef.current;
  var handleScrollToEndButtonClick = (0, _react.useCallback)(function () {
    var current = scrollToEndButtonRef.current; // After clicking on the "New messages" button, we should focus on the first unread element.
    // This is for resolving the bug https://github.com/microsoft/BotFramework-WebChat/issues/3135.

    if (current) {
      var nextSiblings = nextSiblingAll(current);
      var firstUnreadTabbable = nextSiblings.reduce(function (result, unreadActivityElement) {
        return result || (0, _firstTabbableDescendant.default)(unreadActivityElement);
      }, 0);
      firstUnreadTabbable ? firstUnreadTabbable.focus() : focus('sendBoxWithoutKeyboard');
    }
  }, [focus, scrollToEndButtonRef]);

  if (sticky) {
    // If it is sticky, the user is at the bottom of the transcript, everything is read.
    // So mark the activity ID as read.
    lastReadActivityIdRef.current = lastVisibleActivityId;
  } // Finds where we should render the "New messages" button, in index. Returns -1 to hide the button.


  var renderSeparatorAfterIndex = (0, _react.useMemo)(function () {
    // Don't show the button if:
    // - All activities have been read
    // - Currently animating towards bottom
    //   - "New messages" button must not flash when: 1. Type "help", 2. Scroll to top, 3. Type "help" again, 4. Expect the "New messages" button not flashy
    // - Hidden by style options
    // - It is already at the bottom (sticky)
    // Any changes to this logic, verify:
    // - "New messages" button should persist while programmatically scrolling to mid-point of the transcript:
    //   1. Type "help"
    //   2. Type "proactive", then immediately scroll to top
    //      Expect: the "New messages" button should appear
    //   3. Run hook "useScrollTo({ scrollTop: 500 })"
    //      Expect: when the scroll is animating to 500px, the "New messages" button should kept on the screen
    // - "New messages" button must not flashy:
    //   1. Type "help"
    //   2. Scroll to top
    //      Expect: no "New messages" button is shown
    //   3. Type "help" again
    //      Expect: "New messages" button must not flash-appear
    if (allActivitiesRead || animatingToEnd || hideScrollToEndButton || sticky) {
      return -1;
    }

    return activities.findIndex(function (activity) {
      return (0, _getActivityUniqueId.default)(activity) === lastReadActivityIdRef.current;
    });
  }, [activities, allActivitiesRead, animatingToEnd, hideScrollToEndButton, lastReadActivityIdRef, sticky]);
  return /*#__PURE__*/_react.default.createElement(_reactScrollToBottom.Panel, {
    className: "webchat__basic-transcript__scrollable"
  }, /*#__PURE__*/_react.default.createElement("div", {
    "aria-hidden": true,
    className: "webchat__basic-transcript__filler"
  }), /*#__PURE__*/_react.default.createElement("ul", {
    "aria-roledescription": transcriptRoleDescription,
    className: (0, _classnames.default)(activitiesStyleSet + '', 'webchat__basic-transcript__transcript'),
    role: "list"
  }, _react.default.Children.map(children, function (child, index) {
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, child, index === renderSeparatorAfterIndex && /*#__PURE__*/_react.default.createElement(_ScrollToEndButton.default, {
      "aria-valuemax": activities.length,
      "aria-valuenow": index + 1,
      onClick: handleScrollToEndButtonClick,
      ref: scrollToEndButtonRef
    }));
  })), /*#__PURE__*/_react.default.createElement(_BasicTypingIndicator.default, null));
};

InternalTranscriptScrollable.propTypes = {
  activities: _propTypes.default.array.isRequired,
  children: _propTypes.default.arrayOf(_propTypes.default.element).isRequired
};
var _default = BasicTranscript;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9CYXNpY1RyYW5zY3JpcHQuanMiXSwibmFtZXMiOlsidXNlQWN0aXZpdGllcyIsImhvb2tzIiwidXNlQ3JlYXRlQWN0aXZpdHlSZW5kZXJlciIsInVzZUNyZWF0ZUFjdGl2aXR5U3RhdHVzUmVuZGVyZXIiLCJ1c2VDcmVhdGVBdmF0YXJSZW5kZXJlciIsInVzZURpcmVjdGlvbiIsInVzZUdyb3VwQWN0aXZpdGllcyIsInVzZUxvY2FsaXplciIsInVzZVN0eWxlT3B0aW9ucyIsIlJPT1RfU1RZTEUiLCJkaXNwbGF5IiwiZmxleERpcmVjdGlvbiIsIm92ZXJmbG93IiwicG9zaXRpb24iLCJmbGV4Iiwib3ZlcmZsb3dYIiwiV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmciLCJsaXN0U3R5bGVUeXBlIiwibmV4dFNpYmxpbmdBbGwiLCJlbGVtZW50IiwiY2hpbGRyZW4iLCJwYXJlbnROb2RlIiwiZWxlbWVudEluZGV4IiwiaW5kZXhPZiIsImNhbGwiLCJzbGljZSIsInZhbGlkYXRlQWxsQWN0aXZpdGllc1RhZ2dlZCIsImFjdGl2aXRpZXMiLCJiaW5zIiwiZXZlcnkiLCJhY3Rpdml0eSIsInNvbWUiLCJiaW4iLCJpbmNsdWRlcyIsIkJhc2ljVHJhbnNjcmlwdCIsImNsYXNzTmFtZSIsImFjdGl2aXR5U3R5bGVTZXQiLCJidWJibGVGcm9tVXNlck51Yk9mZnNldCIsImJ1YmJsZU51Yk9mZnNldCIsImdyb3VwVGltZXN0YW1wIiwiaW50ZXJuYWxMaXZlUmVnaW9uRmFkZUFmdGVyIiwic2hvd0F2YXRhckluR3JvdXAiLCJhY3Rpdml0eUVsZW1lbnRzUmVmIiwiZGlyZWN0aW9uIiwicm9vdEVsZW1lbnRSZWYiLCJyb290Q2xhc3NOYW1lIiwiY3JlYXRlQWN0aXZpdHlSZW5kZXJlciIsImNyZWF0ZUFjdGl2aXR5U3RhdHVzUmVuZGVyZXIiLCJjcmVhdGVBdmF0YXJSZW5kZXJlciIsImdyb3VwQWN0aXZpdGllcyIsImhpZGVBbGxUaW1lc3RhbXBzIiwibG9jYWxpemUiLCJhY3Rpdml0eUFyaWFMYWJlbCIsInRyYW5zY3JpcHRSb2xlRGVzY3JpcHRpb24iLCJjcmVhdGVBY3Rpdml0eVJlbmRlcmVyV2l0aExpdGVyYWxBcmdzIiwibmV4dFZpc2libGVBY3Rpdml0eSIsImFjdGl2aXRpZXNXaXRoUmVuZGVyZXIiLCJjcmVhdGVBY3Rpdml0eVJlbmRlcmVyV2l0aExpdGVyYWxBcmdzTWVtb2l6ZWQiLCJpbmRleCIsImxlbmd0aCIsInJlbmRlckFjdGl2aXR5Iiwic3BsaWNlIiwidmlzaWJsZUFjdGl2aXRpZXMiLCJtYXAiLCJhY3Rpdml0aWVzR3JvdXBCeVNlbmRlciIsInNlbmRlciIsImFjdGl2aXRpZXNHcm91cEJ5U3RhdHVzIiwic3RhdHVzIiwiY29uc29sZSIsIndhcm4iLCJhY3Rpdml0eVRyZWUiLCJ2aXNpYmxlQWN0aXZpdGllc1BlbmRpbmdHcm91cGluZyIsInNlbmRlclRyZWUiLCJhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXIiLCJmaW5kIiwicHVzaCIsImZvckVhY2giLCJhY3Rpdml0aWVzV2l0aFNhbWVTdGF0dXMiLCJhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMiLCJyZW1vdmVJbmxpbmUiLCJyZW5kZXJpbmdFbGVtZW50cyIsInRvcFNpZGVCb3ROdWIiLCJ0b3BTaWRlVXNlck51YiIsImZpcnN0QWN0aXZpdHkiLCJyZW5kZXJBdmF0YXIiLCJpbmRleFdpdGhpblNlbmRlckdyb3VwIiwiZmlyc3RJblNlbmRlckdyb3VwIiwibGFzdEluU2VuZGVyR3JvdXAiLCJpbmRleFdpdGhpblNlbmRlckFuZFN0YXR1c0dyb3VwIiwicmVuZGVyQWN0aXZpdHlTdGF0dXMiLCJmaXJzdEluU2VuZGVyQW5kU3RhdHVzR3JvdXAiLCJsYXN0SW5TZW5kZXJBbmRTdGF0dXNHcm91cCIsImVudHJ5Iiwia2V5IiwiY2hhbm5lbERhdGEiLCJtZXNzYWdlQmFjayIsIm1lc3NhZ2VCYWNrRGlzcGxheVRleHQiLCJkaXNwbGF5VGV4dCIsInJvbGUiLCJmcm9tIiwidGV4dCIsInRvcFNpZGVOdWIiLCJzaG93Q2FsbG91dCIsImNhbGxiYWNrUmVmIiwiYWN0aXZpdHlFbGVtZW50IiwiY3VycmVudCIsImFjdGl2aXR5SUQiLCJpZCIsImhpZGVUaW1lc3RhbXAiLCJsaXZlUmVnaW9uS2V5Iiwic2hvdWxkU3BlYWsiLCJzcGVhayIsImFjdGl2aXR5RWxlbWVudHMiLCJleGlzdGluZ0VudHJ5IiwicmVuZGVyaW5nQWN0aXZpdGllcyIsImRlZmF1bHRQcm9wcyIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsInN0cmluZyIsIkludGVybmFsU2NyZWVuUmVhZGVyVHJhbnNjcmlwdCIsImFycmF5T2YiLCJzaGFwZSIsImFueSIsImlzUmVxdWlyZWQiLCJJbnRlcm5hbFRyYW5zY3JpcHRTY3JvbGxhYmxlIiwiYWN0aXZpdGllc1N0eWxlU2V0IiwiaGlkZVNjcm9sbFRvRW5kQnV0dG9uIiwiYW5pbWF0aW5nVG9FbmQiLCJzdGlja3kiLCJmb2N1cyIsImxhc3RWaXNpYmxlQWN0aXZpdHlJZCIsInNjcm9sbFRvRW5kQnV0dG9uUmVmIiwibGFzdFJlYWRBY3Rpdml0eUlkUmVmIiwiYWxsQWN0aXZpdGllc1JlYWQiLCJoYW5kbGVTY3JvbGxUb0VuZEJ1dHRvbkNsaWNrIiwibmV4dFNpYmxpbmdzIiwiZmlyc3RVbnJlYWRUYWJiYWJsZSIsInJlZHVjZSIsInJlc3VsdCIsInVucmVhZEFjdGl2aXR5RWxlbWVudCIsInJlbmRlclNlcGFyYXRvckFmdGVySW5kZXgiLCJmaW5kSW5kZXgiLCJSZWFjdCIsIkNoaWxkcmVuIiwiY2hpbGQiLCJhcnJheSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFHRUEsYSxHQVFFQyw2QixDQVJGRCxhO0lBQ0FFLHlCLEdBT0VELDZCLENBUEZDLHlCO0lBQ0FDLCtCLEdBTUVGLDZCLENBTkZFLCtCO0lBQ0FDLHVCLEdBS0VILDZCLENBTEZHLHVCO0lBQ0FDLFksR0FJRUosNkIsQ0FKRkksWTtJQUNBQyxrQixHQUdFTCw2QixDQUhGSyxrQjtJQUNBQyxZLEdBRUVOLDZCLENBRkZNLFk7SUFDQUMsZSxHQUNFUCw2QixDQURGTyxlO0FBR0YsSUFBTUMsVUFBVSxHQUFHO0FBQ2pCLGlDQUErQjtBQUM3QkMsSUFBQUEsT0FBTyxFQUFFLE1BRG9CO0FBRTdCQyxJQUFBQSxhQUFhLEVBQUUsUUFGYztBQUc3QkMsSUFBQUEsUUFBUSxFQUFFLFFBSG1CO0FBSTdCO0FBQ0E7QUFDQTtBQUNBQyxJQUFBQSxRQUFRLEVBQUUsVUFQbUI7QUFTN0IsNENBQXdDO0FBQ3RDQyxNQUFBQSxJQUFJLEVBQUU7QUFEZ0MsS0FUWDtBQWE3QixnREFBNEM7QUFDMUNKLE1BQUFBLE9BQU8sRUFBRSxNQURpQztBQUUxQ0MsTUFBQUEsYUFBYSxFQUFFLFFBRjJCO0FBRzFDSSxNQUFBQSxTQUFTLEVBQUUsUUFIK0I7QUFJMUNDLE1BQUFBLHVCQUF1QixFQUFFO0FBSmlCLEtBYmY7QUFvQjdCLGdEQUE0QztBQUMxQ0MsTUFBQUEsYUFBYSxFQUFFO0FBRDJCO0FBcEJmO0FBRGQsQ0FBbkI7O0FBMkJBLFNBQVNDLGNBQVQsQ0FBd0JDLE9BQXhCLEVBQWlDO0FBQUEsTUFFZkMsUUFGZSxHQUczQkQsT0FIMkIsQ0FFN0JFLFVBRjZCLENBRWZELFFBRmU7QUFLL0IsTUFBTUUsWUFBWSxHQUFHLEdBQUdDLE9BQUgsQ0FBV0MsSUFBWCxDQUFnQkosUUFBaEIsRUFBMEJELE9BQTFCLENBQXJCO0FBRUEsU0FBTyxHQUFHTSxLQUFILENBQVNELElBQVQsQ0FBY0osUUFBZCxFQUF3QkUsWUFBWSxHQUFHLENBQXZDLENBQVA7QUFDRDs7QUFFRCxTQUFTSSwyQkFBVCxDQUFxQ0MsVUFBckMsRUFBaURDLElBQWpELEVBQXVEO0FBQ3JELFNBQU9ELFVBQVUsQ0FBQ0UsS0FBWCxDQUFpQixVQUFBQyxRQUFRO0FBQUEsV0FBSUYsSUFBSSxDQUFDRyxJQUFMLENBQVUsVUFBQUMsR0FBRztBQUFBLGFBQUlBLEdBQUcsQ0FBQ0MsUUFBSixDQUFhSCxRQUFiLENBQUo7QUFBQSxLQUFiLENBQUo7QUFBQSxHQUF6QixDQUFQO0FBQ0Q7O0FBRUQsSUFBTUksZUFBZSxHQUFHLFNBQWxCQSxlQUFrQixPQUFtQjtBQUFBLE1BQWhCQyxTQUFnQixRQUFoQkEsU0FBZ0I7O0FBQUEscUJBQ0EsNEJBREE7QUFBQTtBQUFBLE1BQ3RCQyxnQkFEc0Isb0JBQ2hDTixRQURnQzs7QUFBQSx5QkFJckN0QixlQUFlLEVBSnNCO0FBQUE7QUFBQTtBQUFBLE1BR3JDNkIsdUJBSHFDLHNCQUdyQ0EsdUJBSHFDO0FBQUEsTUFHWkMsZUFIWSxzQkFHWkEsZUFIWTtBQUFBLE1BR0tDLGNBSEwsc0JBR0tBLGNBSEw7QUFBQSxNQUdxQkMsMkJBSHJCLHNCQUdxQkEsMkJBSHJCO0FBQUEsTUFHa0RDLGlCQUhsRCxzQkFHa0RBLGlCQUhsRDs7QUFBQSx1QkFLcEJ6QyxhQUFhLEVBTE87QUFBQTtBQUFBLE1BS2xDMkIsVUFMa0M7O0FBQUEsOEJBTVgsZ0RBTlc7QUFBQTtBQUFBLE1BTWxDZSxtQkFOa0M7O0FBQUEsc0JBT3JCckMsWUFBWSxFQVBTO0FBQUE7QUFBQSxNQU9sQ3NDLFNBUGtDOztBQUFBLDhCQVFoQiwyQ0FSZ0I7QUFBQTtBQUFBLE1BUWxDQyxjQVJrQzs7QUFTekMsTUFBTUMsYUFBYSxHQUFHLHdDQUEwQnBDLFVBQTFCLElBQXdDLEVBQTlEO0FBRUEsTUFBTXFDLHNCQUFzQixHQUFHNUMseUJBQXlCLEVBQXhEO0FBQ0EsTUFBTTZDLDRCQUE0QixHQUFHNUMsK0JBQStCLEVBQXBFO0FBQ0EsTUFBTTZDLG9CQUFvQixHQUFHNUMsdUJBQXVCLEVBQXBEO0FBQ0EsTUFBTTZDLGVBQWUsR0FBRzNDLGtCQUFrQixFQUExQztBQUNBLE1BQU00QyxpQkFBaUIsR0FBR1gsY0FBYyxLQUFLLEtBQTdDO0FBQ0EsTUFBTVksUUFBUSxHQUFHNUMsWUFBWSxFQUE3QjtBQUVBLE1BQU02QyxpQkFBaUIsR0FBR0QsUUFBUSxDQUFDLHlCQUFELENBQWxDO0FBQ0EsTUFBTUUseUJBQXlCLEdBQUdGLFFBQVEsQ0FBQywwQkFBRCxDQUExQyxDQW5CeUMsQ0FxQnpDO0FBQ0E7QUFFQTtBQUNBOztBQUNBLE1BQU1HLHFDQUFxQyxHQUFHLHdCQUM1QyxVQUFDeEIsUUFBRCxFQUFXeUIsbUJBQVg7QUFBQSxXQUFtQ1Qsc0JBQXNCLENBQUM7QUFBRWhCLE1BQUFBLFFBQVEsRUFBUkEsUUFBRjtBQUFZeUIsTUFBQUEsbUJBQW1CLEVBQW5CQTtBQUFaLEtBQUQsQ0FBekQ7QUFBQSxHQUQ0QyxFQUU1QyxDQUFDVCxzQkFBRCxDQUY0QyxDQUE5QyxDQTFCeUMsQ0ErQnpDOztBQUNBLE1BQU1VLHNCQUFzQixHQUFHLHlCQUM3QkYscUNBRDZCLEVBRTdCLFVBQUFHLDZDQUE2QyxFQUFJO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBRUEsUUFBTUQsc0JBQXNCLEdBQUcsRUFBL0I7QUFDQSxRQUFJRCxtQkFBSjs7QUFFQSxTQUFLLElBQUlHLEtBQUssR0FBRy9CLFVBQVUsQ0FBQ2dDLE1BQVgsR0FBb0IsQ0FBckMsRUFBd0NELEtBQUssSUFBSSxDQUFqRCxFQUFvREEsS0FBSyxFQUF6RCxFQUE2RDtBQUMzRCxVQUFNNUIsUUFBUSxHQUFHSCxVQUFVLENBQUMrQixLQUFELENBQTNCO0FBQ0EsVUFBTUUsY0FBYyxHQUFHSCw2Q0FBNkMsQ0FBQzNCLFFBQUQsRUFBV3lCLG1CQUFYLENBQXBFOztBQUVBLFVBQUlLLGNBQUosRUFBb0I7QUFDbEJKLFFBQUFBLHNCQUFzQixDQUFDSyxNQUF2QixDQUE4QixDQUE5QixFQUFpQyxDQUFqQyxFQUFvQztBQUNsQy9CLFVBQUFBLFFBQVEsRUFBUkEsUUFEa0M7QUFFbEM4QixVQUFBQSxjQUFjLEVBQWRBO0FBRmtDLFNBQXBDO0FBS0FMLFFBQUFBLG1CQUFtQixHQUFHekIsUUFBdEI7QUFDRDtBQUNGOztBQUVELFdBQU8wQixzQkFBUDtBQUNELEdBMUI0QixFQTJCN0IsQ0FBQzdCLFVBQUQsQ0EzQjZCLENBQS9CO0FBOEJBLE1BQU1tQyxpQkFBaUIsR0FBRyxvQkFBUTtBQUFBLFdBQU1OLHNCQUFzQixDQUFDTyxHQUF2QixDQUEyQjtBQUFBLFVBQUdqQyxRQUFILFNBQUdBLFFBQUg7QUFBQSxhQUFrQkEsUUFBbEI7QUFBQSxLQUEzQixDQUFOO0FBQUEsR0FBUixFQUFzRSxDQUM5RjBCLHNCQUQ4RixDQUF0RSxDQUExQixDQTlEeUMsQ0FrRXpDO0FBQ0E7O0FBbkV5QyxpQkFxRW9CLG9CQUFRLFlBQU07QUFBQSwyQkFDSVAsZUFBZSxDQUFDO0FBQzNGdEIsTUFBQUEsVUFBVSxFQUFFbUM7QUFEK0UsS0FBRCxDQURuQjtBQUFBLFFBQ3pERSx1QkFEeUQsb0JBQ2pFQyxNQURpRTtBQUFBLFFBQ3hCQyx1QkFEd0Isb0JBQ2hDQyxNQURnQzs7QUFLekUsUUFBSSxDQUFDekMsMkJBQTJCLENBQUNvQyxpQkFBRCxFQUFvQkUsdUJBQXBCLENBQWhDLEVBQThFO0FBQzVFSSxNQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRSxxSkFERjtBQUdEOztBQUVELFFBQUksQ0FBQzNDLDJCQUEyQixDQUFDb0MsaUJBQUQsRUFBb0JJLHVCQUFwQixDQUFoQyxFQUE4RTtBQUM1RUUsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0UscUpBREY7QUFHRDs7QUFFRCxXQUFPO0FBQ0xMLE1BQUFBLHVCQUF1QixFQUF2QkEsdUJBREs7QUFFTEUsTUFBQUEsdUJBQXVCLEVBQXZCQTtBQUZLLEtBQVA7QUFJRCxHQXJCNEQsRUFxQjFELENBQUNqQixlQUFELEVBQWtCYSxpQkFBbEIsQ0FyQjBELENBckVwQjtBQUFBLE1BcUVqQ0UsdUJBckVpQyxZQXFFakNBLHVCQXJFaUM7QUFBQSxNQXFFUkUsdUJBckVRLFlBcUVSQSx1QkFyRVEsRUE0RnpDOzs7QUFFQSxNQUFNSSxZQUFZLEdBQUcsb0JBQVEsWUFBTTtBQUNqQyxRQUFNQyxnQ0FBZ0Msc0JBQU9ULGlCQUFQLENBQXRDOztBQUNBLFFBQU1RLFlBQVksR0FBRyxFQUFyQjs7QUFGaUM7QUFBQSxpREFLWkMsZ0NBTFk7QUFBQSxVQUt4QnpDLFFBTHdCOztBQU0vQixVQUFNMEMsVUFBVSxHQUFHLEVBQW5CO0FBQ0EsVUFBTUMsd0JBQXdCLEdBQUdULHVCQUF1QixDQUFDVSxJQUF4QixDQUE2QixVQUFBL0MsVUFBVTtBQUFBLGVBQUlBLFVBQVUsQ0FBQ00sUUFBWCxDQUFvQkgsUUFBcEIsQ0FBSjtBQUFBLE9BQXZDLENBQWpDO0FBRUF3QyxNQUFBQSxZQUFZLENBQUNLLElBQWIsQ0FBa0JILFVBQWxCO0FBRUFDLE1BQUFBLHdCQUF3QixDQUFDRyxPQUF6QixDQUFpQyxVQUFBOUMsUUFBUSxFQUFJO0FBQzNDLFlBQU0rQyx3QkFBd0IsR0FBR1gsdUJBQXVCLENBQUNRLElBQXhCLENBQTZCLFVBQUEvQyxVQUFVO0FBQUEsaUJBQUlBLFVBQVUsQ0FBQ00sUUFBWCxDQUFvQkgsUUFBcEIsQ0FBSjtBQUFBLFNBQXZDLENBQWpDO0FBRUEsWUFBTWdELGlDQUFpQyxHQUFHLDZCQUN4Q1AsZ0NBRHdDLEVBRXhDRSx3QkFGd0MsRUFHeENJLHdCQUh3QyxDQUExQzs7QUFNQSxZQUFJQyxpQ0FBaUMsQ0FBQ25CLE1BQXRDLEVBQThDO0FBQzVDYSxVQUFBQSxVQUFVLENBQUNHLElBQVgsQ0FBZ0JHLGlDQUFoQjs7QUFDQUMsK0NBQWFSLGdDQUFiLDRCQUFrRE8saUNBQWxEO0FBQ0Q7QUFDRixPQWJEO0FBWCtCOztBQUlqQyxXQUFPUCxnQ0FBZ0MsQ0FBQ1osTUFBeEMsRUFBZ0Q7QUFBQTtBQXFCL0MsS0F6QmdDLENBMkJqQzs7O0FBQ0EsUUFDRSxDQUFDRyxpQkFBaUIsQ0FBQ2pDLEtBQWxCLENBQXdCLFVBQUFDLFFBQVE7QUFBQSxhQUMvQndDLFlBQVksQ0FBQ3ZDLElBQWIsQ0FBa0IsVUFBQTBDLHdCQUF3QjtBQUFBLGVBQ3hDQSx3QkFBd0IsQ0FBQzFDLElBQXpCLENBQThCLFVBQUErQyxpQ0FBaUM7QUFBQSxpQkFDN0RBLGlDQUFpQyxDQUFDN0MsUUFBbEMsQ0FBMkNILFFBQTNDLENBRDZEO0FBQUEsU0FBL0QsQ0FEd0M7QUFBQSxPQUExQyxDQUQrQjtBQUFBLEtBQWhDLENBREgsRUFRRTtBQUNBc0MsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQWEsNEZBQWIsRUFBMkc7QUFDekdQLFFBQUFBLGlCQUFpQixFQUFqQkEsaUJBRHlHO0FBRXpHUSxRQUFBQSxZQUFZLEVBQVpBO0FBRnlHLE9BQTNHO0FBSUQ7O0FBRUQsV0FBT0EsWUFBUDtBQUNELEdBNUNvQixFQTRDbEIsQ0FBQ04sdUJBQUQsRUFBMEJFLHVCQUExQixFQUFtREosaUJBQW5ELENBNUNrQixDQUFyQixDQTlGeUMsQ0E0SXpDOztBQUVBLE1BQU1rQixpQkFBaUIsR0FBRyxvQkFBUSxZQUFNO0FBQ3RDLFFBQU1BLGlCQUFpQixHQUFHLEVBQTFCO0FBQ0EsUUFBTUMsYUFBYSxHQUFHLCtCQUFpQjNDLGVBQWpCLENBQXRCO0FBQ0EsUUFBTTRDLGNBQWMsR0FBRywrQkFBaUI3Qyx1QkFBakIsQ0FBdkI7QUFFQWlDLElBQUFBLFlBQVksQ0FBQ00sT0FBYixDQUFxQixVQUFBSCx3QkFBd0IsRUFBSTtBQUFBLGlEQUNyQkEsd0JBRHFCO0FBQUE7QUFBQSxVQUN2Q1UsYUFEdUM7O0FBRS9DLFVBQU1DLFlBQVksR0FBR3BDLG9CQUFvQixDQUFDO0FBQUVsQixRQUFBQSxRQUFRLEVBQUVxRDtBQUFaLE9BQUQsQ0FBekM7QUFFQVYsTUFBQUEsd0JBQXdCLENBQUNHLE9BQXpCLENBQWlDLFVBQUNFLGlDQUFELEVBQW9DTyxzQkFBcEMsRUFBK0Q7QUFDOUYsWUFBTUMsa0JBQWtCLEdBQUcsQ0FBQ0Qsc0JBQTVCO0FBQ0EsWUFBTUUsaUJBQWlCLEdBQUdGLHNCQUFzQixLQUFLWix3QkFBd0IsQ0FBQ2QsTUFBekIsR0FBa0MsQ0FBdkY7QUFFQW1CLFFBQUFBLGlDQUFpQyxDQUFDRixPQUFsQyxDQUEwQyxVQUFDOUMsUUFBRCxFQUFXMEQsK0JBQVgsRUFBK0M7QUFDdkY7QUFDQSxjQUFNQyxvQkFBb0IsR0FBRzFDLDRCQUE0QixDQUFDO0FBQ3hEakIsWUFBQUEsUUFBUSxFQUFSQTtBQUR3RCxXQUFELENBQXpEO0FBSUEsY0FBTTRELDJCQUEyQixHQUFHLENBQUNGLCtCQUFyQztBQUNBLGNBQU1HLDBCQUEwQixHQUM5QkgsK0JBQStCLEtBQUtWLGlDQUFpQyxDQUFDbkIsTUFBbEMsR0FBMkMsQ0FEakY7O0FBUHVGLHNDQVU1REgsc0JBQXNCLENBQUNrQixJQUF2QixDQUE0QixVQUFBa0IsS0FBSztBQUFBLG1CQUFJQSxLQUFLLENBQUM5RCxRQUFOLEtBQW1CQSxRQUF2QjtBQUFBLFdBQWpDLENBVjREO0FBQUEsY0FVL0U4QixjQVYrRSx5QkFVL0VBLGNBVitFOztBQVd2RixjQUFNaUMsR0FBRyxHQUFHLGtDQUFvQi9ELFFBQXBCLEtBQWlDa0QsaUJBQWlCLENBQUNyQixNQUEvRDtBQVh1RixzQ0FnQm5GN0IsUUFoQm1GLENBYXJGZ0UsV0FicUY7QUFBQSxxRUFhUixFQWJRO0FBQUEsNkRBYXRFQyxXQWJzRTtBQUFBLHVFQWFmLEVBYmU7QUFBQSxjQWExQ0Msc0JBYjBDLDBCQWF2REMsV0FidUQ7QUFBQSxjQWM3RUMsSUFkNkUsR0FnQm5GcEUsUUFoQm1GLENBY3JGcUUsSUFkcUYsQ0FjN0VELElBZDZFO0FBQUEsY0FlckZFLElBZnFGLEdBZ0JuRnRFLFFBaEJtRixDQWVyRnNFLElBZnFGO0FBa0J2RixjQUFNQyxVQUFVLEdBQUdILElBQUksS0FBSyxNQUFULEdBQWtCaEIsY0FBbEIsR0FBbUNELGFBQXREO0FBRUEsY0FBSXFCLFdBQUosQ0FwQnVGLENBc0J2Rjs7QUFDQSxjQUFJN0QsaUJBQWlCLEtBQUssUUFBMUIsRUFBb0M7QUFDbEMsZ0JBQUk0RCxVQUFKLEVBQWdCO0FBQ2RDLGNBQUFBLFdBQVcsR0FBR2hCLGtCQUFrQixJQUFJSSwyQkFBcEM7QUFDRCxhQUZELE1BRU87QUFDTFksY0FBQUEsV0FBVyxHQUFHZixpQkFBaUIsSUFBSUksMEJBQW5DO0FBQ0Q7QUFDRixXQU5ELE1BTU8sSUFBSWxELGlCQUFpQixLQUFLLFFBQTFCLEVBQW9DO0FBQ3pDLGdCQUFJNEQsVUFBSixFQUFnQjtBQUNkQyxjQUFBQSxXQUFXLEdBQUdaLDJCQUFkO0FBQ0QsYUFGRCxNQUVPO0FBQ0xZLGNBQUFBLFdBQVcsR0FBR1gsMEJBQWQ7QUFDRDtBQUNGLFdBTk0sTUFNQTtBQUNMVyxZQUFBQSxXQUFXLEdBQUcsSUFBZDtBQUNEOztBQUVEdEIsVUFBQUEsaUJBQWlCLENBQUNMLElBQWxCLENBQXVCO0FBQ3JCN0MsWUFBQUEsUUFBUSxFQUFSQSxRQURxQjtBQUdyQjtBQUNBeUUsWUFBQUEsV0FBVyxFQUFFLHFCQUFBQyxlQUFlLEVBQUk7QUFDOUIsa0JBQU1aLEtBQUssR0FBR2xELG1CQUFtQixDQUFDK0QsT0FBcEIsQ0FBNEIvQixJQUE1QixDQUFpQztBQUFBLG9CQUFHZ0MsVUFBSCxTQUFHQSxVQUFIO0FBQUEsdUJBQW9CQSxVQUFVLEtBQUs1RSxRQUFRLENBQUM2RSxFQUE1QztBQUFBLGVBQWpDLENBQWQ7O0FBRUEsa0JBQUlmLEtBQUosRUFBVztBQUNUQSxnQkFBQUEsS0FBSyxDQUFDekUsT0FBTixHQUFnQnFGLGVBQWhCO0FBQ0Q7QUFDRixhQVZvQjtBQVlyQjtBQUNBO0FBQ0E7QUFDQUksWUFBQUEsYUFBYSxFQUNYMUQsaUJBQWlCLElBQUlzQywrQkFBK0IsS0FBS1YsaUNBQWlDLENBQUNuQixNQUFsQyxHQUEyQyxDQWhCakY7QUFpQnJCa0MsWUFBQUEsR0FBRyxFQUFIQSxHQWpCcUI7QUFtQnJCO0FBQ0FnQixZQUFBQSxhQUFhLEVBQUVoQixHQUFHLEdBQUcsR0FBTixJQUFhRyxzQkFBc0IsSUFBSUksSUFBdkMsQ0FwQk07QUFxQnJCeEMsWUFBQUEsY0FBYyxFQUFkQSxjQXJCcUI7QUFzQnJCNkIsWUFBQUEsb0JBQW9CLEVBQXBCQSxvQkF0QnFCO0FBdUJyQkwsWUFBQUEsWUFBWSxFQUFaQSxZQXZCcUI7QUF5QnJCO0FBQ0EwQixZQUFBQSxXQUFXLEVBQUVoRixRQUFRLENBQUNnRSxXQUFULElBQXdCaEUsUUFBUSxDQUFDZ0UsV0FBVCxDQUFxQmlCLEtBMUJyQztBQTJCckJULFlBQUFBLFdBQVcsRUFBWEE7QUEzQnFCLFdBQXZCO0FBNkJELFNBcEVEO0FBcUVELE9BekVEO0FBMEVELEtBOUVEO0FBTHNDLFFBcUZyQlUsZ0JBckZxQixHQXFGQXRFLG1CQXJGQSxDQXFGOUIrRCxPQXJGOEIsRUF1RnRDOztBQUVBL0QsSUFBQUEsbUJBQW1CLENBQUMrRCxPQUFwQixHQUE4QnpCLGlCQUFpQixDQUFDakIsR0FBbEIsQ0FBc0IsaUJBQStCO0FBQUEsVUFBaEI0QyxFQUFnQixTQUE1QjdFLFFBQTRCLENBQWhCNkUsRUFBZ0I7QUFBQSxVQUFWZCxHQUFVLFNBQVZBLEdBQVU7QUFDakYsVUFBTW9CLGFBQWEsR0FBR0QsZ0JBQWdCLENBQUN0QyxJQUFqQixDQUFzQixVQUFBa0IsS0FBSztBQUFBLGVBQUlBLEtBQUssQ0FBQ0MsR0FBTixLQUFjQSxHQUFsQjtBQUFBLE9BQTNCLENBQXRCO0FBRUEsYUFBTztBQUNMYSxRQUFBQSxVQUFVLEVBQUVDLEVBRFA7QUFFTHhGLFFBQUFBLE9BQU8sRUFBRThGLGFBQWEsSUFBSUEsYUFBYSxDQUFDOUYsT0FGbkM7QUFHTDBFLFFBQUFBLEdBQUcsRUFBSEE7QUFISyxPQUFQO0FBS0QsS0FSNkIsQ0FBOUI7QUFVQSxXQUFPYixpQkFBUDtBQUNELEdBcEd5QixFQW9HdkIsQ0FDRHhCLHNCQURDLEVBRURkLG1CQUZDLEVBR0Q0QixZQUhDLEVBSURqQyx1QkFKQyxFQUtEQyxlQUxDLEVBTURTLDRCQU5DLEVBT0RDLG9CQVBDLEVBUURFLGlCQVJDLEVBU0RULGlCQVRDLENBcEd1QixDQUExQjtBQWdIQSxNQUFNeUUsbUJBQW1CLEdBQUcsb0JBQVE7QUFBQSxXQUFNbEMsaUJBQWlCLENBQUNqQixHQUFsQixDQUFzQjtBQUFBLFVBQUdqQyxRQUFILFNBQUdBLFFBQUg7QUFBQSxhQUFrQkEsUUFBbEI7QUFBQSxLQUF0QixDQUFOO0FBQUEsR0FBUixFQUFpRSxDQUFDa0QsaUJBQUQsQ0FBakUsQ0FBNUI7QUFFQSxzQkFDRTtBQUNFLElBQUEsU0FBUyxFQUFFLHlCQUFXLDJCQUFYLEVBQXdDbkMsYUFBeEMsRUFBdUQsQ0FBQ1YsU0FBUyxJQUFJLEVBQWQsSUFBb0IsRUFBM0UsQ0FEYjtBQUVFLElBQUEsR0FBRyxFQUFFUSxTQUZQO0FBR0UsSUFBQSxHQUFHLEVBQUVDO0FBSFAsa0JBTUU7QUFDRSxtQkFBYSxLQURmO0FBRUUsaUJBQVUsUUFGWjtBQUdFLHFCQUFjLFdBSGhCO0FBSUUsNEJBQXNCUyx5QkFKeEI7QUFLRSxJQUFBLElBQUksRUFBQztBQUxQLEtBT0cyQixpQkFBaUIsQ0FBQ2pCLEdBQWxCLENBQXNCO0FBQUEsUUFBR2pDLFFBQUgsU0FBR0EsUUFBSDtBQUFBLFFBQWErRSxhQUFiLFNBQWFBLGFBQWI7QUFBQSx3QkFDckIsNkJBQUMsYUFBRDtBQUFNLE1BQUEsU0FBUyxFQUFFckUsMkJBQWpCO0FBQThDLE1BQUEsR0FBRyxFQUFFcUU7QUFBbkQsT0FDRztBQUFBLDBCQUFNLDZCQUFDLDZCQUFEO0FBQXNCLFFBQUEsUUFBUSxFQUFFL0U7QUFBaEMsUUFBTjtBQUFBLEtBREgsQ0FEcUI7QUFBQSxHQUF0QixDQVBILENBTkYsZUFtQkUsNkJBQUMsNEJBQUQ7QUFBOEIsSUFBQSxVQUFVLEVBQUVvRjtBQUExQyxLQUNHbEMsaUJBQWlCLENBQUNqQixHQUFsQixDQUNDO0FBQUEsUUFDRWpDLFFBREYsU0FDRUEsUUFERjtBQUFBLFFBRUV5RSxXQUZGLFNBRUVBLFdBRkY7QUFBQSxRQUdFVixHQUhGLFNBR0VBLEdBSEY7QUFBQSxRQUlFZSxhQUpGLFNBSUVBLGFBSkY7QUFBQSxRQUtFaEQsY0FMRixTQUtFQSxjQUxGO0FBQUEsUUFNRTZCLG9CQU5GLFNBTUVBLG9CQU5GO0FBQUEsUUFPRUwsWUFQRixTQU9FQSxZQVBGO0FBQUEsUUFRRTBCLFdBUkYsU0FRRUEsV0FSRjtBQUFBLFFBU0VSLFdBVEYsU0FTRUEsV0FURjtBQUFBLHdCQVdFO0FBQ0Usb0JBQVlsRCxpQkFEZCxDQUNpQztBQURqQztBQUVFLE1BQUEsU0FBUyxFQUFFLHlCQUFXaEIsZ0JBQWdCLEdBQUcsRUFBOUIsRUFBa0MscUNBQWxDLENBRmI7QUFHRSxNQUFBLEdBQUcsRUFBRXlELEdBSFA7QUFJRSxNQUFBLEdBQUcsRUFBRVU7QUFKUCxPQU1HM0MsY0FBYyxDQUFDO0FBQ2RnRCxNQUFBQSxhQUFhLEVBQWJBLGFBRGM7QUFFZG5CLE1BQUFBLG9CQUFvQixFQUFwQkEsb0JBRmM7QUFHZEwsTUFBQUEsWUFBWSxFQUFaQSxZQUhjO0FBSWRrQixNQUFBQSxXQUFXLEVBQVhBO0FBSmMsS0FBRCxDQU5qQixFQVlHUSxXQUFXLGlCQUFJLDZCQUFDLGNBQUQ7QUFBZSxNQUFBLFFBQVEsRUFBRWhGO0FBQXpCLE1BWmxCLENBWEY7QUFBQSxHQURELENBREgsQ0FuQkYsQ0FERjtBQW9ERCxDQXBURDs7QUFzVEFJLGVBQWUsQ0FBQ2lGLFlBQWhCLEdBQStCO0FBQzdCaEYsRUFBQUEsU0FBUyxFQUFFO0FBRGtCLENBQS9CO0FBSUFELGVBQWUsQ0FBQ2tGLFNBQWhCLEdBQTRCO0FBQzFCakYsRUFBQUEsU0FBUyxFQUFFa0YsbUJBQVVDO0FBREssQ0FBNUI7O0FBSUEsSUFBTUMsOEJBQThCLEdBQUcsU0FBakNBLDhCQUFpQyxRQUEyQjtBQUFBLE1BQXhCdkMsaUJBQXdCLFNBQXhCQSxpQkFBd0I7QUFDaEUsTUFBTTdCLFFBQVEsR0FBRzVDLFlBQVksRUFBN0I7O0FBRGdFLDBCQUUxQkMsZUFBZSxFQUZXO0FBQUE7QUFBQSxNQUV6RGdDLDJCQUZ5RDs7QUFJaEUsTUFBTWEseUJBQXlCLEdBQUdGLFFBQVEsQ0FBQywwQkFBRCxDQUExQztBQUVBLHNCQUNFO0FBQ0UsbUJBQWEsS0FEZjtBQUVFLGlCQUFVLFFBRlo7QUFHRSxxQkFBYyxXQUhoQjtBQUlFLDRCQUFzQkUseUJBSnhCO0FBS0UsSUFBQSxJQUFJLEVBQUM7QUFMUCxLQU9HMkIsaUJBQWlCLENBQUNqQixHQUFsQixDQUFzQjtBQUFBLFFBQUdqQyxRQUFILFNBQUdBLFFBQUg7QUFBQSxRQUFhK0UsYUFBYixTQUFhQSxhQUFiO0FBQUEsd0JBQ3JCLDZCQUFDLGFBQUQ7QUFBTSxNQUFBLFNBQVMsRUFBRXJFLDJCQUFqQjtBQUE4QyxNQUFBLEdBQUcsRUFBRXFFO0FBQW5ELE9BQ0c7QUFBQSwwQkFBTSw2QkFBQyw2QkFBRDtBQUFzQixRQUFBLFFBQVEsRUFBRS9FO0FBQWhDLFFBQU47QUFBQSxLQURILENBRHFCO0FBQUEsR0FBdEIsQ0FQSCxDQURGO0FBZUQsQ0FyQkQ7O0FBdUJBeUYsOEJBQThCLENBQUNILFNBQS9CLEdBQTJDO0FBQ3pDcEMsRUFBQUEsaUJBQWlCLEVBQUVxQyxtQkFBVUcsT0FBVixDQUNqQkgsbUJBQVVJLEtBQVYsQ0FBZ0I7QUFDZDNGLElBQUFBLFFBQVEsRUFBRXVGLG1CQUFVSyxHQUROO0FBRWRiLElBQUFBLGFBQWEsRUFBRVEsbUJBQVVDO0FBRlgsR0FBaEIsQ0FEaUIsRUFLakJLO0FBTnVDLENBQTNDLEMsQ0FTQTs7QUFDQSxJQUFNQyw0QkFBNEIsR0FBRyxTQUEvQkEsNEJBQStCLFNBQThCO0FBQUEsTUFBM0JqRyxVQUEyQixVQUEzQkEsVUFBMkI7QUFBQSxNQUFmUCxRQUFlLFVBQWZBLFFBQWU7O0FBQUEsc0JBQ3BCLDRCQURvQjtBQUFBO0FBQUEsTUFDNUN5RyxrQkFENEMsb0JBQ3hEbEcsVUFEd0Q7O0FBQUEsMEJBRTdCbkIsZUFBZSxFQUZjO0FBQUE7QUFBQSxNQUV4RHNILHFCQUZ3RCx3QkFFeERBLHFCQUZ3RDs7QUFBQSwyQkFHeEMsNkNBSHdDO0FBQUE7QUFBQSxNQUcxREMsY0FIMEQ7O0FBQUEsbUJBSWhELHFDQUpnRDtBQUFBO0FBQUEsTUFJMURDLE1BSjBEOztBQUtqRSxNQUFNQyxLQUFLLEdBQUcsd0JBQWQ7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxrQ0FBb0J2RyxVQUFVLENBQUNBLFVBQVUsQ0FBQ2dDLE1BQVgsR0FBb0IsQ0FBckIsQ0FBVixJQUFxQyxFQUF6RCxDQUE5QixDQU5pRSxDQU0yQjs7QUFDNUYsTUFBTVIsUUFBUSxHQUFHNUMsWUFBWSxFQUE3QjtBQUNBLE1BQU00SCxvQkFBb0IsR0FBRyxvQkFBN0I7QUFFQSxNQUFNQyxxQkFBcUIsR0FBRyxtQkFBT0YscUJBQVAsQ0FBOUI7QUFDQSxNQUFNN0UseUJBQXlCLEdBQUdGLFFBQVEsQ0FBQywwQkFBRCxDQUExQztBQUVBLE1BQU1rRixpQkFBaUIsR0FBR0gscUJBQXFCLEtBQUtFLHFCQUFxQixDQUFDM0IsT0FBMUU7QUFFQSxNQUFNNkIsNEJBQTRCLEdBQUcsd0JBQVksWUFBTTtBQUFBLFFBQzdDN0IsT0FENkMsR0FDakMwQixvQkFEaUMsQ0FDN0MxQixPQUQ2QyxFQUdyRDtBQUNBOztBQUNBLFFBQUlBLE9BQUosRUFBYTtBQUNYLFVBQU04QixZQUFZLEdBQUdySCxjQUFjLENBQUN1RixPQUFELENBQW5DO0FBRUEsVUFBTStCLG1CQUFtQixHQUFHRCxZQUFZLENBQUNFLE1BQWIsQ0FDMUIsVUFBQ0MsTUFBRCxFQUFTQyxxQkFBVDtBQUFBLGVBQW1DRCxNQUFNLElBQUksc0NBQXdCQyxxQkFBeEIsQ0FBN0M7QUFBQSxPQUQwQixFQUUxQixDQUYwQixDQUE1QjtBQUtBSCxNQUFBQSxtQkFBbUIsR0FBR0EsbUJBQW1CLENBQUNQLEtBQXBCLEVBQUgsR0FBaUNBLEtBQUssQ0FBQyx3QkFBRCxDQUF6RDtBQUNEO0FBQ0YsR0Fmb0MsRUFlbEMsQ0FBQ0EsS0FBRCxFQUFRRSxvQkFBUixDQWZrQyxDQUFyQzs7QUFpQkEsTUFBSUgsTUFBSixFQUFZO0FBQ1Y7QUFDQTtBQUNBSSxJQUFBQSxxQkFBcUIsQ0FBQzNCLE9BQXRCLEdBQWdDeUIscUJBQWhDO0FBQ0QsR0FwQ2dFLENBc0NqRTs7O0FBQ0EsTUFBTVUseUJBQXlCLEdBQUcsb0JBQVEsWUFBTTtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLFFBQUlQLGlCQUFpQixJQUFJTixjQUFyQixJQUF1Q0QscUJBQXZDLElBQWdFRSxNQUFwRSxFQUE0RTtBQUMxRSxhQUFPLENBQUMsQ0FBUjtBQUNEOztBQUVELFdBQU9yRyxVQUFVLENBQUNrSCxTQUFYLENBQXFCLFVBQUEvRyxRQUFRO0FBQUEsYUFBSSxrQ0FBb0JBLFFBQXBCLE1BQWtDc0cscUJBQXFCLENBQUMzQixPQUE1RDtBQUFBLEtBQTdCLENBQVA7QUFDRCxHQTNCaUMsRUEyQi9CLENBQUM5RSxVQUFELEVBQWEwRyxpQkFBYixFQUFnQ04sY0FBaEMsRUFBZ0RELHFCQUFoRCxFQUF1RU0scUJBQXZFLEVBQThGSixNQUE5RixDQTNCK0IsQ0FBbEM7QUE2QkEsc0JBQ0UsNkJBQUMsMEJBQUQ7QUFBcUIsSUFBQSxTQUFTLEVBQUM7QUFBL0Isa0JBQ0U7QUFBSyxtQkFBYSxJQUFsQjtBQUF3QixJQUFBLFNBQVMsRUFBQztBQUFsQyxJQURGLGVBRUU7QUFDRSw0QkFBc0IzRSx5QkFEeEI7QUFFRSxJQUFBLFNBQVMsRUFBRSx5QkFBV3dFLGtCQUFrQixHQUFHLEVBQWhDLEVBQW9DLHVDQUFwQyxDQUZiO0FBR0UsSUFBQSxJQUFJLEVBQUM7QUFIUCxLQUtHaUIsZUFBTUMsUUFBTixDQUFlaEYsR0FBZixDQUFtQjNDLFFBQW5CLEVBQTZCLFVBQUM0SCxLQUFELEVBQVF0RixLQUFSO0FBQUEsd0JBQzVCLDZCQUFDLGNBQUQsQ0FBTyxRQUFQLFFBQ0dzRixLQURILEVBR0d0RixLQUFLLEtBQUtrRix5QkFBVixpQkFDQyw2QkFBQywwQkFBRDtBQUNFLHVCQUFlakgsVUFBVSxDQUFDZ0MsTUFENUI7QUFFRSx1QkFBZUQsS0FBSyxHQUFHLENBRnpCO0FBR0UsTUFBQSxPQUFPLEVBQUU0RSw0QkFIWDtBQUlFLE1BQUEsR0FBRyxFQUFFSDtBQUpQLE1BSkosQ0FENEI7QUFBQSxHQUE3QixDQUxILENBRkYsZUFzQkUsNkJBQUMsNkJBQUQsT0F0QkYsQ0FERjtBQTBCRCxDQTlGRDs7QUFnR0FQLDRCQUE0QixDQUFDUixTQUE3QixHQUF5QztBQUN2Q3pGLEVBQUFBLFVBQVUsRUFBRTBGLG1CQUFVNEIsS0FBVixDQUFnQnRCLFVBRFc7QUFFdkN2RyxFQUFBQSxRQUFRLEVBQUVpRyxtQkFBVUcsT0FBVixDQUFrQkgsbUJBQVVsRyxPQUE1QixFQUFxQ3dHO0FBRlIsQ0FBekM7ZUFLZXpGLGUiLCJzb3VyY2VSb290IjoiY29tcG9uZW50Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1tYWdpYy1udW1iZXJzOiBbXCJlcnJvclwiLCB7IFwiaWdub3JlXCI6IFstMSwgMCwgMV0gfV0gKi9cblxuaW1wb3J0IHsgaG9va3MgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1hcGknO1xuaW1wb3J0IHsgUGFuZWwgYXMgU2Nyb2xsVG9Cb3R0b21QYW5lbCwgdXNlQW5pbWF0aW5nVG9FbmQsIHVzZVN0aWNreSB9IGZyb20gJ3JlYWN0LXNjcm9sbC10by1ib3R0b20nO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VNZW1vLCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBCYXNpY1R5cGluZ0luZGljYXRvciBmcm9tICcuL0Jhc2ljVHlwaW5nSW5kaWNhdG9yJztcbmltcG9ydCBGYWRlIGZyb20gJy4vVXRpbHMvRmFkZSc7XG5pbXBvcnQgZmlyc3RUYWJiYWJsZURlc2NlbmRhbnQgZnJvbSAnLi9VdGlscy9maXJzdFRhYmJhYmxlRGVzY2VuZGFudCc7XG5pbXBvcnQgZ2V0QWN0aXZpdHlVbmlxdWVJZCBmcm9tICcuL1V0aWxzL2dldEFjdGl2aXR5VW5pcXVlSWQnO1xuaW1wb3J0IGludGVyc2VjdGlvbk9mIGZyb20gJy4vVXRpbHMvaW50ZXJzZWN0aW9uT2YnO1xuaW1wb3J0IGlzWmVyb09yUG9zaXRpdmUgZnJvbSAnLi9VdGlscy9pc1plcm9PclBvc2l0aXZlJztcbmltcG9ydCByZW1vdmVJbmxpbmUgZnJvbSAnLi9VdGlscy9yZW1vdmVJbmxpbmUnO1xuaW1wb3J0IFNjcmVlblJlYWRlckFjdGl2aXR5IGZyb20gJy4vU2NyZWVuUmVhZGVyQWN0aXZpdHknO1xuaW1wb3J0IFNjcm9sbFRvRW5kQnV0dG9uIGZyb20gJy4vQWN0aXZpdHkvU2Nyb2xsVG9FbmRCdXR0b24nO1xuaW1wb3J0IFNwZWFrQWN0aXZpdHkgZnJvbSAnLi9BY3Rpdml0eS9TcGVhayc7XG5pbXBvcnQgdXNlRm9jdXMgZnJvbSAnLi9ob29rcy91c2VGb2N1cyc7XG5pbXBvcnQgdXNlTWVtb2l6ZSBmcm9tICcuL2hvb2tzL2ludGVybmFsL3VzZU1lbW9pemUnO1xuaW1wb3J0IHVzZVN0eWxlU2V0IGZyb20gJy4vaG9va3MvdXNlU3R5bGVTZXQnO1xuaW1wb3J0IHVzZVN0eWxlVG9FbW90aW9uT2JqZWN0IGZyb20gJy4vaG9va3MvaW50ZXJuYWwvdXNlU3R5bGVUb0Vtb3Rpb25PYmplY3QnO1xuaW1wb3J0IHVzZVRyYW5zY3JpcHRBY3Rpdml0eUVsZW1lbnRzUmVmIGZyb20gJy4vaG9va3MvaW50ZXJuYWwvdXNlVHJhbnNjcmlwdEFjdGl2aXR5RWxlbWVudHNSZWYnO1xuaW1wb3J0IHVzZVRyYW5zY3JpcHRSb290RWxlbWVudFJlZiBmcm9tICcuL2hvb2tzL2ludGVybmFsL3VzZVRyYW5zY3JpcHRSb290RWxlbWVudFJlZic7XG5cbmNvbnN0IHtcbiAgdXNlQWN0aXZpdGllcyxcbiAgdXNlQ3JlYXRlQWN0aXZpdHlSZW5kZXJlcixcbiAgdXNlQ3JlYXRlQWN0aXZpdHlTdGF0dXNSZW5kZXJlcixcbiAgdXNlQ3JlYXRlQXZhdGFyUmVuZGVyZXIsXG4gIHVzZURpcmVjdGlvbixcbiAgdXNlR3JvdXBBY3Rpdml0aWVzLFxuICB1c2VMb2NhbGl6ZXIsXG4gIHVzZVN0eWxlT3B0aW9uc1xufSA9IGhvb2tzO1xuXG5jb25zdCBST09UX1NUWUxFID0ge1xuICAnJi53ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0Jzoge1xuICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICBmbGV4RGlyZWN0aW9uOiAnY29sdW1uJyxcbiAgICBvdmVyZmxvdzogJ2hpZGRlbicsXG4gICAgLy8gTWFrZSBzdXJlIHRvIHNldCBcInBvc2l0aW9uOiByZWxhdGl2ZVwiIGhlcmUgdG8gZm9ybSBhbm90aGVyIHN0YWNraW5nIGNvbnRleHQgZm9yIHRoZSBzY3JvbGwtdG8tZW5kIGJ1dHRvbi5cbiAgICAvLyBTdGFja2luZyBjb250ZXh0IGhlbHAgaXNvbGF0aW5nIGVsZW1lbnRzIHRoYXQgdXNlIFwiei1pbmRleFwiIGZyb20gZ2xvYmFsIHBvbGx1dGlvbi5cbiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9DU1MvQ1NTX1Bvc2l0aW9uaW5nL1VuZGVyc3RhbmRpbmdfel9pbmRleC9UaGVfc3RhY2tpbmdfY29udGV4dFxuICAgIHBvc2l0aW9uOiAncmVsYXRpdmUnLFxuXG4gICAgJyYgLndlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2ZpbGxlcic6IHtcbiAgICAgIGZsZXg6IDFcbiAgICB9LFxuXG4gICAgJyYgLndlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX3Njcm9sbGFibGUnOiB7XG4gICAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgICBmbGV4RGlyZWN0aW9uOiAnY29sdW1uJyxcbiAgICAgIG92ZXJmbG93WDogJ2hpZGRlbicsXG4gICAgICBXZWJraXRPdmVyZmxvd1Njcm9sbGluZzogJ3RvdWNoJ1xuICAgIH0sXG5cbiAgICAnJiAud2ViY2hhdF9fYmFzaWMtdHJhbnNjcmlwdF9fdHJhbnNjcmlwdCc6IHtcbiAgICAgIGxpc3RTdHlsZVR5cGU6ICdub25lJ1xuICAgIH1cbiAgfVxufTtcblxuZnVuY3Rpb24gbmV4dFNpYmxpbmdBbGwoZWxlbWVudCkge1xuICBjb25zdCB7XG4gICAgcGFyZW50Tm9kZTogeyBjaGlsZHJlbiB9XG4gIH0gPSBlbGVtZW50O1xuXG4gIGNvbnN0IGVsZW1lbnRJbmRleCA9IFtdLmluZGV4T2YuY2FsbChjaGlsZHJlbiwgZWxlbWVudCk7XG5cbiAgcmV0dXJuIFtdLnNsaWNlLmNhbGwoY2hpbGRyZW4sIGVsZW1lbnRJbmRleCArIDEpO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUFsbEFjdGl2aXRpZXNUYWdnZWQoYWN0aXZpdGllcywgYmlucykge1xuICByZXR1cm4gYWN0aXZpdGllcy5ldmVyeShhY3Rpdml0eSA9PiBiaW5zLnNvbWUoYmluID0+IGJpbi5pbmNsdWRlcyhhY3Rpdml0eSkpKTtcbn1cblxuY29uc3QgQmFzaWNUcmFuc2NyaXB0ID0gKHsgY2xhc3NOYW1lIH0pID0+IHtcbiAgY29uc3QgW3sgYWN0aXZpdHk6IGFjdGl2aXR5U3R5bGVTZXQgfV0gPSB1c2VTdHlsZVNldCgpO1xuICBjb25zdCBbXG4gICAgeyBidWJibGVGcm9tVXNlck51Yk9mZnNldCwgYnViYmxlTnViT2Zmc2V0LCBncm91cFRpbWVzdGFtcCwgaW50ZXJuYWxMaXZlUmVnaW9uRmFkZUFmdGVyLCBzaG93QXZhdGFySW5Hcm91cCB9XG4gIF0gPSB1c2VTdHlsZU9wdGlvbnMoKTtcbiAgY29uc3QgW2FjdGl2aXRpZXNdID0gdXNlQWN0aXZpdGllcygpO1xuICBjb25zdCBbYWN0aXZpdHlFbGVtZW50c1JlZl0gPSB1c2VUcmFuc2NyaXB0QWN0aXZpdHlFbGVtZW50c1JlZigpO1xuICBjb25zdCBbZGlyZWN0aW9uXSA9IHVzZURpcmVjdGlvbigpO1xuICBjb25zdCBbcm9vdEVsZW1lbnRSZWZdID0gdXNlVHJhbnNjcmlwdFJvb3RFbGVtZW50UmVmKCk7XG4gIGNvbnN0IHJvb3RDbGFzc05hbWUgPSB1c2VTdHlsZVRvRW1vdGlvbk9iamVjdCgpKFJPT1RfU1RZTEUpICsgJyc7XG5cbiAgY29uc3QgY3JlYXRlQWN0aXZpdHlSZW5kZXJlciA9IHVzZUNyZWF0ZUFjdGl2aXR5UmVuZGVyZXIoKTtcbiAgY29uc3QgY3JlYXRlQWN0aXZpdHlTdGF0dXNSZW5kZXJlciA9IHVzZUNyZWF0ZUFjdGl2aXR5U3RhdHVzUmVuZGVyZXIoKTtcbiAgY29uc3QgY3JlYXRlQXZhdGFyUmVuZGVyZXIgPSB1c2VDcmVhdGVBdmF0YXJSZW5kZXJlcigpO1xuICBjb25zdCBncm91cEFjdGl2aXRpZXMgPSB1c2VHcm91cEFjdGl2aXRpZXMoKTtcbiAgY29uc3QgaGlkZUFsbFRpbWVzdGFtcHMgPSBncm91cFRpbWVzdGFtcCA9PT0gZmFsc2U7XG4gIGNvbnN0IGxvY2FsaXplID0gdXNlTG9jYWxpemVyKCk7XG5cbiAgY29uc3QgYWN0aXZpdHlBcmlhTGFiZWwgPSBsb2NhbGl6ZSgnQUNUSVZJVFlfQVJJQV9MQUJFTF9BTFQnKTtcbiAgY29uc3QgdHJhbnNjcmlwdFJvbGVEZXNjcmlwdGlvbiA9IGxvY2FsaXplKCdUUkFOU0NSSVBUX0FSSUFfUk9MRV9BTFQnKTtcblxuICAvLyBHZXRzIHJlbmRlcmVyIGZvciBldmVyeSBhY3Rpdml0eS5cbiAgLy8gQWN0aXZpdGllcyB0aGF0IGFyZSBub3QgdmlzaWJsZSB3aWxsIHJldHVybiBhIGZhbHN5IHJlbmRlcmVyLlxuXG4gIC8vIENvbnZlcnRlZCBmcm9tIGNyZWF0ZUFjdGl2aXR5UmVuZGVyZXIoeyBhY3Rpdml0eSwgbmV4dFZpc2libGVBY3Rpdml0eSB9KSB0byBjcmVhdGVBY3Rpdml0eVJlbmRlcmVyKGFjdGl2aXR5LCBuZXh0VmlzaWJsZUFjdGl2aXR5KS5cbiAgLy8gVGhpcyBpcyBmb3IgdGhlIG1lbW9pemF0aW9uIGZ1bmN0aW9uIHRvIGNhY2hlIHRoZSBhcmd1bWVudHMuIE1lbW9pemVyIGNhbiBvbmx5IGNhY2hlIGxpdGVyYWwgYXJndW1lbnRzLlxuICBjb25zdCBjcmVhdGVBY3Rpdml0eVJlbmRlcmVyV2l0aExpdGVyYWxBcmdzID0gdXNlQ2FsbGJhY2soXG4gICAgKGFjdGl2aXR5LCBuZXh0VmlzaWJsZUFjdGl2aXR5KSA9PiBjcmVhdGVBY3Rpdml0eVJlbmRlcmVyKHsgYWN0aXZpdHksIG5leHRWaXNpYmxlQWN0aXZpdHkgfSksXG4gICAgW2NyZWF0ZUFjdGl2aXR5UmVuZGVyZXJdXG4gICk7XG5cbiAgLy8gQ3JlYXRlIGEgbWVtb2l6ZWQgY29udGV4dCBvZiB0aGUgY3JlYXRlQWN0aXZpdHlSZW5kZXJlciBmdW5jdGlvbi5cbiAgY29uc3QgYWN0aXZpdGllc1dpdGhSZW5kZXJlciA9IHVzZU1lbW9pemUoXG4gICAgY3JlYXRlQWN0aXZpdHlSZW5kZXJlcldpdGhMaXRlcmFsQXJncyxcbiAgICBjcmVhdGVBY3Rpdml0eVJlbmRlcmVyV2l0aExpdGVyYWxBcmdzTWVtb2l6ZWQgPT4ge1xuICAgICAgLy8gQWxsIGNhbGxzIHRvIGNyZWF0ZUFjdGl2aXR5UmVuZGVyZXJXaXRoTGl0ZXJhbEFyZ3NNZW1vaXplZCgpIGluIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBtZW1vaXplZCAoTFJVID0gMSkuXG4gICAgICAvLyBJbiB0aGUgbmV4dCByZW5kZXIgY3ljbGUsIGNhbGxzIHRvIGNyZWF0ZUFjdGl2aXR5UmVuZGVyZXJXaXRoTGl0ZXJhbEFyZ3NNZW1vaXplZCgpIG1pZ2h0IHJldHVybiB0aGUgbWVtb2l6ZWQgcmVzdWx0IGluc3RlYWQuXG4gICAgICAvLyBUaGlzIGlzIGFuIGltcHJvdmVtZW50IHRvIFJlYWN0IHVzZU1lbW8oKSwgYmVjYXVzZSBpdCBvbmx5IGFsbG93cyAxIG1lbW9pemF0aW9uLlxuICAgICAgLy8gdXNlTWVtb2l6ZSgpIGFsbG93cyBhbnkgbnVtYmVyIG9mIG1lbW9pemF0aW9uLlxuXG4gICAgICBjb25zdCBhY3Rpdml0aWVzV2l0aFJlbmRlcmVyID0gW107XG4gICAgICBsZXQgbmV4dFZpc2libGVBY3Rpdml0eTtcblxuICAgICAgZm9yIChsZXQgaW5kZXggPSBhY3Rpdml0aWVzLmxlbmd0aCAtIDE7IGluZGV4ID49IDA7IGluZGV4LS0pIHtcbiAgICAgICAgY29uc3QgYWN0aXZpdHkgPSBhY3Rpdml0aWVzW2luZGV4XTtcbiAgICAgICAgY29uc3QgcmVuZGVyQWN0aXZpdHkgPSBjcmVhdGVBY3Rpdml0eVJlbmRlcmVyV2l0aExpdGVyYWxBcmdzTWVtb2l6ZWQoYWN0aXZpdHksIG5leHRWaXNpYmxlQWN0aXZpdHkpO1xuXG4gICAgICAgIGlmIChyZW5kZXJBY3Rpdml0eSkge1xuICAgICAgICAgIGFjdGl2aXRpZXNXaXRoUmVuZGVyZXIuc3BsaWNlKDAsIDAsIHtcbiAgICAgICAgICAgIGFjdGl2aXR5LFxuICAgICAgICAgICAgcmVuZGVyQWN0aXZpdHlcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIG5leHRWaXNpYmxlQWN0aXZpdHkgPSBhY3Rpdml0eTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gYWN0aXZpdGllc1dpdGhSZW5kZXJlcjtcbiAgICB9LFxuICAgIFthY3Rpdml0aWVzXVxuICApO1xuXG4gIGNvbnN0IHZpc2libGVBY3Rpdml0aWVzID0gdXNlTWVtbygoKSA9PiBhY3Rpdml0aWVzV2l0aFJlbmRlcmVyLm1hcCgoeyBhY3Rpdml0eSB9KSA9PiBhY3Rpdml0eSksIFtcbiAgICBhY3Rpdml0aWVzV2l0aFJlbmRlcmVyXG4gIF0pO1xuXG4gIC8vIFRhZyBhY3Rpdml0aWVzIGJhc2VkIG9uIHR5cGVzLlxuICAvLyBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB0YWcgaW50byAyIHR5cGVzOiBzZW5kZXIgYW5kIHN0YXR1cy5cblxuICBjb25zdCB7IGFjdGl2aXRpZXNHcm91cEJ5U2VuZGVyLCBhY3Rpdml0aWVzR3JvdXBCeVN0YXR1cyB9ID0gdXNlTWVtbygoKSA9PiB7XG4gICAgY29uc3QgeyBzZW5kZXI6IGFjdGl2aXRpZXNHcm91cEJ5U2VuZGVyLCBzdGF0dXM6IGFjdGl2aXRpZXNHcm91cEJ5U3RhdHVzIH0gPSBncm91cEFjdGl2aXRpZXMoe1xuICAgICAgYWN0aXZpdGllczogdmlzaWJsZUFjdGl2aXRpZXNcbiAgICB9KTtcblxuICAgIGlmICghdmFsaWRhdGVBbGxBY3Rpdml0aWVzVGFnZ2VkKHZpc2libGVBY3Rpdml0aWVzLCBhY3Rpdml0aWVzR3JvdXBCeVNlbmRlcikpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBOb3QgZXZlcnkgYWN0aXZpdGllcyBhcmUgZ3JvdXBlZCBpbiB0aGUgXCJzZW5kZXJcIiBwcm9wZXJ0eS4gUGxlYXNlIGZpeCBcImdyb3VwQWN0aXZpdGllc01pZGRsZXdhcmVcIiBhbmQgZ3JvdXAgZXZlcnkgYWN0aXZpdGllcy4nXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdmFsaWRhdGVBbGxBY3Rpdml0aWVzVGFnZ2VkKHZpc2libGVBY3Rpdml0aWVzLCBhY3Rpdml0aWVzR3JvdXBCeVN0YXR1cykpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBOb3QgZXZlcnkgYWN0aXZpdGllcyBhcmUgZ3JvdXBlZCBpbiB0aGUgXCJzdGF0dXNcIiBwcm9wZXJ0eS4gUGxlYXNlIGZpeCBcImdyb3VwQWN0aXZpdGllc01pZGRsZXdhcmVcIiBhbmQgZ3JvdXAgZXZlcnkgYWN0aXZpdGllcy4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBhY3Rpdml0aWVzR3JvdXBCeVNlbmRlcixcbiAgICAgIGFjdGl2aXRpZXNHcm91cEJ5U3RhdHVzXG4gICAgfTtcbiAgfSwgW2dyb3VwQWN0aXZpdGllcywgdmlzaWJsZUFjdGl2aXRpZXNdKTtcblxuICAvLyBDcmVhdGUgYSB0cmVlIG9mIGFjdGl2aXRpZXMgd2l0aCAyIGRpbWVuc2lvbnM6IHNlbmRlciwgZm9sbG93ZWQgYnkgc3RhdHVzLlxuXG4gIGNvbnN0IGFjdGl2aXR5VHJlZSA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIGNvbnN0IHZpc2libGVBY3Rpdml0aWVzUGVuZGluZ0dyb3VwaW5nID0gWy4uLnZpc2libGVBY3Rpdml0aWVzXTtcbiAgICBjb25zdCBhY3Rpdml0eVRyZWUgPSBbXTtcblxuICAgIHdoaWxlICh2aXNpYmxlQWN0aXZpdGllc1BlbmRpbmdHcm91cGluZy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IFthY3Rpdml0eV0gPSB2aXNpYmxlQWN0aXZpdGllc1BlbmRpbmdHcm91cGluZztcbiAgICAgIGNvbnN0IHNlbmRlclRyZWUgPSBbXTtcbiAgICAgIGNvbnN0IGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlciA9IGFjdGl2aXRpZXNHcm91cEJ5U2VuZGVyLmZpbmQoYWN0aXZpdGllcyA9PiBhY3Rpdml0aWVzLmluY2x1ZGVzKGFjdGl2aXR5KSk7XG5cbiAgICAgIGFjdGl2aXR5VHJlZS5wdXNoKHNlbmRlclRyZWUpO1xuXG4gICAgICBhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXIuZm9yRWFjaChhY3Rpdml0eSA9PiB7XG4gICAgICAgIGNvbnN0IGFjdGl2aXRpZXNXaXRoU2FtZVN0YXR1cyA9IGFjdGl2aXRpZXNHcm91cEJ5U3RhdHVzLmZpbmQoYWN0aXZpdGllcyA9PiBhY3Rpdml0aWVzLmluY2x1ZGVzKGFjdGl2aXR5KSk7XG5cbiAgICAgICAgY29uc3QgYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzID0gaW50ZXJzZWN0aW9uT2YoXG4gICAgICAgICAgdmlzaWJsZUFjdGl2aXRpZXNQZW5kaW5nR3JvdXBpbmcsXG4gICAgICAgICAgYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyLFxuICAgICAgICAgIGFjdGl2aXRpZXNXaXRoU2FtZVN0YXR1c1xuICAgICAgICApO1xuXG4gICAgICAgIGlmIChhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMubGVuZ3RoKSB7XG4gICAgICAgICAgc2VuZGVyVHJlZS5wdXNoKGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlckFuZFN0YXR1cyk7XG4gICAgICAgICAgcmVtb3ZlSW5saW5lKHZpc2libGVBY3Rpdml0aWVzUGVuZGluZ0dyb3VwaW5nLCAuLi5hY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBc3NlcnRpb246IEFsbCBhY3Rpdml0aWVzIGluIHZpc2libGVBY3Rpdml0aWVzLCBtdXN0IGJlIGFzc2lnbmVkIHRvIHRoZSBhY3Rpdml0eVRyZWVcbiAgICBpZiAoXG4gICAgICAhdmlzaWJsZUFjdGl2aXRpZXMuZXZlcnkoYWN0aXZpdHkgPT5cbiAgICAgICAgYWN0aXZpdHlUcmVlLnNvbWUoYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyID0+XG4gICAgICAgICAgYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyLnNvbWUoYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzID0+XG4gICAgICAgICAgICBhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMuaW5jbHVkZXMoYWN0aXZpdHkpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ2JvdGZyYW1ld29yay13ZWJjaGF0IGludGVybmFsOiBOb3QgYWxsIHZpc2libGUgYWN0aXZpdGllcyBhcmUgZ3JvdXBlZCBpbiB0aGUgYWN0aXZpdHlUcmVlLicsIHtcbiAgICAgICAgdmlzaWJsZUFjdGl2aXRpZXMsXG4gICAgICAgIGFjdGl2aXR5VHJlZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjdGl2aXR5VHJlZTtcbiAgfSwgW2FjdGl2aXRpZXNHcm91cEJ5U2VuZGVyLCBhY3Rpdml0aWVzR3JvdXBCeVN0YXR1cywgdmlzaWJsZUFjdGl2aXRpZXNdKTtcblxuICAvLyBGbGF0dGVuIHRoZSB0cmVlIGJhY2sgaW50byBhbiBhcnJheSB3aXRoIGluZm9ybWF0aW9uIHJlbGF0ZWQgdG8gcmVuZGVyaW5nLlxuXG4gIGNvbnN0IHJlbmRlcmluZ0VsZW1lbnRzID0gdXNlTWVtbygoKSA9PiB7XG4gICAgY29uc3QgcmVuZGVyaW5nRWxlbWVudHMgPSBbXTtcbiAgICBjb25zdCB0b3BTaWRlQm90TnViID0gaXNaZXJvT3JQb3NpdGl2ZShidWJibGVOdWJPZmZzZXQpO1xuICAgIGNvbnN0IHRvcFNpZGVVc2VyTnViID0gaXNaZXJvT3JQb3NpdGl2ZShidWJibGVGcm9tVXNlck51Yk9mZnNldCk7XG5cbiAgICBhY3Rpdml0eVRyZWUuZm9yRWFjaChhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXIgPT4ge1xuICAgICAgY29uc3QgW1tmaXJzdEFjdGl2aXR5XV0gPSBhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXI7XG4gICAgICBjb25zdCByZW5kZXJBdmF0YXIgPSBjcmVhdGVBdmF0YXJSZW5kZXJlcih7IGFjdGl2aXR5OiBmaXJzdEFjdGl2aXR5IH0pO1xuXG4gICAgICBhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXIuZm9yRWFjaCgoYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzLCBpbmRleFdpdGhpblNlbmRlckdyb3VwKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpcnN0SW5TZW5kZXJHcm91cCA9ICFpbmRleFdpdGhpblNlbmRlckdyb3VwO1xuICAgICAgICBjb25zdCBsYXN0SW5TZW5kZXJHcm91cCA9IGluZGV4V2l0aGluU2VuZGVyR3JvdXAgPT09IGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlci5sZW5ndGggLSAxO1xuXG4gICAgICAgIGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlckFuZFN0YXR1cy5mb3JFYWNoKChhY3Rpdml0eSwgaW5kZXhXaXRoaW5TZW5kZXJBbmRTdGF0dXNHcm91cCkgPT4ge1xuICAgICAgICAgIC8vIFdlIG9ubHkgc2hvdyB0aGUgdGltZXN0YW1wIGF0IHRoZSBlbmQgb2YgdGhlIHNlbmRlciBncm91cC4gQnV0IHdlIGFsd2F5cyBzaG93IHRoZSBcIlNlbmQgZmFpbGVkLCByZXRyeVwiIHByb21wdC5cbiAgICAgICAgICBjb25zdCByZW5kZXJBY3Rpdml0eVN0YXR1cyA9IGNyZWF0ZUFjdGl2aXR5U3RhdHVzUmVuZGVyZXIoe1xuICAgICAgICAgICAgYWN0aXZpdHlcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbnN0IGZpcnN0SW5TZW5kZXJBbmRTdGF0dXNHcm91cCA9ICFpbmRleFdpdGhpblNlbmRlckFuZFN0YXR1c0dyb3VwO1xuICAgICAgICAgIGNvbnN0IGxhc3RJblNlbmRlckFuZFN0YXR1c0dyb3VwID1cbiAgICAgICAgICAgIGluZGV4V2l0aGluU2VuZGVyQW5kU3RhdHVzR3JvdXAgPT09IGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlckFuZFN0YXR1cy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgY29uc3QgeyByZW5kZXJBY3Rpdml0eSB9ID0gYWN0aXZpdGllc1dpdGhSZW5kZXJlci5maW5kKGVudHJ5ID0+IGVudHJ5LmFjdGl2aXR5ID09PSBhY3Rpdml0eSk7XG4gICAgICAgICAgY29uc3Qga2V5ID0gZ2V0QWN0aXZpdHlVbmlxdWVJZChhY3Rpdml0eSkgfHwgcmVuZGVyaW5nRWxlbWVudHMubGVuZ3RoO1xuICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIGNoYW5uZWxEYXRhOiB7IG1lc3NhZ2VCYWNrOiB7IGRpc3BsYXlUZXh0OiBtZXNzYWdlQmFja0Rpc3BsYXlUZXh0IH0gPSB7fSB9ID0ge30sXG4gICAgICAgICAgICBmcm9tOiB7IHJvbGUgfSxcbiAgICAgICAgICAgIHRleHRcbiAgICAgICAgICB9ID0gYWN0aXZpdHk7XG5cbiAgICAgICAgICBjb25zdCB0b3BTaWRlTnViID0gcm9sZSA9PT0gJ3VzZXInID8gdG9wU2lkZVVzZXJOdWIgOiB0b3BTaWRlQm90TnViO1xuXG4gICAgICAgICAgbGV0IHNob3dDYWxsb3V0O1xuXG4gICAgICAgICAgLy8gRGVwZW5kcyBvbiBkaWZmZXJlbnQgXCJzaG93QXZhdGFySW5Hcm91cFwiIHNldHRpbmcsIHdlIHdpbGwgc2hvdyB0aGUgYXZhdGFyIGluIGRpZmZlcmVudCBwb3NpdGlvbnMuXG4gICAgICAgICAgaWYgKHNob3dBdmF0YXJJbkdyb3VwID09PSAnc2VuZGVyJykge1xuICAgICAgICAgICAgaWYgKHRvcFNpZGVOdWIpIHtcbiAgICAgICAgICAgICAgc2hvd0NhbGxvdXQgPSBmaXJzdEluU2VuZGVyR3JvdXAgJiYgZmlyc3RJblNlbmRlckFuZFN0YXR1c0dyb3VwO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc2hvd0NhbGxvdXQgPSBsYXN0SW5TZW5kZXJHcm91cCAmJiBsYXN0SW5TZW5kZXJBbmRTdGF0dXNHcm91cDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKHNob3dBdmF0YXJJbkdyb3VwID09PSAnc3RhdHVzJykge1xuICAgICAgICAgICAgaWYgKHRvcFNpZGVOdWIpIHtcbiAgICAgICAgICAgICAgc2hvd0NhbGxvdXQgPSBmaXJzdEluU2VuZGVyQW5kU3RhdHVzR3JvdXA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzaG93Q2FsbG91dCA9IGxhc3RJblNlbmRlckFuZFN0YXR1c0dyb3VwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzaG93Q2FsbG91dCA9IHRydWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVuZGVyaW5nRWxlbWVudHMucHVzaCh7XG4gICAgICAgICAgICBhY3Rpdml0eSxcblxuICAgICAgICAgICAgLy8gQWZ0ZXIgdGhlIGVsZW1lbnQgaXMgbW91bnRlZCwgc2V0IGl0IHRvIGFjdGl2aXR5RWxlbWVudHNSZWYuXG4gICAgICAgICAgICBjYWxsYmFja1JlZjogYWN0aXZpdHlFbGVtZW50ID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBhY3Rpdml0eUVsZW1lbnRzUmVmLmN1cnJlbnQuZmluZCgoeyBhY3Rpdml0eUlEIH0pID0+IGFjdGl2aXR5SUQgPT09IGFjdGl2aXR5LmlkKTtcblxuICAgICAgICAgICAgICBpZiAoZW50cnkpIHtcbiAgICAgICAgICAgICAgICBlbnRyeS5lbGVtZW50ID0gYWN0aXZpdHlFbGVtZW50O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLyBcImhpZGVUaW1lc3RhbXBcIiBpcyBhIHJlbmRlci10aW1lIHBhcmFtZXRlciBmb3IgcmVuZGVyQWN0aXZpdHlTdGF0dXMoKS5cbiAgICAgICAgICAgIC8vIElmIHRydWUsIGl0IHdpbGwgaGlkZSB0aGUgdGltZXN0YW1wLCBidXQgaXQgd2lsbCBjb250aW51ZSB0byBzaG93IHRoZVxuICAgICAgICAgICAgLy8gcmV0cnkgcHJvbXB0LiBBbmQgc2hvdyB0aGUgc2NyZWVuIHJlYWRlciB2ZXJzaW9uIG9mIHRoZSB0aW1lc3RhbXAuXG4gICAgICAgICAgICBoaWRlVGltZXN0YW1wOlxuICAgICAgICAgICAgICBoaWRlQWxsVGltZXN0YW1wcyB8fCBpbmRleFdpdGhpblNlbmRlckFuZFN0YXR1c0dyb3VwICE9PSBhY3Rpdml0aWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMubGVuZ3RoIC0gMSxcbiAgICAgICAgICAgIGtleSxcblxuICAgICAgICAgICAgLy8gV2hlbiBcImxpdmVSZWdpb25LZXlcIiBjaGFuZ2VzLCBpdCB3aWxsIHNob3cgdXAgaW4gdGhlIGxpdmUgcmVnaW9uIG1vbWVudGFyaWx5LlxuICAgICAgICAgICAgbGl2ZVJlZ2lvbktleToga2V5ICsgJ3wnICsgKG1lc3NhZ2VCYWNrRGlzcGxheVRleHQgfHwgdGV4dCksXG4gICAgICAgICAgICByZW5kZXJBY3Rpdml0eSxcbiAgICAgICAgICAgIHJlbmRlckFjdGl2aXR5U3RhdHVzLFxuICAgICAgICAgICAgcmVuZGVyQXZhdGFyLFxuXG4gICAgICAgICAgICAvLyBUT0RPOiBbUDJdICMyODU4IFdlIHNob3VsZCB1c2UgY29yZS9kZWZpbml0aW9ucy9zcGVha2luZ0FjdGl2aXR5IGZvciB0aGlzIHByZWRpY2F0ZSBpbnN0ZWFkXG4gICAgICAgICAgICBzaG91bGRTcGVhazogYWN0aXZpdHkuY2hhbm5lbERhdGEgJiYgYWN0aXZpdHkuY2hhbm5lbERhdGEuc3BlYWssXG4gICAgICAgICAgICBzaG93Q2FsbG91dFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgeyBjdXJyZW50OiBhY3Rpdml0eUVsZW1lbnRzIH0gPSBhY3Rpdml0eUVsZW1lbnRzUmVmO1xuXG4gICAgLy8gVXBkYXRlIGFjdGl2aXR5RWxlbWVudFJlZiB3aXRoIG5ldyBzZXRzIG9mIGFjdGl2aXR5LCB3aGlsZSByZXRhaW5pbmcgdGhlIGV4aXN0aW5nIHJlZmVyZW5jaW5nIGVsZW1lbnQgaWYgZXhpc3RzLlxuXG4gICAgYWN0aXZpdHlFbGVtZW50c1JlZi5jdXJyZW50ID0gcmVuZGVyaW5nRWxlbWVudHMubWFwKCh7IGFjdGl2aXR5OiB7IGlkIH0sIGtleSB9KSA9PiB7XG4gICAgICBjb25zdCBleGlzdGluZ0VudHJ5ID0gYWN0aXZpdHlFbGVtZW50cy5maW5kKGVudHJ5ID0+IGVudHJ5LmtleSA9PT0ga2V5KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWN0aXZpdHlJRDogaWQsXG4gICAgICAgIGVsZW1lbnQ6IGV4aXN0aW5nRW50cnkgJiYgZXhpc3RpbmdFbnRyeS5lbGVtZW50LFxuICAgICAgICBrZXlcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVuZGVyaW5nRWxlbWVudHM7XG4gIH0sIFtcbiAgICBhY3Rpdml0aWVzV2l0aFJlbmRlcmVyLFxuICAgIGFjdGl2aXR5RWxlbWVudHNSZWYsXG4gICAgYWN0aXZpdHlUcmVlLFxuICAgIGJ1YmJsZUZyb21Vc2VyTnViT2Zmc2V0LFxuICAgIGJ1YmJsZU51Yk9mZnNldCxcbiAgICBjcmVhdGVBY3Rpdml0eVN0YXR1c1JlbmRlcmVyLFxuICAgIGNyZWF0ZUF2YXRhclJlbmRlcmVyLFxuICAgIGhpZGVBbGxUaW1lc3RhbXBzLFxuICAgIHNob3dBdmF0YXJJbkdyb3VwXG4gIF0pO1xuXG4gIGNvbnN0IHJlbmRlcmluZ0FjdGl2aXRpZXMgPSB1c2VNZW1vKCgpID0+IHJlbmRlcmluZ0VsZW1lbnRzLm1hcCgoeyBhY3Rpdml0eSB9KSA9PiBhY3Rpdml0eSksIFtyZW5kZXJpbmdFbGVtZW50c10pO1xuXG4gIHJldHVybiAoXG4gICAgPGRpdlxuICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKCd3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0Jywgcm9vdENsYXNzTmFtZSwgKGNsYXNzTmFtZSB8fCAnJykgKyAnJyl9XG4gICAgICBkaXI9e2RpcmVjdGlvbn1cbiAgICAgIHJlZj17cm9vdEVsZW1lbnRSZWZ9XG4gICAgPlxuICAgICAgey8qIFRoaXMgPHNlY3Rpb24+IGlzIGZvciBsaXZlIHJlZ2lvbiBvbmx5LiBDb250ZW50IGlzIG1hZGUgaW52aXNpYmxlIHRocm91Z2ggQ1NTLiAqL31cbiAgICAgIDxzZWN0aW9uXG4gICAgICAgIGFyaWEtYXRvbWljPXtmYWxzZX1cbiAgICAgICAgYXJpYS1saXZlPVwicG9saXRlXCJcbiAgICAgICAgYXJpYS1yZWxldmFudD1cImFkZGl0aW9uc1wiXG4gICAgICAgIGFyaWEtcm9sZWRlc2NyaXB0aW9uPXt0cmFuc2NyaXB0Um9sZURlc2NyaXB0aW9ufVxuICAgICAgICByb2xlPVwibG9nXCJcbiAgICAgID5cbiAgICAgICAge3JlbmRlcmluZ0VsZW1lbnRzLm1hcCgoeyBhY3Rpdml0eSwgbGl2ZVJlZ2lvbktleSB9KSA9PiAoXG4gICAgICAgICAgPEZhZGUgZmFkZUFmdGVyPXtpbnRlcm5hbExpdmVSZWdpb25GYWRlQWZ0ZXJ9IGtleT17bGl2ZVJlZ2lvbktleX0+XG4gICAgICAgICAgICB7KCkgPT4gPFNjcmVlblJlYWRlckFjdGl2aXR5IGFjdGl2aXR5PXthY3Rpdml0eX0gLz59XG4gICAgICAgICAgPC9GYWRlPlxuICAgICAgICApKX1cbiAgICAgIDwvc2VjdGlvbj5cbiAgICAgIDxJbnRlcm5hbFRyYW5zY3JpcHRTY3JvbGxhYmxlIGFjdGl2aXRpZXM9e3JlbmRlcmluZ0FjdGl2aXRpZXN9PlxuICAgICAgICB7cmVuZGVyaW5nRWxlbWVudHMubWFwKFxuICAgICAgICAgICh7XG4gICAgICAgICAgICBhY3Rpdml0eSxcbiAgICAgICAgICAgIGNhbGxiYWNrUmVmLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgaGlkZVRpbWVzdGFtcCxcbiAgICAgICAgICAgIHJlbmRlckFjdGl2aXR5LFxuICAgICAgICAgICAgcmVuZGVyQWN0aXZpdHlTdGF0dXMsXG4gICAgICAgICAgICByZW5kZXJBdmF0YXIsXG4gICAgICAgICAgICBzaG91bGRTcGVhayxcbiAgICAgICAgICAgIHNob3dDYWxsb3V0XG4gICAgICAgICAgfSkgPT4gKFxuICAgICAgICAgICAgPGxpXG4gICAgICAgICAgICAgIGFyaWEtbGFiZWw9e2FjdGl2aXR5QXJpYUxhYmVsfSAvLyBUaGlzIHdpbGwgYmUgcmVhZCB3aGVuIHByZXNzaW5nIENBUFNMT0NLICsgYXJyb3cgd2l0aCBzY3JlZW4gcmVhZGVyXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhhY3Rpdml0eVN0eWxlU2V0ICsgJycsICd3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X19hY3Rpdml0eScpfVxuICAgICAgICAgICAgICBrZXk9e2tleX1cbiAgICAgICAgICAgICAgcmVmPXtjYWxsYmFja1JlZn1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAge3JlbmRlckFjdGl2aXR5KHtcbiAgICAgICAgICAgICAgICBoaWRlVGltZXN0YW1wLFxuICAgICAgICAgICAgICAgIHJlbmRlckFjdGl2aXR5U3RhdHVzLFxuICAgICAgICAgICAgICAgIHJlbmRlckF2YXRhcixcbiAgICAgICAgICAgICAgICBzaG93Q2FsbG91dFxuICAgICAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAge3Nob3VsZFNwZWFrICYmIDxTcGVha0FjdGl2aXR5IGFjdGl2aXR5PXthY3Rpdml0eX0gLz59XG4gICAgICAgICAgICA8L2xpPlxuICAgICAgICAgIClcbiAgICAgICAgKX1cbiAgICAgIDwvSW50ZXJuYWxUcmFuc2NyaXB0U2Nyb2xsYWJsZT5cbiAgICA8L2Rpdj5cbiAgKTtcbn07XG5cbkJhc2ljVHJhbnNjcmlwdC5kZWZhdWx0UHJvcHMgPSB7XG4gIGNsYXNzTmFtZTogJydcbn07XG5cbkJhc2ljVHJhbnNjcmlwdC5wcm9wVHlwZXMgPSB7XG4gIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZ1xufTtcblxuY29uc3QgSW50ZXJuYWxTY3JlZW5SZWFkZXJUcmFuc2NyaXB0ID0gKHsgcmVuZGVyaW5nRWxlbWVudHMgfSkgPT4ge1xuICBjb25zdCBsb2NhbGl6ZSA9IHVzZUxvY2FsaXplcigpO1xuICBjb25zdCBbaW50ZXJuYWxMaXZlUmVnaW9uRmFkZUFmdGVyXSA9IHVzZVN0eWxlT3B0aW9ucygpO1xuXG4gIGNvbnN0IHRyYW5zY3JpcHRSb2xlRGVzY3JpcHRpb24gPSBsb2NhbGl6ZSgnVFJBTlNDUklQVF9BUklBX1JPTEVfQUxUJyk7XG5cbiAgcmV0dXJuIChcbiAgICA8c2VjdGlvblxuICAgICAgYXJpYS1hdG9taWM9e2ZhbHNlfVxuICAgICAgYXJpYS1saXZlPVwicG9saXRlXCJcbiAgICAgIGFyaWEtcmVsZXZhbnQ9XCJhZGRpdGlvbnNcIlxuICAgICAgYXJpYS1yb2xlZGVzY3JpcHRpb249e3RyYW5zY3JpcHRSb2xlRGVzY3JpcHRpb259XG4gICAgICByb2xlPVwibG9nXCJcbiAgICA+XG4gICAgICB7cmVuZGVyaW5nRWxlbWVudHMubWFwKCh7IGFjdGl2aXR5LCBsaXZlUmVnaW9uS2V5IH0pID0+IChcbiAgICAgICAgPEZhZGUgZmFkZUFmdGVyPXtpbnRlcm5hbExpdmVSZWdpb25GYWRlQWZ0ZXJ9IGtleT17bGl2ZVJlZ2lvbktleX0+XG4gICAgICAgICAgeygpID0+IDxTY3JlZW5SZWFkZXJBY3Rpdml0eSBhY3Rpdml0eT17YWN0aXZpdHl9IC8+fVxuICAgICAgICA8L0ZhZGU+XG4gICAgICApKX1cbiAgICA8L3NlY3Rpb24+XG4gICk7XG59O1xuXG5JbnRlcm5hbFNjcmVlblJlYWRlclRyYW5zY3JpcHQucHJvcFR5cGVzID0ge1xuICByZW5kZXJpbmdFbGVtZW50czogUHJvcFR5cGVzLmFycmF5T2YoXG4gICAgUHJvcFR5cGVzLnNoYXBlKHtcbiAgICAgIGFjdGl2aXR5OiBQcm9wVHlwZXMuYW55LFxuICAgICAgbGl2ZVJlZ2lvbktleTogUHJvcFR5cGVzLnN0cmluZ1xuICAgIH0pXG4gICkuaXNSZXF1aXJlZFxufTtcblxuLy8gU2VwYXJhdGluZyBoaWdoLWZyZXF1ZW5jeSBob29rcyB0byBpbXByb3ZlIHBlcmZvcm1hbmNlLlxuY29uc3QgSW50ZXJuYWxUcmFuc2NyaXB0U2Nyb2xsYWJsZSA9ICh7IGFjdGl2aXRpZXMsIGNoaWxkcmVuIH0pID0+IHtcbiAgY29uc3QgW3sgYWN0aXZpdGllczogYWN0aXZpdGllc1N0eWxlU2V0IH1dID0gdXNlU3R5bGVTZXQoKTtcbiAgY29uc3QgW3sgaGlkZVNjcm9sbFRvRW5kQnV0dG9uIH1dID0gdXNlU3R5bGVPcHRpb25zKCk7XG4gIGNvbnN0IFthbmltYXRpbmdUb0VuZF0gPSB1c2VBbmltYXRpbmdUb0VuZCgpO1xuICBjb25zdCBbc3RpY2t5XSA9IHVzZVN0aWNreSgpO1xuICBjb25zdCBmb2N1cyA9IHVzZUZvY3VzKCk7XG4gIGNvbnN0IGxhc3RWaXNpYmxlQWN0aXZpdHlJZCA9IGdldEFjdGl2aXR5VW5pcXVlSWQoYWN0aXZpdGllc1thY3Rpdml0aWVzLmxlbmd0aCAtIDFdIHx8IHt9KTsgLy8gQWN0aXZpdHkgSUQgb2YgdGhlIGxhc3QgdmlzaWJsZSBhY3Rpdml0eSBpbiB0aGUgbGlzdC5cbiAgY29uc3QgbG9jYWxpemUgPSB1c2VMb2NhbGl6ZXIoKTtcbiAgY29uc3Qgc2Nyb2xsVG9FbmRCdXR0b25SZWYgPSB1c2VSZWYoKTtcblxuICBjb25zdCBsYXN0UmVhZEFjdGl2aXR5SWRSZWYgPSB1c2VSZWYobGFzdFZpc2libGVBY3Rpdml0eUlkKTtcbiAgY29uc3QgdHJhbnNjcmlwdFJvbGVEZXNjcmlwdGlvbiA9IGxvY2FsaXplKCdUUkFOU0NSSVBUX0FSSUFfUk9MRV9BTFQnKTtcblxuICBjb25zdCBhbGxBY3Rpdml0aWVzUmVhZCA9IGxhc3RWaXNpYmxlQWN0aXZpdHlJZCA9PT0gbGFzdFJlYWRBY3Rpdml0eUlkUmVmLmN1cnJlbnQ7XG5cbiAgY29uc3QgaGFuZGxlU2Nyb2xsVG9FbmRCdXR0b25DbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCB7IGN1cnJlbnQgfSA9IHNjcm9sbFRvRW5kQnV0dG9uUmVmO1xuXG4gICAgLy8gQWZ0ZXIgY2xpY2tpbmcgb24gdGhlIFwiTmV3IG1lc3NhZ2VzXCIgYnV0dG9uLCB3ZSBzaG91bGQgZm9jdXMgb24gdGhlIGZpcnN0IHVucmVhZCBlbGVtZW50LlxuICAgIC8vIFRoaXMgaXMgZm9yIHJlc29sdmluZyB0aGUgYnVnIGh0dHBzOi8vZ2l0aHViLmNvbS9taWNyb3NvZnQvQm90RnJhbWV3b3JrLVdlYkNoYXQvaXNzdWVzLzMxMzUuXG4gICAgaWYgKGN1cnJlbnQpIHtcbiAgICAgIGNvbnN0IG5leHRTaWJsaW5ncyA9IG5leHRTaWJsaW5nQWxsKGN1cnJlbnQpO1xuXG4gICAgICBjb25zdCBmaXJzdFVucmVhZFRhYmJhYmxlID0gbmV4dFNpYmxpbmdzLnJlZHVjZShcbiAgICAgICAgKHJlc3VsdCwgdW5yZWFkQWN0aXZpdHlFbGVtZW50KSA9PiByZXN1bHQgfHwgZmlyc3RUYWJiYWJsZURlc2NlbmRhbnQodW5yZWFkQWN0aXZpdHlFbGVtZW50KSxcbiAgICAgICAgMFxuICAgICAgKTtcblxuICAgICAgZmlyc3RVbnJlYWRUYWJiYWJsZSA/IGZpcnN0VW5yZWFkVGFiYmFibGUuZm9jdXMoKSA6IGZvY3VzKCdzZW5kQm94V2l0aG91dEtleWJvYXJkJyk7XG4gICAgfVxuICB9LCBbZm9jdXMsIHNjcm9sbFRvRW5kQnV0dG9uUmVmXSk7XG5cbiAgaWYgKHN0aWNreSkge1xuICAgIC8vIElmIGl0IGlzIHN0aWNreSwgdGhlIHVzZXIgaXMgYXQgdGhlIGJvdHRvbSBvZiB0aGUgdHJhbnNjcmlwdCwgZXZlcnl0aGluZyBpcyByZWFkLlxuICAgIC8vIFNvIG1hcmsgdGhlIGFjdGl2aXR5IElEIGFzIHJlYWQuXG4gICAgbGFzdFJlYWRBY3Rpdml0eUlkUmVmLmN1cnJlbnQgPSBsYXN0VmlzaWJsZUFjdGl2aXR5SWQ7XG4gIH1cblxuICAvLyBGaW5kcyB3aGVyZSB3ZSBzaG91bGQgcmVuZGVyIHRoZSBcIk5ldyBtZXNzYWdlc1wiIGJ1dHRvbiwgaW4gaW5kZXguIFJldHVybnMgLTEgdG8gaGlkZSB0aGUgYnV0dG9uLlxuICBjb25zdCByZW5kZXJTZXBhcmF0b3JBZnRlckluZGV4ID0gdXNlTWVtbygoKSA9PiB7XG4gICAgLy8gRG9uJ3Qgc2hvdyB0aGUgYnV0dG9uIGlmOlxuICAgIC8vIC0gQWxsIGFjdGl2aXRpZXMgaGF2ZSBiZWVuIHJlYWRcbiAgICAvLyAtIEN1cnJlbnRseSBhbmltYXRpbmcgdG93YXJkcyBib3R0b21cbiAgICAvLyAgIC0gXCJOZXcgbWVzc2FnZXNcIiBidXR0b24gbXVzdCBub3QgZmxhc2ggd2hlbjogMS4gVHlwZSBcImhlbHBcIiwgMi4gU2Nyb2xsIHRvIHRvcCwgMy4gVHlwZSBcImhlbHBcIiBhZ2FpbiwgNC4gRXhwZWN0IHRoZSBcIk5ldyBtZXNzYWdlc1wiIGJ1dHRvbiBub3QgZmxhc2h5XG4gICAgLy8gLSBIaWRkZW4gYnkgc3R5bGUgb3B0aW9uc1xuICAgIC8vIC0gSXQgaXMgYWxyZWFkeSBhdCB0aGUgYm90dG9tIChzdGlja3kpXG5cbiAgICAvLyBBbnkgY2hhbmdlcyB0byB0aGlzIGxvZ2ljLCB2ZXJpZnk6XG4gICAgLy8gLSBcIk5ldyBtZXNzYWdlc1wiIGJ1dHRvbiBzaG91bGQgcGVyc2lzdCB3aGlsZSBwcm9ncmFtbWF0aWNhbGx5IHNjcm9sbGluZyB0byBtaWQtcG9pbnQgb2YgdGhlIHRyYW5zY3JpcHQ6XG4gICAgLy8gICAxLiBUeXBlIFwiaGVscFwiXG4gICAgLy8gICAyLiBUeXBlIFwicHJvYWN0aXZlXCIsIHRoZW4gaW1tZWRpYXRlbHkgc2Nyb2xsIHRvIHRvcFxuICAgIC8vICAgICAgRXhwZWN0OiB0aGUgXCJOZXcgbWVzc2FnZXNcIiBidXR0b24gc2hvdWxkIGFwcGVhclxuICAgIC8vICAgMy4gUnVuIGhvb2sgXCJ1c2VTY3JvbGxUbyh7IHNjcm9sbFRvcDogNTAwIH0pXCJcbiAgICAvLyAgICAgIEV4cGVjdDogd2hlbiB0aGUgc2Nyb2xsIGlzIGFuaW1hdGluZyB0byA1MDBweCwgdGhlIFwiTmV3IG1lc3NhZ2VzXCIgYnV0dG9uIHNob3VsZCBrZXB0IG9uIHRoZSBzY3JlZW5cbiAgICAvLyAtIFwiTmV3IG1lc3NhZ2VzXCIgYnV0dG9uIG11c3Qgbm90IGZsYXNoeTpcbiAgICAvLyAgIDEuIFR5cGUgXCJoZWxwXCJcbiAgICAvLyAgIDIuIFNjcm9sbCB0byB0b3BcbiAgICAvLyAgICAgIEV4cGVjdDogbm8gXCJOZXcgbWVzc2FnZXNcIiBidXR0b24gaXMgc2hvd25cbiAgICAvLyAgIDMuIFR5cGUgXCJoZWxwXCIgYWdhaW5cbiAgICAvLyAgICAgIEV4cGVjdDogXCJOZXcgbWVzc2FnZXNcIiBidXR0b24gbXVzdCBub3QgZmxhc2gtYXBwZWFyXG5cbiAgICBpZiAoYWxsQWN0aXZpdGllc1JlYWQgfHwgYW5pbWF0aW5nVG9FbmQgfHwgaGlkZVNjcm9sbFRvRW5kQnV0dG9uIHx8IHN0aWNreSkge1xuICAgICAgcmV0dXJuIC0xO1xuICAgIH1cblxuICAgIHJldHVybiBhY3Rpdml0aWVzLmZpbmRJbmRleChhY3Rpdml0eSA9PiBnZXRBY3Rpdml0eVVuaXF1ZUlkKGFjdGl2aXR5KSA9PT0gbGFzdFJlYWRBY3Rpdml0eUlkUmVmLmN1cnJlbnQpO1xuICB9LCBbYWN0aXZpdGllcywgYWxsQWN0aXZpdGllc1JlYWQsIGFuaW1hdGluZ1RvRW5kLCBoaWRlU2Nyb2xsVG9FbmRCdXR0b24sIGxhc3RSZWFkQWN0aXZpdHlJZFJlZiwgc3RpY2t5XSk7XG5cbiAgcmV0dXJuIChcbiAgICA8U2Nyb2xsVG9Cb3R0b21QYW5lbCBjbGFzc05hbWU9XCJ3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X19zY3JvbGxhYmxlXCI+XG4gICAgICA8ZGl2IGFyaWEtaGlkZGVuPXt0cnVlfSBjbGFzc05hbWU9XCJ3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X19maWxsZXJcIiAvPlxuICAgICAgPHVsXG4gICAgICAgIGFyaWEtcm9sZWRlc2NyaXB0aW9uPXt0cmFuc2NyaXB0Um9sZURlc2NyaXB0aW9ufVxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoYWN0aXZpdGllc1N0eWxlU2V0ICsgJycsICd3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X190cmFuc2NyaXB0Jyl9XG4gICAgICAgIHJvbGU9XCJsaXN0XCJcbiAgICAgID5cbiAgICAgICAge1JlYWN0LkNoaWxkcmVuLm1hcChjaGlsZHJlbiwgKGNoaWxkLCBpbmRleCkgPT4gKFxuICAgICAgICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgIHtjaGlsZH1cbiAgICAgICAgICAgIHsvKiBXZSBpbnNlcnQgdGhlIFwiTmV3IG1lc3NhZ2VzXCIgYnV0dG9uIGhlcmUgZm9yIHRhYiBvcmRlcmluZy4gVXNlcnMgc2hvdWxkIGJlIGFibGUgdG8gVEFCIGludG8gdGhlIGJ1dHRvbi4gKi99XG4gICAgICAgICAgICB7aW5kZXggPT09IHJlbmRlclNlcGFyYXRvckFmdGVySW5kZXggJiYgKFxuICAgICAgICAgICAgICA8U2Nyb2xsVG9FbmRCdXR0b25cbiAgICAgICAgICAgICAgICBhcmlhLXZhbHVlbWF4PXthY3Rpdml0aWVzLmxlbmd0aH1cbiAgICAgICAgICAgICAgICBhcmlhLXZhbHVlbm93PXtpbmRleCArIDF9XG4gICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU2Nyb2xsVG9FbmRCdXR0b25DbGlja31cbiAgICAgICAgICAgICAgICByZWY9e3Njcm9sbFRvRW5kQnV0dG9uUmVmfVxuICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKX1cbiAgICAgICAgICA8L1JlYWN0LkZyYWdtZW50PlxuICAgICAgICApKX1cbiAgICAgIDwvdWw+XG4gICAgICA8QmFzaWNUeXBpbmdJbmRpY2F0b3IgLz5cbiAgICA8L1Njcm9sbFRvQm90dG9tUGFuZWw+XG4gICk7XG59O1xuXG5JbnRlcm5hbFRyYW5zY3JpcHRTY3JvbGxhYmxlLnByb3BUeXBlcyA9IHtcbiAgYWN0aXZpdGllczogUHJvcFR5cGVzLmFycmF5LmlzUmVxdWlyZWQsXG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuZWxlbWVudCkuaXNSZXF1aXJlZFxufTtcblxuZXhwb3J0IGRlZmF1bHQgQmFzaWNUcmFuc2NyaXB0O1xuIl19