"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createCognitiveServicesSpeechServicesPonyfillFactory;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _AudioConfig = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/sdk/Audio/AudioConfig");

var _MicAudioSource = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/MicAudioSource");

var _SpeechServices = _interopRequireDefault(require("web-speech-cognitive-services/lib/SpeechServices"));

function resolveFunction(fnOrValue) {
  return typeof fnOrValue === 'function' ? fnOrValue() : fnOrValue;
}

function createCognitiveServicesSpeechServicesPonyfillFactory(_ref) {
  var audioConfig = _ref.audioConfig,
      audioContext = _ref.audioContext,
      audioInputDeviceId = _ref.audioInputDeviceId,
      authorizationToken = _ref.authorizationToken,
      credentials = _ref.credentials,
      enableTelemetry = _ref.enableTelemetry,
      region = _ref.region,
      speechRecognitionEndpointId = _ref.speechRecognitionEndpointId,
      speechSynthesisDeploymentId = _ref.speechSynthesisDeploymentId,
      speechSynthesisOutputFormat = _ref.speechSynthesisOutputFormat,
      subscriptionKey = _ref.subscriptionKey,
      textNormalization = _ref.textNormalization;

  if (!window.navigator.mediaDevices && !audioConfig) {
    console.warn('botframework-webchat: Your browser does not support Web Audio or the page is not loaded via HTTPS or localhost. Cognitive Services Speech Services is disabled. However, you may pass a custom AudioConfig to enable speech in this environment.');
    return function () {
      return {};
    };
  }

  if (!credentials && (authorizationToken || region || subscriptionKey)) {
    console.warn('botframework-webchat: "authorizationToken", "region", and "subscriptionKey" are deprecated and will be removed on or after 2020-12-17. Please use "credentials" instead.');

    credentials = /*#__PURE__*/function () {
      var _ref2 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
        return _regenerator.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                if (!authorizationToken) {
                  _context.next = 6;
                  break;
                }

                _context.next = 3;
                return resolveFunction(authorizationToken);

              case 3:
                _context.t0 = _context.sent;
                _context.t1 = region;
                return _context.abrupt("return", {
                  authorizationToken: _context.t0,
                  region: _context.t1
                });

              case 6:
                _context.t2 = region;
                _context.next = 9;
                return resolveFunction(subscriptionKey);

              case 9:
                _context.t3 = _context.sent;
                return _context.abrupt("return", {
                  region: _context.t2,
                  subscriptionKey: _context.t3
                });

              case 11:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      return function credentials() {
        return _ref2.apply(this, arguments);
      };
    }();
  }

  if (audioConfig && audioInputDeviceId) {
    console.warn('botframework-webchat: "audioConfig" and "audioInputDeviceId" cannot be set at the same time; ignoring "audioInputDeviceId".');
  } // WORKAROUND: We should prevent AudioContext object from being recreated because they may be blessed and UX-wise expensive to recreate.
  //             In Cognitive Services SDK, if they detect the "end" function is falsy, they will not call "end" but "suspend" instead.
  //             And on next recognition, they will re-use the AudioContext object.


  if (!audioConfig) {
    audioConfig = audioInputDeviceId ? _AudioConfig.AudioConfig.fromMicrophoneInput(audioInputDeviceId) : _AudioConfig.AudioConfig.fromDefaultMicrophoneInput();
    var source = audioConfig.privSource; // WORKAROUND: In Speech SDK 1.12.0-1.13.1, it dropped support of macOS/iOS Safari.
    //             This code is adopted from microsoft-cognitiveservices-speech-sdk/src/common.browser/MicAudioSource.ts.
    //             We will not need this code when using Speech SDK 1.14.0 or up.
    // TODO: [P1] #3575 Remove the following lines when bumping to Speech SDK 1.14.0 or higher

    source.createAudioContext = function () {
      if (!!source.privContext) {
        return;
      }

      var AudioContext = window.AudioContext || window.webkitAudioContext;

      if (typeof AudioContext === 'undefined') {
        throw new Error('Browser does not support Web Audio API (AudioContext/webkitAudioContext is not available).');
      }

      if (navigator.mediaDevices.getSupportedConstraints().sampleRate) {
        source.privContext = new AudioContext({
          sampleRate: _MicAudioSource.MicAudioSource.AUDIOFORMAT.samplesPerSec
        });
      } else {
        source.privContext = new AudioContext();
      }
    }; // This piece of code is adopted from microsoft-cognitiveservices-speech-sdk/common.browser/MicAudioSource.ts.
    // Instead of closing the AudioContext, it will just suspend it. And the next time it is needed, it will be resumed (by the original code).


    source.destroyAudioContext = function () {
      if (!source.privContext) {
        return;
      }

      source.privRecorder.releaseMediaResources(source.privContext);
      source.privContext.state === 'running' && source.privContext.suspend();
    };
  }

  return function () {
    var _ref3 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
        referenceGrammarID = _ref3.referenceGrammarID;

    var _createPonyfill = (0, _SpeechServices.default)({
      audioConfig: audioConfig,
      audioContext: audioContext,
      credentials: credentials,
      enableTelemetry: enableTelemetry,
      referenceGrammars: referenceGrammarID ? ["luis/".concat(referenceGrammarID, "-PRODUCTION")] : [],
      speechRecognitionEndpointId: speechRecognitionEndpointId,
      speechSynthesisDeploymentId: speechSynthesisDeploymentId,
      speechSynthesisOutputFormat: speechSynthesisOutputFormat,
      textNormalization: textNormalization
    }),
        SpeechGrammarList = _createPonyfill.SpeechGrammarList,
        SpeechRecognition = _createPonyfill.SpeechRecognition,
        speechSynthesis = _createPonyfill.speechSynthesis,
        SpeechSynthesisUtterance = _createPonyfill.SpeechSynthesisUtterance;

    return {
      SpeechGrammarList: SpeechGrammarList,
      SpeechRecognition: SpeechRecognition,
      speechSynthesis: speechSynthesis,
      SpeechSynthesisUtterance: SpeechSynthesisUtterance
    };
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVDb2duaXRpdmVTZXJ2aWNlc1NwZWVjaFNlcnZpY2VzUG9ueWZpbGxGYWN0b3J5LmpzIl0sIm5hbWVzIjpbInJlc29sdmVGdW5jdGlvbiIsImZuT3JWYWx1ZSIsImNyZWF0ZUNvZ25pdGl2ZVNlcnZpY2VzU3BlZWNoU2VydmljZXNQb255ZmlsbEZhY3RvcnkiLCJhdWRpb0NvbmZpZyIsImF1ZGlvQ29udGV4dCIsImF1ZGlvSW5wdXREZXZpY2VJZCIsImF1dGhvcml6YXRpb25Ub2tlbiIsImNyZWRlbnRpYWxzIiwiZW5hYmxlVGVsZW1ldHJ5IiwicmVnaW9uIiwic3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkIiwic3BlZWNoU3ludGhlc2lzRGVwbG95bWVudElkIiwic3BlZWNoU3ludGhlc2lzT3V0cHV0Rm9ybWF0Iiwic3Vic2NyaXB0aW9uS2V5IiwidGV4dE5vcm1hbGl6YXRpb24iLCJ3aW5kb3ciLCJuYXZpZ2F0b3IiLCJtZWRpYURldmljZXMiLCJjb25zb2xlIiwid2FybiIsIkF1ZGlvQ29uZmlnIiwiZnJvbU1pY3JvcGhvbmVJbnB1dCIsImZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0Iiwic291cmNlIiwicHJpdlNvdXJjZSIsImNyZWF0ZUF1ZGlvQ29udGV4dCIsInByaXZDb250ZXh0IiwiQXVkaW9Db250ZXh0Iiwid2Via2l0QXVkaW9Db250ZXh0IiwiRXJyb3IiLCJnZXRTdXBwb3J0ZWRDb25zdHJhaW50cyIsInNhbXBsZVJhdGUiLCJNaWNBdWRpb1NvdXJjZSIsIkFVRElPRk9STUFUIiwic2FtcGxlc1BlclNlYyIsImRlc3Ryb3lBdWRpb0NvbnRleHQiLCJwcml2UmVjb3JkZXIiLCJyZWxlYXNlTWVkaWFSZXNvdXJjZXMiLCJzdGF0ZSIsInN1c3BlbmQiLCJyZWZlcmVuY2VHcmFtbWFySUQiLCJyZWZlcmVuY2VHcmFtbWFycyIsIlNwZWVjaEdyYW1tYXJMaXN0IiwiU3BlZWNoUmVjb2duaXRpb24iLCJzcGVlY2hTeW50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QUFBQSxRQUM5QjRCLGlCQUQ4QixtQkFDOUJBLGlCQUQ4QjtBQUFBLFFBQ1hDLGlCQURXLG1CQUNYQSxpQkFEVztBQUFBLFFBQ1FDLGVBRFIsbUJBQ1FBLGVBRFI7QUFBQSxRQUN5QkMsd0JBRHpCLG1CQUN5QkEsd0JBRHpCOztBQWF0QyxXQUFPO0FBQ0xILE1BQUFBLGlCQUFpQixFQUFqQkEsaUJBREs7QUFFTEMsTUFBQUEsaUJBQWlCLEVBQWpCQSxpQkFGSztBQUdMQyxNQUFBQSxlQUFlLEVBQWZBLGVBSEs7QUFJTEMsTUFBQUEsd0JBQXdCLEVBQXhCQTtBQUpLLEtBQVA7QUFNRCxHQW5CRDtBQW9CRCIsInNvdXJjZVJvb3QiOiJidW5kbGU6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXVkaW9Db25maWcgfSBmcm9tICdtaWNyb3NvZnQtY29nbml0aXZlc2VydmljZXMtc3BlZWNoLXNkay9kaXN0cmliL2xpYi9zcmMvc2RrL0F1ZGlvL0F1ZGlvQ29uZmlnJztcbmltcG9ydCB7IE1pY0F1ZGlvU291cmNlIH0gZnJvbSAnbWljcm9zb2Z0LWNvZ25pdGl2ZXNlcnZpY2VzLXNwZWVjaC1zZGsvZGlzdHJpYi9saWIvc3JjL2NvbW1vbi5icm93c2VyL01pY0F1ZGlvU291cmNlJztcbmltcG9ydCBjcmVhdGVQb255ZmlsbCBmcm9tICd3ZWItc3BlZWNoLWNvZ25pdGl2ZS1zZXJ2aWNlcy9saWIvU3BlZWNoU2VydmljZXMnO1xuXG5mdW5jdGlvbiByZXNvbHZlRnVuY3Rpb24oZm5PclZhbHVlKSB7XG4gIHJldHVybiB0eXBlb2YgZm5PclZhbHVlID09PSAnZnVuY3Rpb24nID8gZm5PclZhbHVlKCkgOiBmbk9yVmFsdWU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZUNvZ25pdGl2ZVNlcnZpY2VzU3BlZWNoU2VydmljZXNQb255ZmlsbEZhY3Rvcnkoe1xuICBhdWRpb0NvbmZpZyxcbiAgYXVkaW9Db250ZXh0LFxuICBhdWRpb0lucHV0RGV2aWNlSWQsXG4gIGF1dGhvcml6YXRpb25Ub2tlbixcbiAgY3JlZGVudGlhbHMsXG4gIGVuYWJsZVRlbGVtZXRyeSxcbiAgcmVnaW9uLFxuICBzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQsXG4gIHNwZWVjaFN5bnRoZXNpc0RlcGxveW1lbnRJZCxcbiAgc3BlZWNoU3ludGhlc2lzT3V0cHV0Rm9ybWF0LFxuICBzdWJzY3JpcHRpb25LZXksXG4gIHRleHROb3JtYWxpemF0aW9uXG59KSB7XG4gIGlmICghd2luZG93Lm5hdmlnYXRvci5tZWRpYURldmljZXMgJiYgIWF1ZGlvQ29uZmlnKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBZb3VyIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBXZWIgQXVkaW8gb3IgdGhlIHBhZ2UgaXMgbm90IGxvYWRlZCB2aWEgSFRUUFMgb3IgbG9jYWxob3N0LiBDb2duaXRpdmUgU2VydmljZXMgU3BlZWNoIFNlcnZpY2VzIGlzIGRpc2FibGVkLiBIb3dldmVyLCB5b3UgbWF5IHBhc3MgYSBjdXN0b20gQXVkaW9Db25maWcgdG8gZW5hYmxlIHNwZWVjaCBpbiB0aGlzIGVudmlyb25tZW50LidcbiAgICApO1xuXG4gICAgcmV0dXJuICgpID0+ICh7fSk7XG4gIH1cblxuICBpZiAoIWNyZWRlbnRpYWxzICYmIChhdXRob3JpemF0aW9uVG9rZW4gfHwgcmVnaW9uIHx8IHN1YnNjcmlwdGlvbktleSkpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLXdlYmNoYXQ6IFwiYXV0aG9yaXphdGlvblRva2VuXCIsIFwicmVnaW9uXCIsIGFuZCBcInN1YnNjcmlwdGlvbktleVwiIGFyZSBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgb24gb3IgYWZ0ZXIgMjAyMC0xMi0xNy4gUGxlYXNlIHVzZSBcImNyZWRlbnRpYWxzXCIgaW5zdGVhZC4nXG4gICAgKTtcblxuICAgIGNyZWRlbnRpYWxzID0gYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKGF1dGhvcml6YXRpb25Ub2tlbikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGF1dGhvcml6YXRpb25Ub2tlbjogYXdhaXQgcmVzb2x2ZUZ1bmN0aW9uKGF1dGhvcml6YXRpb25Ub2tlbiksXG4gICAgICAgICAgcmVnaW9uXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlZ2lvbixcbiAgICAgICAgc3Vic2NyaXB0aW9uS2V5OiBhd2FpdCByZXNvbHZlRnVuY3Rpb24oc3Vic2NyaXB0aW9uS2V5KVxuICAgICAgfTtcbiAgICB9O1xuICB9XG5cbiAgaWYgKGF1ZGlvQ29uZmlnICYmIGF1ZGlvSW5wdXREZXZpY2VJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdDogXCJhdWRpb0NvbmZpZ1wiIGFuZCBcImF1ZGlvSW5wdXREZXZpY2VJZFwiIGNhbm5vdCBiZSBzZXQgYXQgdGhlIHNhbWUgdGltZTsgaWdub3JpbmcgXCJhdWRpb0lucHV0RGV2aWNlSWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIC8vIFdPUktBUk9VTkQ6IFdlIHNob3VsZCBwcmV2ZW50IEF1ZGlvQ29udGV4dCBvYmplY3QgZnJvbSBiZWluZyByZWNyZWF0ZWQgYmVjYXVzZSB0aGV5IG1heSBiZSBibGVzc2VkIGFuZCBVWC13aXNlIGV4cGVuc2l2ZSB0byByZWNyZWF0ZS5cbiAgLy8gICAgICAgICAgICAgSW4gQ29nbml0aXZlIFNlcnZpY2VzIFNESywgaWYgdGhleSBkZXRlY3QgdGhlIFwiZW5kXCIgZnVuY3Rpb24gaXMgZmFsc3ksIHRoZXkgd2lsbCBub3QgY2FsbCBcImVuZFwiIGJ1dCBcInN1c3BlbmRcIiBpbnN0ZWFkLlxuICAvLyAgICAgICAgICAgICBBbmQgb24gbmV4dCByZWNvZ25pdGlvbiwgdGhleSB3aWxsIHJlLXVzZSB0aGUgQXVkaW9Db250ZXh0IG9iamVjdC5cbiAgaWYgKCFhdWRpb0NvbmZpZykge1xuICAgIGF1ZGlvQ29uZmlnID0gYXVkaW9JbnB1dERldmljZUlkXG4gICAgICA/IEF1ZGlvQ29uZmlnLmZyb21NaWNyb3Bob25lSW5wdXQoYXVkaW9JbnB1dERldmljZUlkKVxuICAgICAgOiBBdWRpb0NvbmZpZy5mcm9tRGVmYXVsdE1pY3JvcGhvbmVJbnB1dCgpO1xuXG4gICAgY29uc3Qgc291cmNlID0gYXVkaW9Db25maWcucHJpdlNvdXJjZTtcblxuICAgIC8vIFdPUktBUk9VTkQ6IEluIFNwZWVjaCBTREsgMS4xMi4wLTEuMTMuMSwgaXQgZHJvcHBlZCBzdXBwb3J0IG9mIG1hY09TL2lPUyBTYWZhcmkuXG4gICAgLy8gICAgICAgICAgICAgVGhpcyBjb2RlIGlzIGFkb3B0ZWQgZnJvbSBtaWNyb3NvZnQtY29nbml0aXZlc2VydmljZXMtc3BlZWNoLXNkay9zcmMvY29tbW9uLmJyb3dzZXIvTWljQXVkaW9Tb3VyY2UudHMuXG4gICAgLy8gICAgICAgICAgICAgV2Ugd2lsbCBub3QgbmVlZCB0aGlzIGNvZGUgd2hlbiB1c2luZyBTcGVlY2ggU0RLIDEuMTQuMCBvciB1cC5cbiAgICAvLyBUT0RPOiBbUDFdICMzNTc1IFJlbW92ZSB0aGUgZm9sbG93aW5nIGxpbmVzIHdoZW4gYnVtcGluZyB0byBTcGVlY2ggU0RLIDEuMTQuMCBvciBoaWdoZXJcbiAgICBzb3VyY2UuY3JlYXRlQXVkaW9Db250ZXh0ID0gKCkgPT4ge1xuICAgICAgaWYgKCEhc291cmNlLnByaXZDb250ZXh0KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0O1xuXG4gICAgICBpZiAodHlwZW9mIEF1ZGlvQ29udGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCcm93c2VyIGRvZXMgbm90IHN1cHBvcnQgV2ViIEF1ZGlvIEFQSSAoQXVkaW9Db250ZXh0L3dlYmtpdEF1ZGlvQ29udGV4dCBpcyBub3QgYXZhaWxhYmxlKS4nKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0U3VwcG9ydGVkQ29uc3RyYWludHMoKS5zYW1wbGVSYXRlKSB7XG4gICAgICAgIHNvdXJjZS5wcml2Q29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoeyBzYW1wbGVSYXRlOiBNaWNBdWRpb1NvdXJjZS5BVURJT0ZPUk1BVC5zYW1wbGVzUGVyU2VjIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc291cmNlLnByaXZDb250ZXh0ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBUaGlzIHBpZWNlIG9mIGNvZGUgaXMgYWRvcHRlZCBmcm9tIG1pY3Jvc29mdC1jb2duaXRpdmVzZXJ2aWNlcy1zcGVlY2gtc2RrL2NvbW1vbi5icm93c2VyL01pY0F1ZGlvU291cmNlLnRzLlxuICAgIC8vIEluc3RlYWQgb2YgY2xvc2luZyB0aGUgQXVkaW9Db250ZXh0LCBpdCB3aWxsIGp1c3Qgc3VzcGVuZCBpdC4gQW5kIHRoZSBuZXh0IHRpbWUgaXQgaXMgbmVlZGVkLCBpdCB3aWxsIGJlIHJlc3VtZWQgKGJ5IHRoZSBvcmlnaW5hbCBjb2RlKS5cbiAgICBzb3VyY2UuZGVzdHJveUF1ZGlvQ29udGV4dCA9ICgpID0+IHtcbiAgICAgIGlmICghc291cmNlLnByaXZDb250ZXh0KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgc291cmNlLnByaXZSZWNvcmRlci5yZWxlYXNlTWVkaWFSZXNvdXJjZXMoc291cmNlLnByaXZDb250ZXh0KTtcbiAgICAgIHNvdXJjZS5wcml2Q29udGV4dC5zdGF0ZSA9PT0gJ3J1bm5pbmcnICYmIHNvdXJjZS5wcml2Q29udGV4dC5zdXNwZW5kKCk7XG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiAoeyByZWZlcmVuY2VHcmFtbWFySUQgfSA9IHt9KSA9PiB7XG4gICAgY29uc3QgeyBTcGVlY2hHcmFtbWFyTGlzdCwgU3BlZWNoUmVjb2duaXRpb24sIHNwZWVjaFN5bnRoZXNpcywgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlIH0gPSBjcmVhdGVQb255ZmlsbCh7XG4gICAgICBhdWRpb0NvbmZpZyxcbiAgICAgIGF1ZGlvQ29udGV4dCxcbiAgICAgIGNyZWRlbnRpYWxzLFxuICAgICAgZW5hYmxlVGVsZW1ldHJ5LFxuICAgICAgcmVmZXJlbmNlR3JhbW1hcnM6IHJlZmVyZW5jZUdyYW1tYXJJRCA/IFtgbHVpcy8ke3JlZmVyZW5jZUdyYW1tYXJJRH0tUFJPRFVDVElPTmBdIDogW10sXG4gICAgICBzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQsXG4gICAgICBzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQsXG4gICAgICBzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQsXG4gICAgICB0ZXh0Tm9ybWFsaXphdGlvblxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIFNwZWVjaEdyYW1tYXJMaXN0LFxuICAgICAgU3BlZWNoUmVjb2duaXRpb24sXG4gICAgICBzcGVlY2hTeW50aGVzaXMsXG4gICAgICBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2VcbiAgICB9O1xuICB9O1xufVxuIl19